\subsection{estimator\+\_\+cw\+\_\+impl.\+cc}
\label{estimator__cw__impl_8cc_source}\index{/home/erik/prefix/default/src/gr-\/radar-\/dev/lib/estimator\+\_\+cw\+\_\+impl.\+cc@{/home/erik/prefix/default/src/gr-\/radar-\/dev/lib/estimator\+\_\+cw\+\_\+impl.\+cc}}

\begin{DoxyCode}
00001 \textcolor{comment}{/* -*- c++ -*- */}
00002 \textcolor{comment}{/* }
00003 \textcolor{comment}{ * Copyright 2014 Communications Engineering Lab, KIT.}
00004 \textcolor{comment}{ * }
00005 \textcolor{comment}{ * This is free software; you can redistribute it and/or modify}
00006 \textcolor{comment}{ * it under the terms of the GNU General Public License as published by}
00007 \textcolor{comment}{ * the Free Software Foundation; either version 3, or (at your option)}
00008 \textcolor{comment}{ * any later version.}
00009 \textcolor{comment}{ * }
00010 \textcolor{comment}{ * This software is distributed in the hope that it will be useful,}
00011 \textcolor{comment}{ * but WITHOUT ANY WARRANTY; without even the implied warranty of}
00012 \textcolor{comment}{ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the}
00013 \textcolor{comment}{ * GNU General Public License for more details.}
00014 \textcolor{comment}{ * }
00015 \textcolor{comment}{ * You should have received a copy of the GNU General Public License}
00016 \textcolor{comment}{ * along with this software; see the file COPYING.  If not, write to}
00017 \textcolor{comment}{ * the Free Software Foundation, Inc., 51 Franklin Street,}
00018 \textcolor{comment}{ * Boston, MA 02110-1301, USA.}
00019 \textcolor{comment}{ */}
00020  
00021 \textcolor{preprocessor}{#ifdef HAVE\_CONFIG\_H}
00022 \textcolor{preprocessor}{#include "config.h"}
00023 \textcolor{preprocessor}{#endif}
00024 
00025 \textcolor{preprocessor}{#include <gnuradio/io\_signature.h>}
00026 \textcolor{preprocessor}{#include "estimator_cw_impl.h"}
00027 
00028 \textcolor{keyword}{namespace }gr \{
00029   \textcolor{keyword}{namespace }radar \{
00030 
00031     estimator_cw::sptr
00032     estimator_cw::make(\textcolor{keywordtype}{float} center_freq)
00033     \{
00034       \textcolor{keywordflow}{return} gnuradio::get\_initial\_sptr
00035         (\textcolor{keyword}{new} estimator_cw_impl(center\_freq));
00036     \}
00037 
00038     \textcolor{comment}{/*}
00039 \textcolor{comment}{     * The private constructor}
00040 \textcolor{comment}{     */}
00041     estimator_cw_impl::estimator_cw_impl(\textcolor{keywordtype}{float} center_freq)
00042       : gr::block(\textcolor{stringliteral}{"estimator\_cw"},
00043               gr::io\_signature::make(0,0,0),
00044               gr::io\_signature::make(0,0,0))
00045     \{
00046         d_center_freq = center_freq;
00047         
00048         \textcolor{comment}{// Register input message port}
00049         d_port_id_in = pmt::mp(\textcolor{stringliteral}{"Msg in"});
00050         message\_port\_register\_in(d_port_id_in);
00051         set\_msg\_handler(d_port_id_in, boost::bind(&estimator_cw_impl::handle_msg, \textcolor{keyword}{this}, \_1));
00052         
00053         \textcolor{comment}{// Register output message port}
00054         d_port_id_out = pmt::mp(\textcolor{stringliteral}{"Msg out"});
00055         message\_port\_register\_out(d_port_id_out);
00056     \}
00057 
00058     \textcolor{comment}{/*}
00059 \textcolor{comment}{     * Our virtual destructor.}
00060 \textcolor{comment}{     */}
00061     estimator_cw_impl::~estimator_cw_impl()
00062     \{
00063     \}
00064 
00065     \textcolor{keywordtype}{void}
00066     estimator_cw_impl::handle_msg(pmt::pmt\_t msg)
00067     \{
00068         \textcolor{comment}{// Read msg from peak detector}
00069         pmt::pmt\_t msg\_part;
00070         \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} k=0; k<pmt::length(msg); k++)\{
00071             msg\_part = pmt::nth(k,msg);
00072             \textcolor{keywordflow}{if}(pmt::symbol\_to\_string(pmt::nth(0,msg\_part))==\textcolor{stringliteral}{"frequency"})\{
00073                 d_pfreq = pmt::nth(1,msg\_part);
00074             \}
00075             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(pmt::symbol\_to\_string(pmt::nth(0,msg\_part))==\textcolor{stringliteral}{"rx\_time"})\{
00076                 d_ptimestamp = pmt::nth(1,msg\_part);
00077             \}
00078         \}
00079         
00080         d_freq = pmt::f32vector\_elements(d_pfreq); \textcolor{comment}{// get freq vector}
00081         
00082         \textcolor{comment}{// Calc velocities and write to vector}
00083         d_vel.clear();
00084         \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} k=0; k<d_freq.size(); k++)\{
00085             d_vel.push\_back(d_freq[k]*c_light/2/d_center_freq); \textcolor{comment}{// calc with doppler formula}
00086         \}
00087         
00088         \textcolor{comment}{// Push pmt to output msg port}
00089         d_vel_key = pmt::string\_to\_symbol(\textcolor{stringliteral}{"velocity"}); \textcolor{comment}{// identifier velocity}
00090         d_vel_value = pmt::init\_f32vector(d_vel.size(), d_vel); \textcolor{comment}{// vector to pmt}
00091         d_vel_pack = pmt::list2(d_vel_key, d_vel_value); \textcolor{comment}{// make list for velocity information}
00092         
00093         d_time_key = pmt::string\_to\_symbol(\textcolor{stringliteral}{"rx\_time"}); \textcolor{comment}{// identifier timestamp}
00094         d_time_pack = pmt::list2(d_time_key, d_ptimestamp); \textcolor{comment}{// make list for timestamp (rx\_time)
       information}
00095         
00096         d_value = pmt::list2(d_time_pack, d\_vel\_pack); \textcolor{comment}{// all information to one pmt list (only velocity ->
       only 1 item list)}
00097         message\_port\_pub(d_port_id_out,d_value);
00098     \}
00099 
00100   \} \textcolor{comment}{/* namespace radar */}
00101 \} \textcolor{comment}{/* namespace gr */}
00102 
\end{DoxyCode}

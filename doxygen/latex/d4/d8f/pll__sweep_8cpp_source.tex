\subsection{pll\+\_\+sweep.\+cpp}
\label{pll__sweep_8cpp_source}\index{/home/erik/prefix/default/src/limesuite-\/dev/src/utilities/pll\+\_\+sweep.\+cpp@{/home/erik/prefix/default/src/limesuite-\/dev/src/utilities/pll\+\_\+sweep.\+cpp}}

\begin{DoxyCode}
00001 \textcolor{preprocessor}{#include "lms7_device.h"}
00002 \textcolor{preprocessor}{#include <iostream>}
00003 \textcolor{preprocessor}{#include <iomanip>}
00004 \textcolor{preprocessor}{#include <getopt.h>}
00005 \textcolor{preprocessor}{#include <string>}
00006 \textcolor{preprocessor}{#include <algorithm>}
00007 \textcolor{preprocessor}{#include <cctype>}
00008 \textcolor{preprocessor}{#include <fstream>}
00009 \textcolor{preprocessor}{#include <chrono>}
00010 \textcolor{preprocessor}{#include "FPGA_common.h"}
00011 \textcolor{preprocessor}{#include "Logger.h"}
00012 
00013 \textcolor{keyword}{using namespace }std;
00014 \textcolor{keyword}{using namespace }lime;
00015 
00016 \textcolor{keyword}{auto} t1 = chrono::high\_resolution\_clock::now();
00017 \textcolor{keyword}{auto} t2 = chrono::high\_resolution\_clock::now();
00018 
00019 \textcolor{keywordtype}{bool} ConfigureCGEN(LMS7_Device* device, \textcolor{keywordtype}{double} freqMHz);
00020 
00021 \textcolor{keywordtype}{int} printHelp(\textcolor{keywordtype}{void});
00022 
00023 \textcolor{keywordtype}{int} log_level = 3;
00024 
00025 \textcolor{keywordtype}{void} log_func(\textcolor{keyword}{const} lime::LogLevel level, \textcolor{keyword}{const} \textcolor{keywordtype}{char} *message)
00026 \{
00027     \textcolor{keywordflow}{if} (level <= log_level)
00028         std::cout << message << std::endl;
00029 \}
00030 
00031 \textcolor{keywordtype}{int} main(\textcolor{keywordtype}{int} argc, \textcolor{keywordtype}{char}** argv)
00032 \{
00033     \textcolor{keywordtype}{double} beginFreq = 50e6;
00034     \textcolor{keywordtype}{double} endFreq = 500e6;
00035     \textcolor{keywordtype}{double} stepFreq = 1e6;
00036     \textcolor{keywordtype}{string} configFilename = \textcolor{stringliteral}{""};
00037     \textcolor{keywordtype}{bool} init = \textcolor{keyword}{false};
00038     \textcolor{keywordtype}{int} deviceIndex = -1;
00039 
00040     \textcolor{keywordtype}{int} c;
00041     \textcolor{keywordflow}{while} (1)
00042     \{
00043         \textcolor{keyword}{static} \textcolor{keyword}{struct }option long\_options[] =
00044         \{
00045             \{\textcolor{stringliteral}{"beginFreq"},   required_argument, 0, \textcolor{charliteral}{'b'}\},
00046             \{\textcolor{stringliteral}{"stepFreq"},    required_argument, 0, \textcolor{charliteral}{'s'}\},
00047             \{\textcolor{stringliteral}{"endFreq"},     required_argument, 0, \textcolor{charliteral}{'e'}\},
00048             \{\textcolor{stringliteral}{"log"},         required_argument, 0, \textcolor{charliteral}{'l'}\},
00049             \{\textcolor{stringliteral}{"config"},      required_argument, 0, \textcolor{charliteral}{'c'}\},
00050             \{\textcolor{stringliteral}{"device"},      required_argument, 0, \textcolor{charliteral}{'d'}\},
00051             \{\textcolor{stringliteral}{"help"},        no_argument, 0, \textcolor{charliteral}{'h'}\},
00052             \{0, 0, 0, 0\}
00053         \};
00054         \textcolor{comment}{/* getopt\_long stores the option index here. */}
00055         \textcolor{keywordtype}{int} option\_index = 0;
00056         c = getopt_long (argc, argv, \textcolor{stringliteral}{"b:s:e:l:c::d:h"}, long\_options, &option\_index);
00057 
00058         \textcolor{keywordflow}{if} (c == -1) \textcolor{comment}{//no parameters given}
00059             \textcolor{keywordflow}{break};
00060         \textcolor{keywordflow}{switch} (c)
00061         \{
00062         \textcolor{keywordflow}{case} \textcolor{charliteral}{'b'}:\{
00063             stringstream ss;
00064             ss << optarg;
00065             ss >> beginFreq;
00066             \textcolor{keywordflow}{break};
00067         \}
00068         \textcolor{keywordflow}{case} \textcolor{charliteral}{'s'}:\{
00069             stringstream ss;
00070             ss << optarg;
00071             ss >> stepFreq;
00072             \textcolor{keywordflow}{break};
00073         \}
00074         \textcolor{keywordflow}{case} \textcolor{charliteral}{'e'}:\{
00075             stringstream ss;
00076             ss << optarg;
00077             ss >> endFreq;
00078             \textcolor{keywordflow}{break};
00079         \}
00080         \textcolor{keywordflow}{case} \textcolor{charliteral}{'l'}:\{
00081             stringstream ss;
00082             ss << optarg;
00083             ss >> log_level;
00084             \textcolor{keywordflow}{break};
00085         \}
00086         \textcolor{keywordflow}{case} \textcolor{charliteral}{'c'}:\{
00087             \textcolor{keywordflow}{if} (optarg != NULL)\{
00088                 stringstream ss;
00089                 ss << optarg;
00090                 ss >> configFilename;
00091             \}
00092             \textcolor{keywordflow}{else} init = \textcolor{keyword}{true};
00093             \textcolor{keywordflow}{break};
00094         \}
00095         \textcolor{keywordflow}{case} \textcolor{charliteral}{'d'}:\{
00096             stringstream ss;
00097             ss << optarg;
00098             ss >> deviceIndex;
00099             \textcolor{keywordflow}{break};
00100         \}
00101         \textcolor{keywordflow}{case} \textcolor{charliteral}{'h'}:
00102             printHelp();
00103             \textcolor{keywordflow}{return} 0;
00104         \textcolor{keywordflow}{case} \textcolor{charliteral}{'?'}:
00105             \textcolor{comment}{/* getopt\_long already printed an error message. */}
00106             \textcolor{keywordflow}{break};
00107         \textcolor{keywordflow}{default}:
00108             std::cout << \textcolor{stringliteral}{"Invalid option"} << std::endl;
00109             abort();
00110         \}
00111     \}
00112 
00113     cout << \textcolor{stringliteral}{"beginFreq = "} << beginFreq/1e6 << \textcolor{stringliteral}{" MHz"} << endl;
00114     cout << \textcolor{stringliteral}{"stepFreq  = "} << stepFreq/1e6 << \textcolor{stringliteral}{" MHz"} << endl;
00115     cout << \textcolor{stringliteral}{"endFreq   = "} << endFreq/1e6 << \textcolor{stringliteral}{" MHz"} << endl;
00116 
00117     LMS7_Device* device;
00118     std::vector<lime::ConnectionHandle> handles = LMS7\_Device::GetDeviceList();
00119     \textcolor{keywordflow}{if}(handles.size() == 0)
00120     \{
00121         cout << \textcolor{stringliteral}{"No devices found"} << endl;
00122         \textcolor{keywordflow}{return} -1;
00123     \}
00124     \textcolor{keywordflow}{if}(handles.size() == 1) \textcolor{comment}{//open the only available device}
00125         device = lime::LMS7_Device::CreateDevice(handles[0],\textcolor{keyword}{nullptr});
00126     \textcolor{keywordflow}{else} \textcolor{comment}{//display device selection}
00127     \{
00128         \textcolor{keywordflow}{if}(deviceIndex < 0)
00129         \{
00130             cout << \textcolor{stringliteral}{"Device list:"} << endl;
00131             \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} i = 0; i < handles.size(); i++)
00132                cout << setw(2) << i << \textcolor{stringliteral}{". "} << handles[i].name << endl;
00133             cout << \textcolor{stringliteral}{"Select device index (0-"} << handles.size()-1 << \textcolor{stringliteral}{"): "};
00134             \textcolor{keywordtype}{int} selection = 0; cin >> selection;
00135             selection = selection % handles.size();
00136             device = lime::LMS7_Device::CreateDevice(handles[selection],\textcolor{keyword}{nullptr});
00137         \}
00138         \textcolor{keywordflow}{else}
00139             device = lime::LMS7_Device::CreateDevice(handles[deviceIndex],\textcolor{keyword}{nullptr});
00140     \}
00141     \textcolor{keywordflow}{if}(device == \textcolor{keyword}{nullptr})
00142     \{
00143         cout << \textcolor{stringliteral}{"Failed to connected to device"} << endl;
00144         \textcolor{keywordflow}{return} -1;
00145     \}
00146     \textcolor{keyword}{auto} info = device->GetInfo();
00147     cout << \textcolor{stringliteral}{"\(\backslash\)nConnected to: "} << info->deviceName
00148     << \textcolor{stringliteral}{" FW: "} << info->firmwareVersion << \textcolor{stringliteral}{" HW: "} << info->hardwareVersion << endl;
00149 
00150     \textcolor{keywordflow}{if}(configFilename.length() > 0)
00151     \{
00152         \textcolor{keywordflow}{if}(device->LoadConfig(configFilename.c\_str()) != 0)
00153         \{
00154             \textcolor{keywordflow}{return} -1;
00155         \}
00156     \}
00157     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (init)
00158     \{
00159         device->Init();
00160     \}
00161 
00162     lime::registerLogHandler(log_func);
00163     \textcolor{keywordtype}{int} errors = 0;
00164     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{double} freq = beginFreq; freq < endFreq; freq += stepFreq)
00165         \textcolor{keywordflow}{if} (ConfigureCGEN(device, freq)==\textcolor{keyword}{false})
00166             errors++;
00167     cout << \textcolor{stringliteral}{"Errors: "} << errors << endl;
00168     \textcolor{keyword}{delete} device;
00169     \textcolor{keywordflow}{return} 0;
00170 \}
00171 
00172 \textcolor{keywordtype}{bool} ConfigureCGEN(LMS7_Device* device, \textcolor{keywordtype}{double} freqMHz)
00173 \{
00174     std::cout << \textcolor{stringliteral}{"Set CGEN "} << freqMHz/1e6 << \textcolor{stringliteral}{" MHz: "};
00175     LMS7002M* lms = device->GetLMS();
00176     lms->Modify_SPI_Reg_bits(LMS7param(MAC),1,\textcolor{keyword}{true});
00177     \textcolor{keywordtype}{int} interp = lms->Get_SPI_Reg_bits(LMS7param(HBI_OVR_TXTSP));
00178     \textcolor{keywordtype}{int} decim = lms->Get_SPI_Reg_bits(LMS7param(HBD_OVR_RXTSP));
00179     \textcolor{keywordflow}{if} (lms->SetInterfaceFrequency(freqMHz, interp, decim)!=0)
00180     \{
00181         std::cout << \textcolor{stringliteral}{"LMS VCO Fail"} << endl;
00182         \textcolor{keywordflow}{return} \textcolor{keyword}{false};
00183     \}
00184 
00185     \textcolor{keyword}{auto} chipInd = lms->GetActiveChannelIndex()/2;
00186     \textcolor{keyword}{auto} fpgaTxPLL = lms->GetReferenceClk_TSP(lime::LMS7002M::Tx);
00187     \textcolor{keywordflow}{if} (interp != 7)
00188         fpgaTxPLL /= pow(2.0, interp);
00189     \textcolor{keyword}{auto} fpgaRxPLL = lms->GetReferenceClk_TSP(lime::LMS7002M::Rx);
00190     \textcolor{keywordflow}{if} (decim != 7)
00191         fpgaRxPLL /= pow(2.0, decim);
00192     \textcolor{keyword}{auto} fpga = device->GetFPGA();
00193     \textcolor{keywordflow}{if} (fpga)
00194     \{
00195         \textcolor{keywordtype}{int} status = fpga->SetInterfaceFreq(fpgaTxPLL,fpgaRxPLL,chipInd);
00196         \textcolor{keywordflow}{if} (status != 0)
00197         \{
00198             std::cout << \textcolor{stringliteral}{"FPGA Fail"} << endl;
00199             \textcolor{keywordflow}{return} \textcolor{keyword}{false};
00200         \}
00201     \}
00202     std::cout << \textcolor{stringliteral}{"OK"} << endl;
00203     \textcolor{keywordflow}{return} \textcolor{keyword}{true};
00204 \}
00205 
00206 \textcolor{comment}{/***********************************************************************}
00207 \textcolor{comment}{ * print help}
00208 \textcolor{comment}{ **********************************************************************/}
00209 \textcolor{keywordtype}{int} printHelp(\textcolor{keywordtype}{void})
00210 \{
00211     std::cout << \textcolor{stringliteral}{"Usage pll\_sweep [options]"} << std::endl;
00212     std::cout << \textcolor{stringliteral}{"available options:"} << std::endl;
00213     std::cout << \textcolor{stringliteral}{"    --help \(\backslash\)t\(\backslash\)t Print this help message"} << std::endl;
00214     std::cout << \textcolor{stringliteral}{"    --beginFreq \(\backslash\)t sweep start frequency"} << std::endl;
00215     std::cout << \textcolor{stringliteral}{"    --endFreq \(\backslash\)t\(\backslash\)t sweep end frequency"} << std::endl;
00216     std::cout << \textcolor{stringliteral}{"    --stepFreq \(\backslash\)t\(\backslash\)t sweep frequency step"} << std::endl;
00217     std::cout << \textcolor{stringliteral}{"    --log \(\backslash\)t\(\backslash\)t log level"} << std::endl;
00218     std::cout << \textcolor{stringliteral}{"    --config \(\backslash\)t\(\backslash\)t load config"} << std::endl;
00219     std::cout << \textcolor{stringliteral}{"    --device \(\backslash\)t\(\backslash\)t device index"} << std::endl;
00220     std::cout << std::endl;
00221     \textcolor{keywordflow}{return} EXIT\_SUCCESS;
00222 \}
00223 
\end{DoxyCode}

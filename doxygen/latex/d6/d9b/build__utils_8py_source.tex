\subsection{build\+\_\+utils.\+py}
\label{build__utils_8py_source}\index{/home/erik/prefix/default/src/gr-\/radar-\/dev/python/build\+\_\+utils.\+py@{/home/erik/prefix/default/src/gr-\/radar-\/dev/python/build\+\_\+utils.\+py}}

\begin{DoxyCode}
00001 \textcolor{comment}{#}
00002 \textcolor{comment}{# Copyright 2004,2009,2012 Free Software Foundation, Inc.}
00003 \textcolor{comment}{#}
00004 \textcolor{comment}{# This file is part of GNU Radio}
00005 \textcolor{comment}{#}
00006 \textcolor{comment}{# GNU Radio is free software; you can redistribute it and/or modify}
00007 \textcolor{comment}{# it under the terms of the GNU General Public License as published by}
00008 \textcolor{comment}{# the Free Software Foundation; either version 3, or (at your option)}
00009 \textcolor{comment}{# any later version.}
00010 \textcolor{comment}{#}
00011 \textcolor{comment}{# GNU Radio is distributed in the hope that it will be useful,}
00012 \textcolor{comment}{# but WITHOUT ANY WARRANTY; without even the implied warranty of}
00013 \textcolor{comment}{# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the}
00014 \textcolor{comment}{# GNU General Public License for more details.}
00015 \textcolor{comment}{#}
00016 \textcolor{comment}{# You should have received a copy of the GNU General Public License}
00017 \textcolor{comment}{# along with GNU Radio; see the file COPYING.  If not, write to}
00018 \textcolor{comment}{# the Free Software Foundation, Inc., 51 Franklin Street,}
00019 \textcolor{comment}{# Boston, MA 02110-1301, USA.}
00020 \textcolor{comment}{#}
00021 
00022 \textcolor{stringliteral}{"""Misc utilities used at build time}
00023 \textcolor{stringliteral}{"""}
00024 
00025 \textcolor{keyword}{import} re, os, os.path
00026 \textcolor{keyword}{from} build\_utils\_codes \textcolor{keyword}{import} *
00027 
00028 
00029 \textcolor{comment}{# set srcdir to the directory that contains Makefile.am}
00030 \textcolor{keywordflow}{try}:
00031     srcdir = os.environ[\textcolor{stringliteral}{'srcdir'}]
00032 \textcolor{keywordflow}{except} KeyError, e:
00033     srcdir = \textcolor{stringliteral}{"."}
00034 srcdir = srcdir + \textcolor{stringliteral}{'/'}
00035 
00036 \textcolor{comment}{# set do\_makefile to either true or false dependeing on the environment}
00037 \textcolor{keywordflow}{try}:
00038     \textcolor{keywordflow}{if} os.environ[\textcolor{stringliteral}{'do\_makefile'}] == \textcolor{stringliteral}{'0'}:
00039         do\_makefile = \textcolor{keyword}{False}
00040     \textcolor{keywordflow}{else}:
00041         do\_makefile = \textcolor{keyword}{True}
00042 \textcolor{keywordflow}{except} KeyError, e:
00043     do\_makefile = \textcolor{keyword}{False}
00044 
00045 \textcolor{comment}{# set do\_sources to either true or false dependeing on the environment}
00046 \textcolor{keywordflow}{try}:
00047     \textcolor{keywordflow}{if} os.environ[\textcolor{stringliteral}{'do\_sources'}] == \textcolor{stringliteral}{'0'}:
00048         do\_sources = \textcolor{keyword}{False}
00049     \textcolor{keywordflow}{else}:
00050         do\_sources = \textcolor{keyword}{True}
00051 \textcolor{keywordflow}{except} KeyError, e:
00052     do\_sources = \textcolor{keyword}{True}
00053 
00054 name\_dict = \{\}
00055 
00056 \textcolor{keyword}{def }log_output_name (name):
00057     (base, ext) = os.path.splitext (name)
00058     ext = ext[1:]                       \textcolor{comment}{# drop the leading '.'}
00059 
00060     entry = name\_dict.setdefault (ext, [])
00061     entry.append (name)
00062 
00063 \textcolor{keyword}{def }open_and_log_name (name, dir):
00064     \textcolor{keyword}{global} do\_sources
00065     \textcolor{keywordflow}{if} do\_sources:
00066         f = open (name, dir)
00067     \textcolor{keywordflow}{else}:
00068         f = \textcolor{keywordtype}{None}
00069     log\_output\_name (name)
00070     \textcolor{keywordflow}{return} f
00071 
00072 \textcolor{keyword}{def }expand_template (d, template\_filename, extra = ""):
00073     \textcolor{stringliteral}{'''Given a dictionary D and a TEMPLATE\_FILENAME, expand template into output file}
00074 \textcolor{stringliteral}{    '''}
00075     \textcolor{keyword}{global} do\_sources
00076     output\_extension = extract\_extension (template\_filename)
00077     template = open\_src (template\_filename, \textcolor{stringliteral}{'r')}
00078 \textcolor{stringliteral}{    output\_name = d['NAME'}] + extra + \textcolor{stringliteral}{'.'} + output\_extension
00079     log\_output\_name (output\_name)
00080     \textcolor{keywordflow}{if} do\_sources:
00081         output = open (output\_name, \textcolor{stringliteral}{'w'})
00082         do\_substitution (d, template, output)
00083         output.close ()
00084     template.close ()
00085 
00086 \textcolor{keyword}{def }output_glue (dirname):
00087     output\_makefile\_fragment ()
00088     output\_ifile\_include (dirname)
00089 
00090 \textcolor{keyword}{def }output_makefile_fragment ():
00091     \textcolor{keyword}{global} do\_makefile
00092     \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} do\_makefile:
00093         \textcolor{keywordflow}{return}
00094 \textcolor{comment}{# overwrite the source, which must be writable; this should have been}
00095 \textcolor{comment}{# checked for beforehand in the top-level Makefile.gen.gen .}
00096     f = open (os.path.join (os.environ.get(\textcolor{stringliteral}{'gendir'}, os.environ.get(\textcolor{stringliteral}{'srcdir'}, \textcolor{stringliteral}{'.'})), \textcolor{stringliteral}{'Makefile.gen'}), \textcolor{stringliteral}{'w'})
00097     f.write (\textcolor{stringliteral}{'#\(\backslash\)n# This file is machine generated.  All edits will be overwritten\(\backslash\)n#\(\backslash\)n'})
00098     output\_subfrag (f, \textcolor{stringliteral}{'h'})
00099     output\_subfrag (f, \textcolor{stringliteral}{'i'})
00100     output\_subfrag (f, \textcolor{stringliteral}{'cc'})
00101     f.close ()
00102 
00103 \textcolor{keyword}{def }output_ifile_include (dirname):
00104     \textcolor{keyword}{global} do\_sources
00105     \textcolor{keywordflow}{if} do\_sources:
00106         f = open (\textcolor{stringliteral}{'%s\_generated.i'} % (dirname,), \textcolor{stringliteral}{'w'})
00107         f.write (\textcolor{stringliteral}{'//\(\backslash\)n// This file is machine generated.  All edits will be overwritten\(\backslash\)n//\(\backslash\)n'})
00108         files = name\_dict.setdefault (\textcolor{stringliteral}{'i'}, [])
00109         files.sort ()
00110         f.write (\textcolor{stringliteral}{'%\{\(\backslash\)n'})
00111         \textcolor{keywordflow}{for} file \textcolor{keywordflow}{in} files:
00112             f.write (\textcolor{stringliteral}{'#include <%s>\(\backslash\)n'} % (file[0:-1] + \textcolor{stringliteral}{'h'},))
00113         f.write (\textcolor{stringliteral}{'%\}\(\backslash\)n\(\backslash\)n'})
00114         \textcolor{keywordflow}{for} file \textcolor{keywordflow}{in} files:
00115             f.write (\textcolor{stringliteral}{'%%include <%s>\(\backslash\)n'} % (file,))
00116 
00117 \textcolor{keyword}{def }output_subfrag (f, ext):
00118     files = name\_dict.setdefault (ext, [])
00119     files.sort ()
00120     f.write (\textcolor{stringliteral}{"GENERATED\_%s ="} % (ext.upper ()))
00121     \textcolor{keywordflow}{for} file \textcolor{keywordflow}{in} files:
00122         f.write (\textcolor{stringliteral}{" \(\backslash\)\(\backslash\)\(\backslash\)n\(\backslash\)t%s"} % (file,))
00123     f.write (\textcolor{stringliteral}{"\(\backslash\)n\(\backslash\)n"})
00124 
00125 \textcolor{keyword}{def }extract_extension (template\_name):
00126     \textcolor{comment}{# template name is something like: GrFIRfilterXXX.h.t}
00127     \textcolor{comment}{# we return everything between the penultimate . and .t}
00128     mo = re.search (\textcolor{stringliteral}{r'\(\backslash\).([a-z]+)\(\backslash\).t$'}, template\_name)
00129     \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} mo:
00130         \textcolor{keywordflow}{raise} ValueError, \textcolor{stringliteral}{"Incorrectly formed template\_name '%s'"} % (template\_name,)
00131     \textcolor{keywordflow}{return} mo.group (1)
00132 
00133 \textcolor{keyword}{def }open_src (name, mode):
00134     \textcolor{keyword}{global} srcdir
00135     \textcolor{keywordflow}{return} open (os.path.join (srcdir, name), mode)
00136 
00137 \textcolor{keyword}{def }do_substitution (d, in\_file, out\_file):
00138     \textcolor{keyword}{def }repl (match\_obj):
00139         key = match\_obj.group (1)
00140         \textcolor{comment}{# print key}
00141         \textcolor{keywordflow}{return} d[key]
00142 
00143     inp = in\_file.read ()
00144     out = re.sub (\textcolor{stringliteral}{r"@([a-zA-Z0-9\_]+)@"}, repl, inp)
00145     out\_file.write (out)
00146 
00147 
00148 
00149 copyright = \textcolor{stringliteral}{'''/* -*- c++ -*- */}
00150 \textcolor{stringliteral}{/*}
00151 \textcolor{stringliteral}{ * Copyright 2003,2004 Free Software Foundation, Inc.}
00152 \textcolor{stringliteral}{ *}
00153 \textcolor{stringliteral}{ * This file is part of GNU Radio}
00154 \textcolor{stringliteral}{ *}
00155 \textcolor{stringliteral}{ * GNU Radio is free software; you can redistribute it and/or modify}
00156 \textcolor{stringliteral}{ * it under the terms of the GNU General Public License as published by}
00157 \textcolor{stringliteral}{ * the Free Software Foundation; either version 3, or (at your option)}
00158 \textcolor{stringliteral}{ * any later version.}
00159 \textcolor{stringliteral}{ *}
00160 \textcolor{stringliteral}{ * GNU Radio is distributed in the hope that it will be useful,}
00161 \textcolor{stringliteral}{ * but WITHOUT ANY WARRANTY; without even the implied warranty of}
00162 \textcolor{stringliteral}{ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the}
00163 \textcolor{stringliteral}{ * GNU General Public License for more details.}
00164 \textcolor{stringliteral}{ *}
00165 \textcolor{stringliteral}{ * You should have received a copy of the GNU General Public License}
00166 \textcolor{stringliteral}{ * along with GNU Radio; see the file COPYING.  If not, write to}
00167 \textcolor{stringliteral}{ * the Free Software Foundation, Inc., 51 Franklin Street,}
00168 \textcolor{stringliteral}{ * Boston, MA 02110-1301, USA.}
00169 \textcolor{stringliteral}{ */}
00170 \textcolor{stringliteral}{'''}
00171 
00172 \textcolor{keyword}{def }is_complex (code3):
00173     \textcolor{keywordflow}{if} i\_code (code3) == \textcolor{stringliteral}{'c'} \textcolor{keywordflow}{or} o\_code (code3) == \textcolor{stringliteral}{'c'}:
00174         \textcolor{keywordflow}{return} \textcolor{stringliteral}{'1'}
00175     \textcolor{keywordflow}{else}:
00176         \textcolor{keywordflow}{return} \textcolor{stringliteral}{'0'}
00177 
00178 
00179 \textcolor{keyword}{def }standard_dict (name, code3, package='gr'):
00180     d = \{\}
00181     d[\textcolor{stringliteral}{'NAME'}] = name
00182     d[\textcolor{stringliteral}{'NAME\_IMPL'}] = name+\textcolor{stringliteral}{'\_impl'}
00183     d[\textcolor{stringliteral}{'GUARD\_NAME'}] = \textcolor{stringliteral}{'INCLUDED\_%s\_%s\_H'} % (package.upper(), name.upper())
00184     d[\textcolor{stringliteral}{'GUARD\_NAME\_IMPL'}] = \textcolor{stringliteral}{'INCLUDED\_%s\_%s\_IMPL\_H'} % (package.upper(), name.upper())
00185     d[\textcolor{stringliteral}{'BASE\_NAME'}] = re.sub (\textcolor{stringliteral}{'^'} + package + \textcolor{stringliteral}{'\_'}, \textcolor{stringliteral}{''}, name)
00186     d[\textcolor{stringliteral}{'SPTR\_NAME'}] = \textcolor{stringliteral}{'%s\_sptr'} % name
00187     d[\textcolor{stringliteral}{'WARNING'}] = \textcolor{stringliteral}{'WARNING: this file is machine generated. Edits will be overwritten'}
00188     d[\textcolor{stringliteral}{'COPYRIGHT'}] = copyright
00189     d[\textcolor{stringliteral}{'TYPE'}] = i\_type (code3)
00190     d[\textcolor{stringliteral}{'I\_TYPE'}] = i\_type (code3)
00191     d[\textcolor{stringliteral}{'O\_TYPE'}] = o\_type (code3)
00192     d[\textcolor{stringliteral}{'TAP\_TYPE'}] = tap\_type (code3)
00193     d[\textcolor{stringliteral}{'IS\_COMPLEX'}] = is\_complex (code3)
00194     \textcolor{keywordflow}{return} d
00195 
00196 
00197 \textcolor{keyword}{def }standard_dict2 (name, code3, package):
00198     d = \{\}
00199     d[\textcolor{stringliteral}{'NAME'}] = name
00200     d[\textcolor{stringliteral}{'BASE\_NAME'}] = name
00201     d[\textcolor{stringliteral}{'GUARD\_NAME'}] = \textcolor{stringliteral}{'INCLUDED\_%s\_%s\_H'} % (package.upper(), name.upper())
00202     d[\textcolor{stringliteral}{'WARNING'}] = \textcolor{stringliteral}{'WARNING: this file is machine generated. Edits will be overwritten'}
00203     d[\textcolor{stringliteral}{'COPYRIGHT'}] = copyright
00204     d[\textcolor{stringliteral}{'TYPE'}] = i\_type (code3)
00205     d[\textcolor{stringliteral}{'I\_TYPE'}] = i\_type (code3)
00206     d[\textcolor{stringliteral}{'O\_TYPE'}] = o\_type (code3)
00207     d[\textcolor{stringliteral}{'TAP\_TYPE'}] = tap\_type (code3)
00208     d[\textcolor{stringliteral}{'IS\_COMPLEX'}] = is\_complex (code3)
00209     \textcolor{keywordflow}{return} d
00210 
00211 \textcolor{keyword}{def }standard_impl_dict2 (name, code3, package):
00212     d = \{\}
00213     d[\textcolor{stringliteral}{'NAME'}] = name
00214     d[\textcolor{stringliteral}{'IMPL\_NAME'}] = name
00215     d[\textcolor{stringliteral}{'BASE\_NAME'}] = name.rstrip(\textcolor{stringliteral}{"impl"}).rstrip(\textcolor{stringliteral}{"\_"})
00216     d[\textcolor{stringliteral}{'GUARD\_NAME'}] = \textcolor{stringliteral}{'INCLUDED\_%s\_%s\_H'} % (package.upper(), name.upper())
00217     d[\textcolor{stringliteral}{'WARNING'}] = \textcolor{stringliteral}{'WARNING: this file is machine generated. Edits will be overwritten'}
00218     d[\textcolor{stringliteral}{'COPYRIGHT'}] = copyright
00219     d[\textcolor{stringliteral}{'FIR\_TYPE'}] = \textcolor{stringliteral}{"fir\_filter\_"} + code3
00220     d[\textcolor{stringliteral}{'CFIR\_TYPE'}] = \textcolor{stringliteral}{"fir\_filter\_"} + code3[0:2] + \textcolor{stringliteral}{'c'}
00221     d[\textcolor{stringliteral}{'TYPE'}] = i\_type (code3)
00222     d[\textcolor{stringliteral}{'I\_TYPE'}] = i\_type (code3)
00223     d[\textcolor{stringliteral}{'O\_TYPE'}] = o\_type (code3)
00224     d[\textcolor{stringliteral}{'TAP\_TYPE'}] = tap\_type (code3)
00225     d[\textcolor{stringliteral}{'IS\_COMPLEX'}] = is\_complex (code3)
00226     \textcolor{keywordflow}{return} d
\end{DoxyCode}

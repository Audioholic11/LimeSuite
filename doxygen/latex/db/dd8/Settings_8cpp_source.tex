\subsection{Settings.\+cpp}
\label{Settings_8cpp_source}\index{/home/erik/prefix/default/src/limesuite-\/dev/\+Soapy\+L\+M\+S7/\+Settings.\+cpp@{/home/erik/prefix/default/src/limesuite-\/dev/\+Soapy\+L\+M\+S7/\+Settings.\+cpp}}

\begin{DoxyCode}
00001 
00007 \textcolor{preprocessor}{#include "SoapyLMS7.h"}
00008 \textcolor{preprocessor}{#include "Logger.h"}
00009 \textcolor{preprocessor}{#include "lms7_device.h"}
00010 \textcolor{preprocessor}{#include <IConnection.h>}
00011 \textcolor{preprocessor}{#include <stdexcept>}
00012 \textcolor{preprocessor}{#include <iostream>}
00013 \textcolor{preprocessor}{#include <memory>}
00014 \textcolor{preprocessor}{#include <SoapySDR/Logger.hpp>}
00015 \textcolor{preprocessor}{#include <SoapySDR/Time.hpp>}
00016 \textcolor{preprocessor}{#include <cstdlib>}
00017 \textcolor{preprocessor}{#include <algorithm>}
00018 
00019 \textcolor{keyword}{using namespace }lime;
00020 
00021 \textcolor{preprocessor}{#define dirName ((direction == SOAPY\_SDR\_RX)?"Rx":"Tx")}
00022 
00023 \textcolor{comment}{// arbitrary upper limit for CGEN automatic tune}
00024 \textcolor{preprocessor}{#define MIN\_CGEN\_RATE 4e6}
00025 \textcolor{preprocessor}{#define MAX\_CGEN\_RATE 640e6}
00026 
00027 \textcolor{comment}{//reasonable limits when advertising the rate}
00028 \textcolor{preprocessor}{#define MIN\_SAMP\_RATE 1e5}
00029 \textcolor{preprocessor}{#define MAX\_SAMP\_RATE 65e6}
00030 
00031 \textcolor{comment}{/*******************************************************************}
00032 \textcolor{comment}{ * Constructor/destructor}
00033 \textcolor{comment}{ ******************************************************************/}
00034 SoapyLMS7::SoapyLMS7(\textcolor{keyword}{const} ConnectionHandle &handle, \textcolor{keyword}{const} SoapySDR::Kwargs &
      args):
00035     \_deviceArgs(args),
00036     \_moduleName(handle.module),
00037     sampleRate(0.0)
00038 \{
00039     \textcolor{comment}{//connect}
00040     SoapySDR::logf(SOAPY_SDR_INFO, \textcolor{stringliteral}{"Make connection: '%s'"}, handle.ToString().c\_str());
00041 
00042     lms7Device = LMS7\_Device::CreateDevice(handle);
00043     \textcolor{keywordflow}{if} (lms7Device == \textcolor{keyword}{nullptr}) \textcolor{keywordflow}{throw} std::runtime\_error(
00044         \textcolor{stringliteral}{"Failed to make connection with '"} + handle.serialize() + \textcolor{stringliteral}{"'"});
00045 
00046     \textcolor{keyword}{const} \textcolor{keyword}{auto} devInfo = lms7Device->GetInfo();
00047     \textcolor{comment}{//quick summary}
00048     SoapySDR::logf(SOAPY_SDR_INFO, \textcolor{stringliteral}{"Device name: %s"}, devInfo->deviceName);
00049     SoapySDR::logf(SOAPY_SDR_INFO, \textcolor{stringliteral}{"Reference: %g MHz"}, lms7Device->GetClockFreq(
      LMS_CLOCK_REF)/1e6);
00050 
00051     lms7Device->Init();
00052 
00053     \textcolor{comment}{//enable all channels}
00054     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} channel = 0; channel < lms7Device->GetNumChannels(); channel++)
00055     \{
00056         lms7Device->EnableChannel(\textcolor{keyword}{true}, channel, \textcolor{keyword}{true});
00057         lms7Device->EnableChannel(\textcolor{keyword}{false}, channel, \textcolor{keyword}{true});
00058     \}
00059 
00060     \textcolor{comment}{//enable use of calibration value cache automatically}
00061     \textcolor{comment}{//or specify args[cacheCalibrations] == 0 to disable}
00062     \textcolor{keyword}{const} \textcolor{keywordtype}{bool} cacheEnable = args.count(\textcolor{stringliteral}{"cacheCalibrations"}) and std::stoi(args.at(\textcolor{stringliteral}{"cacheCalibrations"})) !=
       0;
00063     SoapySDR::logf(SOAPY_SDR_INFO, \textcolor{stringliteral}{"LMS7002M calibration values caching %s"}, cacheEnable?\textcolor{stringliteral}{"Enable"}:\textcolor{stringliteral}{"Disable"}
      );
00064     lms7Device->EnableCalibCache(cacheEnable);
00065 
00066     \textcolor{comment}{//give all RFICs a default state}
00067     \textcolor{keywordtype}{double} defaultClockRate = DEFAULT_CLOCK_RATE;
00068     \textcolor{keywordflow}{if} (args.count(\textcolor{stringliteral}{"clock"})) defaultClockRate = std::stod(args.at(\textcolor{stringliteral}{"clock"}));
00069     this->setMasterClockRate(defaultClockRate);
00070     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} channel = 0; channel < lms7Device->GetNumChannels(); channel++)
00071     \{
00072         this->setGain(SOAPY_SDR_RX, channel, \textcolor{stringliteral}{"LNA"}, 0);
00073         this->setGain(SOAPY_SDR_TX, channel, \textcolor{stringliteral}{"PAD"}, 0);
00074         _actualBw[SOAPY_SDR_RX][channel] = 30e6;
00075         _actualBw[SOAPY_SDR_TX][channel] = 60e6;
00076     \}
00077 
00078     _channelsToCal.clear();
00079 \}
00080 
00081 SoapyLMS7::~SoapyLMS7(\textcolor{keywordtype}{void})
00082 \{
00083     \textcolor{comment}{//power down all channels}
00084     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} channel = 0; channel < lms7Device->GetNumChannels(); channel++)
00085     \{
00086         lms7Device->EnableChannel(\textcolor{keyword}{true}, channel, \textcolor{keyword}{false});
00087         lms7Device->EnableChannel(\textcolor{keyword}{false}, channel, \textcolor{keyword}{false});
00088     \}
00089     \textcolor{keyword}{delete} lms7Device;
00090 \}
00091 
00092 \textcolor{comment}{/*******************************************************************}
00093 \textcolor{comment}{ * Identification API}
00094 \textcolor{comment}{ ******************************************************************/}
00095 std::string SoapyLMS7::getDriverKey(\textcolor{keywordtype}{void})\textcolor{keyword}{ const}
00096 \textcolor{keyword}{}\{
00097     \textcolor{keywordflow}{return} _moduleName;
00098 \}
00099 
00100 std::string SoapyLMS7::getHardwareKey(\textcolor{keywordtype}{void})\textcolor{keyword}{ const}
00101 \textcolor{keyword}{}\{
00102     \textcolor{keywordflow}{return} std::string(lms7Device->GetInfo()->deviceName);
00103 \}
00104 
00105 SoapySDR::Kwargs SoapyLMS7::getHardwareInfo(\textcolor{keywordtype}{void})\textcolor{keyword}{ const}
00106 \textcolor{keyword}{}\{
00107     \textcolor{keyword}{auto} devinfo = lms7Device->GetInfo();
00108     SoapySDR::Kwargs info;
00109     \textcolor{keywordflow}{if} (std::string(devinfo->expansionName) != \textcolor{stringliteral}{"UNSUPPORTED"})
00110         info[\textcolor{stringliteral}{"expansionName"}] = std::string(devinfo->expansionName);
00111     info[\textcolor{stringliteral}{"firmwareVersion"}] = std::string(devinfo->firmwareVersion);
00112     info[\textcolor{stringliteral}{"hardwareVersion"}] = std::string(devinfo->hardwareVersion);
00113     info[\textcolor{stringliteral}{"protocolVersion"}] = std::string(devinfo->protocolVersion);
00114     info[\textcolor{stringliteral}{"gatewareVersion"}] = std::string(devinfo->gatewareVersion);
00115     \textcolor{keywordflow}{if} (devinfo->boardSerialNumber!= \textcolor{keywordtype}{unsigned}(-1))
00116     \{
00117         \textcolor{keywordtype}{char} buff[64]; sprintf(buff, \textcolor{stringliteral}{"0x%lx"}, devinfo->boardSerialNumber);
00118         info[\textcolor{stringliteral}{"boardSerialNumber"}] = buff;
00119     \}
00120     \textcolor{keywordflow}{return} info;
00121 \}
00122 
00123 \textcolor{comment}{/*******************************************************************}
00124 \textcolor{comment}{ * Channels API}
00125 \textcolor{comment}{ ******************************************************************/}
00126 
00127 \textcolor{keywordtype}{size\_t} SoapyLMS7::getNumChannels(\textcolor{keyword}{const} \textcolor{keywordtype}{int} \textcolor{comment}{/*direction*/})\textcolor{keyword}{ const}
00128 \textcolor{keyword}{}\{
00129     \textcolor{keywordflow}{return} lms7Device->GetNumChannels();
00130 \}
00131 
00132 \textcolor{keywordtype}{bool} SoapyLMS7::getFullDuplex(\textcolor{keyword}{const} \textcolor{keywordtype}{int} \textcolor{comment}{/*direction*/}, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} \textcolor{comment}{/*channel*/})\textcolor{keyword}{ const}
00133 \textcolor{keyword}{}\{
00134     \textcolor{keywordflow}{return} \textcolor{keyword}{true};
00135 \}
00136 
00137 \textcolor{comment}{/*******************************************************************}
00138 \textcolor{comment}{ * Antenna API}
00139 \textcolor{comment}{ ******************************************************************/}
00140 
00141 std::vector<std::string> SoapyLMS7::listAntennas(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} \textcolor{comment}{/*channel*/})\textcolor{keyword}{ const}
00142 \textcolor{keyword}{}\{
00143     \textcolor{keywordflow}{return} lms7Device->GetPathNames(direction == SOAPY_SDR_TX);
00144 \}
00145 
00146 \textcolor{keywordtype}{void} SoapyLMS7::setAntenna(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel, \textcolor{keyword}{const} 
      std::string &name)
00147 \{
00148     std::unique\_lock<std::recursive\_mutex> lock(_accessMutex);
00149 
00150     SoapySDR::logf(SOAPY_SDR_DEBUG, \textcolor{stringliteral}{"SoapyLMS7::setAntenna(%s, %d, %s)"}, dirName, \textcolor{keywordtype}{int}(channel), name.c\_str(
      ));
00151 
00152     \textcolor{keywordtype}{bool} tx = direction == SOAPY_SDR_TX;
00153     std::vector<std::string> nameList = lms7Device->GetPathNames(tx);
00154     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} path = 0; path < nameList.size(); path++)
00155         \textcolor{keywordflow}{if} (nameList[path] == name)
00156         \{
00157             lms7Device->SetPath(tx, channel, path);
00158             _channelsToCal.emplace(direction, channel);
00159             \textcolor{keywordflow}{return};
00160         \}
00161 
00162     \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"SoapyLMS7::setAntenna(TX, "}+name+\textcolor{stringliteral}{") - unknown antenna name"});
00163 \}
00164 
00165 std::string SoapyLMS7::getAntenna(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel)\textcolor{keyword}{ const}
00166 \textcolor{keyword}{}\{
00167     std::unique\_lock<std::recursive\_mutex> lock(_accessMutex);
00168     \textcolor{keywordtype}{bool} tx = direction == SOAPY_SDR_TX;
00169     \textcolor{keywordtype}{int} path = lms7Device->GetPath(tx,channel);
00170     \textcolor{keywordflow}{if} (path < 0)
00171         \textcolor{keywordflow}{return} \textcolor{stringliteral}{""};
00172 
00173     std::vector<std::string> nameList = lms7Device->GetPathNames(tx);
00174     \textcolor{keywordflow}{return} (\textcolor{keywordtype}{unsigned})path < nameList.size() ? nameList[path] : \textcolor{stringliteral}{""};
00175 \}
00176 
00177 \textcolor{comment}{/*******************************************************************}
00178 \textcolor{comment}{ * Frontend corrections API}
00179 \textcolor{comment}{ ******************************************************************/}
00180 
00181 \textcolor{keywordtype}{bool} SoapyLMS7::hasDCOffsetMode(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} \textcolor{comment}{/*channel*/})\textcolor{keyword}{ const}
00182 \textcolor{keyword}{}\{
00183     \textcolor{keywordflow}{return} (direction == SOAPY_SDR_RX);
00184 \}
00185 
00186 \textcolor{keywordtype}{void} SoapyLMS7::setDCOffsetMode(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel, \textcolor{keyword}{const} \textcolor{keywordtype}{bool} automatic)
00187 \{
00188     std::unique\_lock<std::recursive\_mutex> lock(_accessMutex);
00189     \textcolor{keywordflow}{if} (direction == SOAPY_SDR_RX)
00190         lms7Device->WriteParam(LMS7param(DC_BYP_RXTSP),automatic == 0, channel);
00191 \}
00192 
00193 \textcolor{keywordtype}{bool} SoapyLMS7::getDCOffsetMode(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel)\textcolor{keyword}{ const}
00194 \textcolor{keyword}{}\{
00195     std::unique\_lock<std::recursive\_mutex> lock(_accessMutex);
00196     \textcolor{keywordflow}{if} (direction == SOAPY_SDR_RX)
00197         \textcolor{keywordflow}{return} lms7Device->ReadParam(LMS7param(DC_BYP_RXTSP),channel) == 0;
00198     \textcolor{keywordflow}{return} \textcolor{keyword}{false};
00199 \}
00200 
00201 \textcolor{keywordtype}{bool} SoapyLMS7::hasDCOffset(\textcolor{keyword}{const} \textcolor{keywordtype}{int} \textcolor{comment}{/*direction*/}, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} \textcolor{comment}{/*channel*/})\textcolor{keyword}{ const}
00202 \textcolor{keyword}{}\{
00203     \textcolor{keywordflow}{return} \textcolor{keyword}{false};
00204 \}
00205 
00206 \textcolor{keywordtype}{bool} SoapyLMS7::hasIQBalance(\textcolor{keyword}{const} \textcolor{keywordtype}{int} \textcolor{comment}{/*direction*/}, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} \textcolor{comment}{/*channel*/})\textcolor{keyword}{ const}
00207 \textcolor{keyword}{}\{
00208     \textcolor{keywordflow}{return} \textcolor{keyword}{false};
00209 \}
00210 
00211 \textcolor{comment}{/*******************************************************************}
00212 \textcolor{comment}{ * Gain API}
00213 \textcolor{comment}{ ******************************************************************/}
00214 
00215 std::vector<std::string> SoapyLMS7::listGains(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} \textcolor{comment}{/*channel*/})\textcolor{keyword}{ const}
00216 \textcolor{keyword}{}\{
00217     std::vector<std::string> gains;
00218     \textcolor{keywordflow}{if} (direction == SOAPY_SDR_RX)
00219     \{
00220         gains.push\_back(\textcolor{stringliteral}{"TIA"});
00221         gains.push\_back(\textcolor{stringliteral}{"LNA"});
00222         gains.push\_back(\textcolor{stringliteral}{"PGA"});
00223     \}
00224     \textcolor{keywordflow}{if} (direction == SOAPY_SDR_TX)
00225     \{
00226         gains.push\_back(\textcolor{stringliteral}{"PAD"});
00227         gains.push\_back(\textcolor{stringliteral}{"IAMP"});
00228     \}
00229     \textcolor{keywordflow}{return} gains;
00230 \}
00231 
00232 \textcolor{keywordtype}{void} SoapyLMS7::setGain(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel, \textcolor{keyword}{const} \textcolor{keywordtype}{double} value)
00233 \{
00234     std::unique\_lock<std::recursive\_mutex> lock(_accessMutex);
00235     SoapySDR::logf(SOAPY_SDR_DEBUG, \textcolor{stringliteral}{"SoapyLMS7::setGain(%s, %d, %g dB)"}, dirName, \textcolor{keywordtype}{int}(channel), value);
00236     lms7Device->SetGain(direction==SOAPY_SDR_TX,channel,value);
00237     SoapySDR::logf(SOAPY_SDR_DEBUG, \textcolor{stringliteral}{"Actual %s[%d] gain %g dB"}, dirName, \textcolor{keywordtype}{int}(channel), this->
      getGain(direction, channel));
00238 \}
00239 
00240 \textcolor{keywordtype}{double} SoapyLMS7::getGain(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel)\textcolor{keyword}{ const}
00241 \textcolor{keyword}{}\{
00242     \textcolor{keywordflow}{return} lms7Device->GetGain(direction==SOAPY_SDR_TX, channel);
00243 \}
00244 
00245 \textcolor{keywordtype}{void} SoapyLMS7::setGain(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel, \textcolor{keyword}{const} 
      std::string &name, \textcolor{keyword}{const} \textcolor{keywordtype}{double} value)
00246 \{
00247     std::unique\_lock<std::recursive\_mutex> lock(_accessMutex);
00248     SoapySDR::logf(SOAPY_SDR_DEBUG, \textcolor{stringliteral}{"SoapyLMS7::setGain(%s, %d, %s, %g dB)"}, 
      dirName, \textcolor{keywordtype}{int}(channel), name.c\_str(), value);
00249 
00250     lms7Device->SetGain(direction==SOAPY_SDR_TX, channel, value, name);
00251 
00252     SoapySDR::logf(SOAPY_SDR_DEBUG, \textcolor{stringliteral}{"Actual %s%s[%d] gain %g dB"}, dirName, name.c\_str(), 
      int(channel), this->getGain(direction, channel, name));
00253 \}
00254 
00255 \textcolor{keywordtype}{double} SoapyLMS7::getGain(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel, \textcolor{keyword}{const} 
      std::string &name)\textcolor{keyword}{ const}
00256 \textcolor{keyword}{}\{
00257     std::unique\_lock<std::recursive\_mutex> lock(_accessMutex);
00258 
00259     \textcolor{keywordflow}{return} lms7Device->GetGain(direction==SOAPY_SDR_TX, channel, name);
00260 \}
00261 
00262 SoapySDR::Range SoapyLMS7::getGainRange(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel)\textcolor{keyword}{ const}
00263 \textcolor{keyword}{}\{
00264     \textcolor{keyword}{auto} range = lms7Device->GetGainRange(direction==SOAPY_SDR_TX, channel);
00265     \textcolor{keywordflow}{return} SoapySDR::Range(range.min, range.max);
00266 \}
00267 
00268 SoapySDR::Range SoapyLMS7::getGainRange(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel, \textcolor{keyword}{const} 
      std::string &name)\textcolor{keyword}{ const}
00269 \textcolor{keyword}{}\{
00270     \textcolor{keyword}{auto} range = lms7Device->GetGainRange(direction==SOAPY_SDR_TX, channel, name);
00271     \textcolor{keywordflow}{return} SoapySDR::Range(range.min, range.max);
00272 \}
00273 
00274 \textcolor{comment}{/*******************************************************************}
00275 \textcolor{comment}{ * Frequency API}
00276 \textcolor{comment}{ ******************************************************************/}
00277 SoapySDR::ArgInfoList SoapyLMS7::getFrequencyArgsInfo(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel)\textcolor{keyword}{ const}
00278 \textcolor{keyword}{}\{
00279     \textcolor{keywordflow}{return} SoapySDR::Device::getFrequencyArgsInfo(direction, channel);
00280 \}
00281 
00282 \textcolor{keywordtype}{void} SoapyLMS7::setFrequency(\textcolor{keywordtype}{int} direction, \textcolor{keywordtype}{size\_t} channel, \textcolor{keywordtype}{double} frequency, \textcolor{keyword}{const} 
      SoapySDR::Kwargs &args)
00283 \{
00284     std::unique\_lock<std::recursive\_mutex> lock(_accessMutex);
00285     lms7Device->SetFrequency(direction == SOAPY_SDR_TX, channel, frequency);
00286 \}
00287 
00288 \textcolor{keywordtype}{void} SoapyLMS7::setFrequency(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel, \textcolor{keyword}{const} 
      std::string &name, \textcolor{keyword}{const} \textcolor{keywordtype}{double} frequency, \textcolor{keyword}{const} SoapySDR::Kwargs &args)
00289 \{
00290     std::unique\_lock<std::recursive\_mutex> lock(_accessMutex);
00291     SoapySDR::logf(SOAPY_SDR_DEBUG, \textcolor{stringliteral}{"SoapyLMS7::setFrequency(%s, %d, %s, %g MHz)"}, 
      dirName, \textcolor{keywordtype}{int}(channel), name.c\_str(), frequency/1e6);
00292     \textcolor{keywordtype}{bool} isTx = direction == SOAPY_SDR_TX;
00293     \textcolor{keywordflow}{if} (name == \textcolor{stringliteral}{"RF"})
00294     \{
00295         \textcolor{keyword}{const} \textcolor{keyword}{auto} clkId = (direction == SOAPY_SDR_TX)? LMS_CLOCK_SXT : 
      LMS_CLOCK_SXR;
00296         lms7Device->SetClockFreq(clkId, frequency, channel);
00297         _channelsToCal.emplace(direction, channel);
00298         \textcolor{keywordflow}{return};
00299     \}
00300 
00301     \textcolor{keywordflow}{if} (name == \textcolor{stringliteral}{"BB"})
00302     \{
00303         lms7Device->SetNCOFreq(isTx, channel, 0, direction == SOAPY_SDR_TX ? 
      frequency : -frequency);
00304         \textcolor{keywordflow}{return};
00305     \}
00306 
00307     \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"SoapyLMS7::setFrequency("}+name+\textcolor{stringliteral}{") unknown name"});
00308 \}
00309 
00310 \textcolor{keywordtype}{double} SoapyLMS7::getFrequency(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel, \textcolor{keyword}{const} 
      std::string &name)\textcolor{keyword}{ const}
00311 \textcolor{keyword}{}\{
00312     std::unique\_lock<std::recursive\_mutex> lock(_accessMutex);
00313 
00314     \textcolor{keywordflow}{if} (name == \textcolor{stringliteral}{"RF"})
00315     \{
00316         \textcolor{keyword}{const} \textcolor{keyword}{auto} clkId = (direction == SOAPY_SDR_TX)? LMS_CLOCK_SXT : 
      LMS_CLOCK_SXR;
00317         \textcolor{keywordflow}{return} lms7Device->GetClockFreq(clkId,channel);
00318     \}
00319 
00320     \textcolor{keywordflow}{if} (name == \textcolor{stringliteral}{"BB"})
00321     \{
00322         \textcolor{keyword}{const} \textcolor{keywordtype}{bool} isTx = (direction == SOAPY_SDR_TX);
00323         \textcolor{keywordtype}{double} freq = lms7Device->GetNCOFreq(isTx, channel, 0);
00324         \textcolor{keywordflow}{return} isTx ? freq : -freq;
00325     \}
00326 
00327     \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"SoapyLMS7::getFrequency("}+name+\textcolor{stringliteral}{") unknown name"});
00328 \}
00329 
00330 \textcolor{keywordtype}{double} SoapyLMS7::getFrequency(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel)\textcolor{keyword}{ const}
00331 \textcolor{keyword}{}\{
00332     std::unique\_lock<std::recursive\_mutex> lock(_accessMutex);
00333     \textcolor{keywordflow}{return} lms7Device->GetFrequency(direction == SOAPY_SDR_TX, channel);
00334 \}
00335 
00336 std::vector<std::string> SoapyLMS7::listFrequencies(\textcolor{keyword}{const} \textcolor{keywordtype}{int} \textcolor{comment}{/*direction*/}, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} \textcolor{comment}{/*channel*/})\textcolor{keyword}{
       const}
00337 \textcolor{keyword}{}\{
00338     std::vector<std::string> opts;
00339     opts.push\_back(\textcolor{stringliteral}{"RF"});
00340     opts.push\_back(\textcolor{stringliteral}{"BB"});
00341     \textcolor{keywordflow}{return} opts;
00342 \}
00343 
00344 SoapySDR::RangeList SoapyLMS7::getFrequencyRange(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel, \textcolor{keyword}{const} 
      std::string &name)\textcolor{keyword}{ const}
00345 \textcolor{keyword}{}\{
00346     std::unique\_lock<std::recursive\_mutex> lock(_accessMutex);
00347 
00348     SoapySDR::RangeList ranges;
00349     \textcolor{keywordflow}{if} (name == \textcolor{stringliteral}{"RF"})
00350     \{
00351         ranges.push\_back(SoapySDR::Range(30e6, 3.8e9));
00352     \}
00353     \textcolor{keywordflow}{if} (name == \textcolor{stringliteral}{"BB"})
00354     \{
00355         \textcolor{keyword}{const} \textcolor{keyword}{auto} lmsDir = (direction == SOAPY_SDR_TX)?LMS_CLOCK_TXTSP:
      LMS_CLOCK_RXTSP;
00356         \textcolor{keyword}{const} \textcolor{keywordtype}{double} dspRate = lms7Device->GetClockFreq(lmsDir,channel);
00357         ranges.push\_back(SoapySDR::Range(-dspRate/2, dspRate/2));
00358     \}
00359     \textcolor{keywordflow}{return} ranges;
00360 \}
00361 
00362 SoapySDR::RangeList SoapyLMS7::getFrequencyRange(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel)\textcolor{keyword}{ const}
00363 \textcolor{keyword}{}\{
00364     SoapySDR::RangeList ranges;
00365     ranges.push\_back(SoapySDR::Range(0.0, 3.8e9));
00366     \textcolor{keywordflow}{return} ranges;
00367 \}
00368 
00369 \textcolor{comment}{/*******************************************************************}
00370 \textcolor{comment}{ * Sample Rate API}
00371 \textcolor{comment}{ ******************************************************************/}
00372 
00373 \textcolor{keywordtype}{void} SoapyLMS7::setSampleRate(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel, \textcolor{keyword}{const} \textcolor{keywordtype}{double} 
      rate)
00374 \{
00375     std::unique\_lock<std::recursive\_mutex> lock(_accessMutex);
00376     sampleRate = rate;
00377     lms7Device->SetRate(direction == SOAPY_SDR_TX,rate);
00378     \textcolor{keywordflow}{return};
00379 \}
00380 
00381 \textcolor{keywordtype}{double} SoapyLMS7::getSampleRate(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel)\textcolor{keyword}{ const}
00382 \textcolor{keyword}{}\{
00383     std::unique\_lock<std::recursive\_mutex> lock(_accessMutex);
00384 
00385     \textcolor{keywordflow}{return} lms7Device->GetRate((direction == SOAPY_SDR_TX),channel);
00386 \}
00387 
00388 std::vector<double> SoapyLMS7::listSampleRates(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel)\textcolor{keyword}{ const}
00389 \textcolor{keyword}{}\{
00390     \textcolor{keywordflow}{return} \{MIN_SAMP_RATE, MAX_SAMP_RATE\};
00391 \}
00392 
00393 SoapySDR::RangeList SoapyLMS7::getSampleRateRange(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel)\textcolor{keyword}{ const}
00394 \textcolor{keyword}{}\{
00395     \textcolor{keywordflow}{return} \{ SoapySDR::Range(MIN_SAMP_RATE, MAX_SAMP_RATE) \};
00396 \}
00397 
00398 \textcolor{comment}{/*******************************************************************}
00399 \textcolor{comment}{ * Bandwidth API}
00400 \textcolor{comment}{ ******************************************************************/}
00401 
00402 \textcolor{keywordtype}{void} SoapyLMS7::setBandwidth(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel, \textcolor{keyword}{const} \textcolor{keywordtype}{double} 
      bw)
00403 \{
00404     \textcolor{keywordflow}{if} (bw == 0.0) \textcolor{keywordflow}{return}; \textcolor{comment}{//special ignore value}
00405 
00406     std::unique\_lock<std::recursive\_mutex> lock(_accessMutex);
00407     SoapySDR::logf(SOAPY_SDR_DEBUG, \textcolor{stringliteral}{"SoapyLMS7::setBandwidth(%s, %d, %g MHz)"}, 
      dirName, \textcolor{keywordtype}{int}(channel), bw/1e6);
00408 
00409     _actualBw[direction][channel] = bw;
00410 
00411     \textcolor{keywordflow}{if} (direction == SOAPY_SDR_RX)
00412     \{
00413         \textcolor{keywordflow}{if} (lms7Device->SetLPF(\textcolor{keyword}{false},channel,\textcolor{keyword}{true},bw) != 0)
00414         \{
00415             SoapySDR::logf(SOAPY_SDR_ERROR, \textcolor{stringliteral}{"setBandwidth(Rx, %d, %g MHz) Failed - %s"}, \textcolor{keywordtype}{int}(channel), bw/1
      e6, lime::GetLastErrorMessage());
00416             \textcolor{keywordflow}{throw} std::runtime\_error(lime::GetLastErrorMessage());
00417         \}
00418     \}
00419 
00420     \textcolor{keywordflow}{if} (direction == SOAPY_SDR_TX)
00421     \{
00422         \textcolor{keywordflow}{if} (lms7Device->SetLPF(\textcolor{keyword}{true},channel,\textcolor{keyword}{true},bw) != 0)
00423         \{
00424             SoapySDR::logf(SOAPY_SDR_ERROR, \textcolor{stringliteral}{"setBandwidth(Tx, %d, %g MHz) Failed - %s"}, \textcolor{keywordtype}{int}(channel), bw/1
      e6, lime::GetLastErrorMessage());
00425             \textcolor{keywordflow}{throw} std::runtime\_error(lime::GetLastErrorMessage());
00426         \}
00427     \}
00428 
00429     _channelsToCal.emplace(direction, channel);
00430 \}
00431 
00432 \textcolor{keywordtype}{double} SoapyLMS7::getBandwidth(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel)\textcolor{keyword}{ const}
00433 \textcolor{keyword}{}\{
00434     std::unique\_lock<std::recursive\_mutex> lock(_accessMutex);
00435     \textcolor{keywordflow}{try}
00436     \{
00437         \textcolor{keywordflow}{return} _actualBw.at(direction).at(channel);
00438     \}
00439     \textcolor{keywordflow}{catch} (...)
00440     \{
00441         \textcolor{keywordflow}{return} 1.0;
00442     \}
00443 \}
00444 
00445 SoapySDR::RangeList SoapyLMS7::getBandwidthRange(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel)\textcolor{keyword}{ const}
00446 \textcolor{keyword}{}\{
00447     SoapySDR::RangeList bws;
00448 
00449     \textcolor{keywordflow}{if} (direction == SOAPY_SDR_RX)
00450     \{
00451         bws.push\_back(SoapySDR::Range(1.4e6, 130e6));
00452     \}
00453     \textcolor{keywordflow}{if} (direction == SOAPY_SDR_TX)
00454     \{
00455         bws.push\_back(SoapySDR::Range(5e6, 40e6));
00456         bws.push\_back(SoapySDR::Range(50e6, 130e6));
00457     \}
00458 
00459     \textcolor{keywordflow}{return} bws;
00460 \}
00461 
00462 \textcolor{comment}{/*******************************************************************}
00463 \textcolor{comment}{ * Clocking API}
00464 \textcolor{comment}{ ******************************************************************/}
00465 
00466 \textcolor{keywordtype}{void} SoapyLMS7::setMasterClockRate(\textcolor{keyword}{const} \textcolor{keywordtype}{double} rate)
00467 \{
00468     lms7Device->SetClockFreq(LMS_CLOCK_CGEN,rate);
00469 \}
00470 
00471 \textcolor{keywordtype}{double} SoapyLMS7::getMasterClockRate(\textcolor{keywordtype}{void})\textcolor{keyword}{ const}
00472 \textcolor{keyword}{}\{
00473     std::unique\_lock<std::recursive\_mutex> lock(_accessMutex);
00474     \textcolor{keywordflow}{return} lms7Device->GetClockFreq(LMS_CLOCK_CGEN);;
00475 \}
00476 
00477 SoapySDR::RangeList SoapyLMS7::getMasterClockRates(\textcolor{keywordtype}{void})\textcolor{keyword}{ const}
00478 \textcolor{keyword}{}\{
00479     SoapySDR::RangeList r;
00480     r.push\_back(SoapySDR::Range(MIN_CGEN_RATE, MAX_CGEN_RATE));
00481     \textcolor{keywordflow}{return} r;
00482 \}
00483 
00484 \textcolor{comment}{/*******************************************************************}
00485 \textcolor{comment}{ * Time API}
00486 \textcolor{comment}{ ******************************************************************/}
00487 
00488 \textcolor{keywordtype}{bool} SoapyLMS7::hasHardwareTime(\textcolor{keyword}{const} std::string &what)\textcolor{keyword}{ const}
00489 \textcolor{keyword}{}\{
00490     \textcolor{comment}{//assume hardware time when no argument is specified}
00491     \textcolor{comment}{//some boards may not ever support hw time, so TODO}
00492     \textcolor{keywordflow}{return} what.empty();
00493 \}
00494 
00495 \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} SoapyLMS7::getHardwareTime(\textcolor{keyword}{const} std::string &what)\textcolor{keyword}{ const}
00496 \textcolor{keyword}{}\{
00497     \textcolor{keywordflow}{if} (what.empty())
00498     \{
00499         \textcolor{keywordflow}{if} (sampleRate == 0)
00500         \{
00501             \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"SoapyLMS7::getHardwareTime() sample rate unset"});
00502         \}
00503         \textcolor{keyword}{auto} ticks = lms7Device->GetHardwareTimestamp();
00504         \textcolor{keywordflow}{return} SoapySDR::ticksToTimeNs(ticks, sampleRate);
00505     \}
00506     \textcolor{keywordflow}{else}
00507     \{
00508         \textcolor{keywordflow}{throw} std::invalid\_argument(\textcolor{stringliteral}{"SoapyLMS7::getHardwareTime("}+what+\textcolor{stringliteral}{") unknown argument"});
00509     \}
00510 \}
00511 
00512 \textcolor{keywordtype}{void} SoapyLMS7::setHardwareTime(\textcolor{keyword}{const} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} timeNs, \textcolor{keyword}{const} std::string &what)
00513 \{
00514     \textcolor{keywordflow}{if} (what.empty())
00515     \{
00516         \textcolor{keywordflow}{if} (sampleRate == 0)
00517         \{
00518             \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"SoapyLMS7::setHardwareTime() sample rate unset"});
00519         \}
00520         \textcolor{keyword}{auto} ticks = SoapySDR::timeNsToTicks(timeNs, sampleRate);
00521         lms7Device->SetHardwareTimestamp(ticks);
00522     \}
00523     \textcolor{keywordflow}{else}
00524     \{
00525         \textcolor{keywordflow}{throw} std::invalid\_argument(\textcolor{stringliteral}{"SoapyLMS7::setHardwareTime("}+what+\textcolor{stringliteral}{") unknown argument"});
00526     \}
00527 \}
00528 
00529 \textcolor{comment}{/*******************************************************************}
00530 \textcolor{comment}{ * Sensor API}
00531 \textcolor{comment}{ ******************************************************************/}
00532 
00533 std::vector<std::string> SoapyLMS7::listSensors(\textcolor{keywordtype}{void})\textcolor{keyword}{ const}
00534 \textcolor{keyword}{}\{
00535     std::vector<std::string> sensors;
00536     sensors.push\_back(\textcolor{stringliteral}{"clock\_locked"});
00537     sensors.push\_back(\textcolor{stringliteral}{"lms7\_temp"});
00538     sensors.push\_back(\textcolor{stringliteral}{"chirp\_period"});
00539     sensors.push\_back(\textcolor{stringliteral}{"chirp\_time"});
00540     \textcolor{keywordflow}{return} sensors;
00541 \}
00542 
00543 SoapySDR::ArgInfo SoapyLMS7::getSensorInfo(\textcolor{keyword}{const} std::string &name)\textcolor{keyword}{ const}
00544 \textcolor{keyword}{}\{
00545     SoapySDR::ArgInfo info;
00546     \textcolor{keywordflow}{if} (name == \textcolor{stringliteral}{"clock\_locked"})
00547     \{
00548         info.key = \textcolor{stringliteral}{"clock\_locked"};
00549         info.name = \textcolor{stringliteral}{"Clock Locked"};
00550         info.type = SoapySDR::ArgInfo::BOOL;
00551         info.value = \textcolor{stringliteral}{"false"};
00552         info.description = \textcolor{stringliteral}{"CGEN clock is locked, good VCO selection."};
00553     \}
00554     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (name == \textcolor{stringliteral}{"lms7\_temp"})
00555     \{
00556         info.key = \textcolor{stringliteral}{"lms7\_temp"};
00557         info.name = \textcolor{stringliteral}{"LMS7 Temperature"};
00558         info.type = SoapySDR::ArgInfo::FLOAT;
00559         info.value = \textcolor{stringliteral}{"0.0"};
00560         info.units = \textcolor{stringliteral}{"C"};
00561         info.description = \textcolor{stringliteral}{"The temperature of the LMS7002M in degrees C."};
00562     \}
00563     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (name == \textcolor{stringliteral}{"chirp\_period"})
00564     \{
00565         info.key = \textcolor{stringliteral}{"chirp\_period"};
00566         info.name = \textcolor{stringliteral}{"Chirp Period"};
00567         info.type = SoapySDR::ArgInfo::INT;
00568         info.value = \textcolor{stringliteral}{"0"};
00569         info.units = \textcolor{stringliteral}{"ns"};
00570         info.description = \textcolor{stringliteral}{"The length in nanoseconds of an external chirp signal. Period of external
       function generators sync signal."};
00571     \}
00572     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (name == \textcolor{stringliteral}{"chirp\_time"})
00573     \{
00574         info.key = \textcolor{stringliteral}{"chirp\_time"};
00575         info.name = \textcolor{stringliteral}{"Chirp Timestamp"};
00576         info.type = SoapySDR::ArgInfo::INT;
00577         info.value = \textcolor{stringliteral}{"0"};
00578         info.units = \textcolor{stringliteral}{"ns"};
00579         info.description = \textcolor{stringliteral}{"The timestamp of last chirp start"};
00580     \}
00581     \textcolor{keywordflow}{return} info;
00582 \}
00583 
00584 std::string SoapyLMS7::readSensor(\textcolor{keyword}{const} std::string &name)\textcolor{keyword}{ const}
00585 \textcolor{keyword}{}\{
00586     std::unique\_lock<std::recursive\_mutex> lock(_accessMutex);
00587 
00588     \textcolor{keywordflow}{if} (name == \textcolor{stringliteral}{"clock\_locked"})
00589     \{
00590         \textcolor{keywordflow}{return} lms7Device->GetLMS()->GetCGENLocked()?\textcolor{stringliteral}{"true"}:\textcolor{stringliteral}{"false"};
00591     \}
00592     \textcolor{keywordflow}{if} (name == \textcolor{stringliteral}{"lms7\_temp"})
00593     \{
00594         \textcolor{keywordflow}{return} std::to\_string(lms7Device->GetChipTemperature());
00595     \}
00596     \textcolor{keywordflow}{if} (name == \textcolor{stringliteral}{"chirp\_period"})
00597     \{
00598       \textcolor{keywordflow}{if} (sampleRate == 0)
00599       \{
00600         \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"SoapyLMS7::readSensor (chirp\_period) sample rate unset"});
00601       \}
00602       \textcolor{keywordflow}{else}
00603       \{
00604         \textcolor{keyword}{auto} ticks = lms7Device->GetChirpTimePeriod();
00605         \textcolor{keywordflow}{return} std::to\_string(SoapySDR::ticksToTimeNs(ticks, sampleRate));
00606       \}
00607     \}
00608     \textcolor{keywordflow}{if} (name == \textcolor{stringliteral}{"chirp\_time"})
00609     \{
00610       \textcolor{keywordflow}{if} (sampleRate == 0)
00611       \{
00612         \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"SoapyLMS7::readSensor (chirp\_time) sample rate unset"});
00613       \}
00614       \textcolor{keywordflow}{else}
00615       \{
00616         \textcolor{keyword}{auto} ticks = lms7Device->GetChirpTimeStamp();
00617         \textcolor{keywordflow}{return} std::to\_string(SoapySDR::ticksToTimeNs(ticks, sampleRate));
00618       \}
00619     \}
00620 
00621     \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"SoapyLMS7::readSensor("}+name+\textcolor{stringliteral}{") - unknown sensor name"});
00622 \}
00623 
00624 std::vector<std::string> SoapyLMS7::listSensors(\textcolor{keyword}{const} \textcolor{keywordtype}{int} \textcolor{comment}{/*direction*/}, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} \textcolor{comment}{/*channel*/})\textcolor{keyword}{ const}
00625 \textcolor{keyword}{}\{
00626     std::vector<std::string> sensors;
00627     sensors.push\_back(\textcolor{stringliteral}{"lo\_locked"});
00628     \textcolor{keywordflow}{return} sensors;
00629 \}
00630 
00631 SoapySDR::ArgInfo SoapyLMS7::getSensorInfo(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel, \textcolor{keyword}{const} 
      std::string &name)\textcolor{keyword}{ const}
00632 \textcolor{keyword}{}\{
00633     SoapySDR::ArgInfo info;
00634     \textcolor{keywordflow}{if} (name == \textcolor{stringliteral}{"lo\_locked"})
00635     \{
00636         info.key = \textcolor{stringliteral}{"lo\_locked"};
00637         info.name = \textcolor{stringliteral}{"LO Locked"};
00638         info.type = SoapySDR::ArgInfo::BOOL;
00639         info.value = \textcolor{stringliteral}{"false"};
00640         info.description = \textcolor{stringliteral}{"LO synthesizer is locked, good VCO selection."};
00641     \}
00642     \textcolor{keywordflow}{return} info;
00643 \}
00644 
00645 std::string SoapyLMS7::readSensor(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel, \textcolor{keyword}{const} 
      std::string &name)\textcolor{keyword}{ const}
00646 \textcolor{keyword}{}\{
00647     std::unique\_lock<std::recursive\_mutex> lock(_accessMutex);
00648     \textcolor{keyword}{const} \textcolor{keyword}{auto} lmsDir = (direction == SOAPY_SDR_TX)?LMS7002M::Tx:LMS7002M::Rx;
00649 
00650     \textcolor{keywordflow}{if} (name == \textcolor{stringliteral}{"lo\_locked"})
00651     \{
00652         \textcolor{keywordflow}{return} lms7Device->GetLMS(channel/2)->GetSXLocked(lmsDir)?\textcolor{stringliteral}{"true"}:\textcolor{stringliteral}{"false"};
00653     \}
00654 
00655     \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"SoapyLMS7::readSensor("}+name+\textcolor{stringliteral}{") - unknown sensor name"});
00656 \}
00657 
00658 \textcolor{comment}{/*******************************************************************}
00659 \textcolor{comment}{ * Register API}
00660 \textcolor{comment}{ ******************************************************************/}
00661 
00662 std::vector<std::string> SoapyLMS7::listRegisterInterfaces(\textcolor{keywordtype}{void})\textcolor{keyword}{ const}
00663 \textcolor{keyword}{}\{
00664     std::vector<std::string> ifaces;
00665     ifaces.push\_back(\textcolor{stringliteral}{"BBIC"});
00666     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} i = 0; i < lms7Device->GetNumChannels()/2; i++)
00667     \{
00668         ifaces.push\_back(\textcolor{stringliteral}{"RFIC"} + std::to\_string(i));
00669     \}
00670     \textcolor{keywordflow}{return} ifaces;
00671 \}
00672 
00673 \textcolor{keywordtype}{void} SoapyLMS7::writeRegister(\textcolor{keyword}{const} std::string &name, \textcolor{keyword}{const} \textcolor{keywordtype}{unsigned} addr, \textcolor{keyword}{const} \textcolor{keywordtype}{unsigned} value)
00674 \{
00675     \textcolor{keywordflow}{if} (name == \textcolor{stringliteral}{"BBIC"}) \textcolor{keywordflow}{return} this->writeRegister(addr, value);
00676     \textcolor{keywordflow}{if} (\textcolor{stringliteral}{"RFIC"} != name.substr(0,4))
00677         \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"SoapyLMS7::readRegister("}+name+\textcolor{stringliteral}{") unknown interface"});
00678 
00679     \textcolor{keywordtype}{int} st = lms7Device->WriteLMSReg(addr, value, name[4]-\textcolor{charliteral}{'0'});
00680     \textcolor{keywordflow}{if} (st == 0) \textcolor{keywordflow}{return};
00681     \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"SoapyLMS7::WriteRegister("}+name+\textcolor{stringliteral}{", "}+std::to\_string(addr)+\textcolor{stringliteral}{") FAIL"});
00682 
00683 \}
00684 
00685 \textcolor{keywordtype}{unsigned} SoapyLMS7::readRegister(\textcolor{keyword}{const} std::string &name, \textcolor{keyword}{const} \textcolor{keywordtype}{unsigned} addr)\textcolor{keyword}{ const}
00686 \textcolor{keyword}{}\{
00687     \textcolor{keywordflow}{if} (name == \textcolor{stringliteral}{"BBIC"}) \textcolor{keywordflow}{return} this->readRegister(addr);
00688     \textcolor{keywordflow}{if} (\textcolor{stringliteral}{"RFIC"} != name.substr(0,4))
00689         \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"SoapyLMS7::readRegister("}+name+\textcolor{stringliteral}{") unknown interface"});
00690 
00691     \textcolor{keywordflow}{return} lms7Device->ReadLMSReg(addr, name[4]-\textcolor{charliteral}{'0'});
00692 \}
00693 
00694 \textcolor{keywordtype}{void} SoapyLMS7::writeRegister(\textcolor{keyword}{const} \textcolor{keywordtype}{unsigned} addr, \textcolor{keyword}{const} \textcolor{keywordtype}{unsigned} value)
00695 \{
00696     \textcolor{keyword}{auto} st = lms7Device->GetConnection()->WriteRegister(addr, value);
00697     \textcolor{keywordflow}{if} (st != 0) \textcolor{keywordflow}{throw} std::runtime\_error(
00698         \textcolor{stringliteral}{"SoapyLMS7::WriteRegister("}+std::to\_string(addr)+\textcolor{stringliteral}{") FAIL"});
00699 \}
00700 
00701 \textcolor{keywordtype}{unsigned} SoapyLMS7::readRegister(\textcolor{keyword}{const} \textcolor{keywordtype}{unsigned} addr)\textcolor{keyword}{ const}
00702 \textcolor{keyword}{}\{
00703     \textcolor{keywordtype}{unsigned} readbackData = 0;
00704     \textcolor{keyword}{auto} st = lms7Device->GetConnection()->ReadRegister(addr, readbackData);
00705     \textcolor{keywordflow}{if} (st != 0) \textcolor{keywordflow}{throw} std::runtime\_error(
00706         \textcolor{stringliteral}{"SoapyLMS7::ReadRegister("}+std::to\_string(addr)+\textcolor{stringliteral}{") FAIL"});
00707     \textcolor{keywordflow}{return} readbackData;
00708 \}
00709 
00710 \textcolor{comment}{/*******************************************************************}
00711 \textcolor{comment}{ * Settings API}
00712 \textcolor{comment}{ ******************************************************************/}
00713 SoapySDR::ArgInfoList SoapyLMS7::getSettingInfo(\textcolor{keywordtype}{void})\textcolor{keyword}{ const}
00714 \textcolor{keyword}{}\{
00715     SoapySDR::ArgInfoList infos;
00716 
00717     \textcolor{keywordflow}{return} infos;
00718 \}
00719 
00720 \textcolor{keywordtype}{void} SoapyLMS7::writeSetting(\textcolor{keyword}{const} std::string &key, \textcolor{keyword}{const} std::string &value)
00721 \{
00722     \textcolor{keywordflow}{if} (key == \textcolor{stringliteral}{"RXTSP\_CONST"})
00723     \{
00724         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} channel = 0; channel < lms7Device->GetNumChannels(); channel++)
00725         \{
00726             this->writeSetting(SOAPY_SDR_RX, channel, \textcolor{stringliteral}{"TSP\_CONST"}, value);
00727         \}
00728     \}
00729 
00730     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (key == \textcolor{stringliteral}{"TXTSP\_CONST"})
00731     \{
00732         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} channel = 0; channel < lms7Device->GetNumChannels(); channel++)
00733         \{
00734             this->writeSetting(SOAPY_SDR_TX, channel, \textcolor{stringliteral}{"TSP\_CONST"}, value);
00735         \}
00736     \}
00737 
00738     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (key == \textcolor{stringliteral}{"CALIBRATE\_TX"})
00739     \{
00740         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} channel = 0; channel < lms7Device->GetNumChannels(); channel++)
00741         \{
00742             this->writeSetting(SOAPY_SDR_TX, channel, \textcolor{stringliteral}{"CALIBRATE\_TX"}, value);
00743         \}
00744     \}
00745 
00746     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (key == \textcolor{stringliteral}{"CALIBRATE\_RX"})
00747     \{
00748         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} channel = 0; channel < lms7Device->GetNumChannels(); channel++)
00749         \{
00750             this->writeSetting(SOAPY_SDR_RX, channel, \textcolor{stringliteral}{"CALIBRATE\_RX"}, value);
00751         \}
00752     \}
00753 
00754     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (key == \textcolor{stringliteral}{"ENABLE\_RX\_GFIR\_LPF"})
00755     \{
00756         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} channel = 0; channel < lms7Device->GetNumChannels(); channel++)
00757         \{
00758             this->writeSetting(SOAPY_SDR_RX, channel, \textcolor{stringliteral}{"ENABLE\_GFIR\_LPF"}, value);
00759         \}
00760     \}
00761 
00762     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (key == \textcolor{stringliteral}{"ENABLE\_TX\_GFIR\_LPF"})
00763     \{
00764         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} channel = 0; channel < lms7Device->GetNumChannels(); channel++)
00765         \{
00766             this->writeSetting(SOAPY_SDR_TX, channel, \textcolor{stringliteral}{"ENABLE\_GFIR\_LPF"}, value);
00767         \}
00768     \}
00769 
00770     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (key == \textcolor{stringliteral}{"DISABLE\_RX\_GFIR\_LPF"})
00771     \{
00772         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} channel = 0; channel < lms7Device->GetNumChannels(); channel++)
00773         \{
00774             this->writeSetting(SOAPY_SDR_RX, channel, \textcolor{stringliteral}{"DISABLE\_GFIR\_LPF"}, value);
00775         \}
00776     \}
00777 
00778     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (key == \textcolor{stringliteral}{"DISABLE\_TX\_GFIR\_LPF"})
00779     \{
00780         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} channel = 0; channel < lms7Device->GetNumChannels(); channel++)
00781         \{
00782             this->writeSetting(SOAPY_SDR_TX, channel, \textcolor{stringliteral}{"DISABLE\_GFIR\_LPF"}, value);
00783         \}
00784     \}
00785 
00786     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (key == \textcolor{stringliteral}{"RXTSG\_NCO"})
00787     \{
00788         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} channel = 0; channel < lms7Device->GetNumChannels(); channel++)
00789         \{
00790             this->writeSetting(SOAPY_SDR_RX, channel, \textcolor{stringliteral}{"TSG\_NCO"}, value);
00791         \}
00792     \}
00793 
00794     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (key == \textcolor{stringliteral}{"TXTSG\_NCO"})
00795     \{
00796         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} channel = 0; channel < lms7Device->GetNumChannels(); channel++)
00797         \{
00798             this->writeSetting(SOAPY_SDR_TX, channel, \textcolor{stringliteral}{"TSG\_NCO"}, value);
00799         \}
00800     \}
00801 
00802     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (key == \textcolor{stringliteral}{"SAVE\_CONFIG"})
00803     \{
00804         lms7Device->SaveConfig(value.c\_str());
00805     \}
00806 
00807     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (key == \textcolor{stringliteral}{"LOAD\_CONFIG"})
00808     \{
00809         lms7Device->LoadConfig(value.c\_str());
00810     \}
00811 
00812     \textcolor{keywordflow}{else}
00813     \{
00814         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} channel = 0; channel < lms7Device->GetNumChannels(); channel++)
00815         \{
00816             this->writeSetting(SOAPY_SDR_RX, channel, key, value);
00817         \}
00818     \}
00819 \}
00820 
00821 SoapySDR::ArgInfoList SoapyLMS7::getSettingInfo(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel)\textcolor{keyword}{ const}
00822 \textcolor{keyword}{}\{
00823     SoapySDR::ArgInfoList infos;
00824 
00825     \{
00826         SoapySDR::ArgInfo info;
00827         info.key = \textcolor{stringliteral}{"TSP\_CONST"};
00828         info.name = \textcolor{stringliteral}{"TSP DC Level"};
00829         info.type = SoapySDR::ArgInfo::INT;
00830         info.description = \textcolor{stringliteral}{"Digital DC level in LMS7002M TSP chain."};
00831         info.range = SoapySDR::Range(0, (1 << 15)-1);
00832         infos.push\_back(info);
00833     \}
00834 
00835     \textcolor{keywordflow}{return} infos;
00836 \}
00837 
00838 \textcolor{keywordtype}{void} SoapyLMS7::writeSetting(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel, \textcolor{keyword}{const} 
      std::string &key, \textcolor{keyword}{const} std::string &value)
00839 \{
00840     std::unique\_lock<std::recursive\_mutex> lock(_accessMutex);
00841     \textcolor{keyword}{const} \textcolor{keywordtype}{bool} isTx = (direction == SOAPY_SDR_TX);
00842 
00843     \textcolor{keywordflow}{if} (key == \textcolor{stringliteral}{"TSP\_CONST"})
00844     \{
00845         \textcolor{keyword}{const} \textcolor{keyword}{auto} ampl = std::stoi(value);
00846         lms7Device->SetTestSignal(isTx, channel, LMS_TESTSIG_DC, ampl, 0);
00847     \}
00848 
00849     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (key == \textcolor{stringliteral}{"CALIBRATE\_TX"} or (isTx and key == \textcolor{stringliteral}{"CALIBRATE"}))
00850     \{
00851         \textcolor{keywordtype}{double} bw = std::stof(value);
00852         SoapySDR::logf(SOAPY_SDR_INFO, \textcolor{stringliteral}{"Calibrate Tx %f"}, bw);
00853         \textcolor{keywordflow}{if} (lms7Device->Calibrate(\textcolor{keyword}{true}, channel, bw, 0)!=0)
00854             \textcolor{keywordflow}{throw} std::runtime\_error(lime::GetLastErrorMessage());
00855         _channelsToCal.erase(std::make\_pair(direction, channel));
00856     \}
00857 
00858     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (key == \textcolor{stringliteral}{"CALIBRATE\_RX"} or (not isTx and key == \textcolor{stringliteral}{"CALIBRATE"}))
00859     \{
00860         \textcolor{keywordtype}{double} bw = std::stof(value);
00861         SoapySDR::logf(SOAPY_SDR_INFO, \textcolor{stringliteral}{"CalibrateRx %f"}, bw);
00862         \textcolor{keywordflow}{if} (lms7Device->Calibrate(\textcolor{keyword}{false}, channel, bw, 0)!=0)
00863             \textcolor{keywordflow}{throw} std::runtime\_error(lime::GetLastErrorMessage());
00864         _channelsToCal.erase(std::make\_pair(direction, channel));
00865     \}
00866 
00867     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (key == \textcolor{stringliteral}{"ENABLE\_GFIR\_LPF"})
00868     \{
00869         \textcolor{keywordtype}{double} bw = std::stof(value);
00870         SoapySDR::logf(SOAPY_SDR_INFO, \textcolor{stringliteral}{"Configurate GFIR LPF %f"}, bw);
00871         lms7Device->ConfigureGFIR(isTx, channel, \textcolor{keyword}{true}, bw);
00872     \}
00873 
00874     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}  (key == \textcolor{stringliteral}{"DISABLE\_GFIR\_LPF"})
00875     \{
00876         SoapySDR::logf(SOAPY_SDR_INFO, \textcolor{stringliteral}{"Disable GFIR LPF"});
00877         lms7Device->ConfigureGFIR(isTx, channel, \textcolor{keyword}{false}, 0.0);
00878     \}
00879 
00880     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (key == \textcolor{stringliteral}{"TSG\_NCO"})
00881     \{
00882         \textcolor{keyword}{auto} select = std::stoi(value);
00883         \textcolor{keywordflow}{if} (select == -1)
00884         \{
00885             \textcolor{comment}{//Requested to disable the TSG}
00886             lms7Device->SetTestSignal(isTx, channel, LMS_TESTSIG_NONE);
00887         \}
00888         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(select == 4)
00889         \{
00890             lms7Device->SetTestSignal(isTx, channel, LMS_TESTSIG_NCODIV4F);
00891         \}
00892         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (select == 8)
00893         \{
00894             lms7Device->SetTestSignal(isTx, channel, LMS_TESTSIG_NCODIV8F);
00895         \}
00896         \textcolor{keywordflow}{else}
00897         \{
00898             \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"Invalid TSG\_NCO option: "} + value);
00899         \}
00900     \}
00901     \textcolor{keywordflow}{else}
00902     \{
00903         uint16\_t val = std::stoi(value);
00904         \textcolor{keywordflow}{if} (lms7Device->WriteParam(key,val,channel)!=-1)
00905             \textcolor{keywordflow}{return};
00906         \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"unknown setting key: "}+key);
00907     \}
00908 \}
00909 
00910 std::string SoapyLMS7::readSetting(\textcolor{keyword}{const} std::string &key)\textcolor{keyword}{ const}
00911 \textcolor{keyword}{}\{
00912     \textcolor{keywordflow}{return} readSetting(SOAPY_SDR_TX, 0, key);
00913 \}
00914 
00915 std::string SoapyLMS7::readSetting(\textcolor{keyword}{const} \textcolor{keywordtype}{int} direction, \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} channel, \textcolor{keyword}{const} 
      std::string &key)\textcolor{keyword}{ const}
00916 \textcolor{keyword}{}\{
00917     \textcolor{keywordtype}{int} val = lms7Device->ReadParam(key,channel);
00918     \textcolor{keywordflow}{if} ( val !=-1)
00919         \textcolor{keywordflow}{return} std::to\_string(val);
00920 
00921     \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"unknown setting key: "}+key);
00922 \}
00923 \textcolor{comment}{/******************************************************************}
00924 \textcolor{comment}{ * GPIO API}
00925 \textcolor{comment}{ ******************************************************************/}
00926 
00927 std::vector<std::string> SoapyLMS7::listGPIOBanks(\textcolor{keywordtype}{void})\textcolor{keyword}{ const}
00928 \textcolor{keyword}{}\{
00929     std::vector<std::string> banks;
00930     banks.push\_back(\textcolor{stringliteral}{"MAIN"}); \textcolor{comment}{//just one associated with the connection}
00931     \textcolor{keywordflow}{return} banks;
00932 \}
00933 
00934 \textcolor{keywordtype}{void} SoapyLMS7::writeGPIO(\textcolor{keyword}{const} std::string &, \textcolor{keyword}{const} \textcolor{keywordtype}{unsigned} value)
00935 \{
00936     \textcolor{keywordtype}{int} r = lms7Device->GetConnection()->GPIOWrite((uint8\_t*)&value, \textcolor{keyword}{sizeof}(value));
00937     \textcolor{keywordflow}{if} (r != 0) \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"SoapyLMS7::writeGPIO() "} + std::string(
      lime::GetLastErrorMessage()));
00938 \}
00939 
00940 \textcolor{keywordtype}{unsigned} SoapyLMS7::readGPIO(\textcolor{keyword}{const} std::string &)\textcolor{keyword}{ const}
00941 \textcolor{keyword}{}\{
00942     \textcolor{keywordtype}{unsigned} buffer(0);
00943     \textcolor{keywordtype}{int} r = lms7Device->GetConnection()->GPIORead((uint8\_t*)&buffer, \textcolor{keyword}{sizeof}(buffer));
00944     \textcolor{keywordflow}{if} (r != 0) \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"SoapyLMS7::readGPIO() "} + std::string(
      lime::GetLastErrorMessage()));
00945     \textcolor{keywordflow}{return} buffer;
00946 \}
00947 
00948 \textcolor{keywordtype}{void} SoapyLMS7::writeGPIODir(\textcolor{keyword}{const} std::string &, \textcolor{keyword}{const} \textcolor{keywordtype}{unsigned} dir)
00949 \{
00950     \textcolor{keywordtype}{int} r = lms7Device->GetConnection()->GPIODirWrite((uint8\_t*)&dir, \textcolor{keyword}{sizeof}(dir));
00951     \textcolor{keywordflow}{if} (r != 0) \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"SoapyLMS7::writeGPIODir() "} + 
      std::string(lime::GetLastErrorMessage()));
00952 \}
00953 
00954 \textcolor{keywordtype}{unsigned} SoapyLMS7::readGPIODir(\textcolor{keyword}{const} std::string &)\textcolor{keyword}{ const}
00955 \textcolor{keyword}{}\{
00956     \textcolor{keywordtype}{unsigned} buffer(0);
00957     \textcolor{keywordtype}{int} r = lms7Device->GetConnection()->GPIODirRead((uint8\_t*)&buffer, \textcolor{keyword}{sizeof}(buffer));
00958     \textcolor{keywordflow}{if} (r != 0) \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"SoapyLMS7::readGPIODir() "} + 
      std::string(lime::GetLastErrorMessage()));
00959     \textcolor{keywordflow}{return} buffer;
00960 \}
\end{DoxyCode}

\subsection{lms7002\+\_\+pnl\+M\+C\+U\+\_\+\+B\+D\+\_\+view.\+cpp}
\label{lms7002__pnlMCU__BD__view_8cpp_source}\index{/home/erik/prefix/default/src/limesuite-\/dev/src/lms7002\+\_\+wxgui/lms7002\+\_\+pnl\+M\+C\+U\+\_\+\+B\+D\+\_\+view.\+cpp@{/home/erik/prefix/default/src/limesuite-\/dev/src/lms7002\+\_\+wxgui/lms7002\+\_\+pnl\+M\+C\+U\+\_\+\+B\+D\+\_\+view.\+cpp}}

\begin{DoxyCode}
00001 \textcolor{preprocessor}{#include <fstream>}
00002 \textcolor{preprocessor}{#include "lms7002_pnlMCU_BD_view.h"}
00003 \textcolor{preprocessor}{#include <wx/msgdlg.h>}
00004 \textcolor{preprocessor}{#include <wx/filedlg.h>}
00005 \textcolor{preprocessor}{#include "dlgViewIRAM.h"}
00006 \textcolor{preprocessor}{#include "dlgViewSFR.h"}
00007 \textcolor{preprocessor}{#include "MCU_File.h"}
00008 \textcolor{preprocessor}{#include "device_constants.h"}
00009 
00010 
00011 \textcolor{keyword}{const} \textcolor{keywordtype}{long} lms7002_pnlMCU_BD_view::ID_PROGRAMING_STATUS_EVENT = wxNewId();
00012 \textcolor{keyword}{const} \textcolor{keywordtype}{long} lms7002_pnlMCU_BD_view::ID_PROGRAMING_FINISH_EVENT = wxNewId();
00013 
00014 lms7002_pnlMCU_BD_view::lms7002_pnlMCU_BD_view(wxWindow* parent)
00015     :
00016     pnlMCU_BD_view(parent), lmsControl(nullptr)
00017 \{
00018     mThreadWorking = \textcolor{keyword}{false};
00019     progressPooler = \textcolor{keyword}{new} wxTimer(\textcolor{keyword}{this}, wxNewId());
00020 
00021     m_iRegAddress = 1;
00022     m_iRegRead = 1;
00023     m_iTestNo = 0;
00024     m_bLoadedDebug = 0;
00025     m_bLoadedProd = 0;
00026 
00027     m_iDebug = 0;
00028     m_iPCvalue = 0;
00029     m_iTestNo = 1;
00030     m_iInstrNo = 1;
00031     m_iMode0 = 0;
00032     m_iMode1 = 0;
00033 
00034     m_iRegAddress = 1;
00035     m_iRegRead = 1;
00036 
00037     RunInstr->Enable(\textcolor{keyword}{false});
00038     ResetPC->Enable(\textcolor{keyword}{false});
00039     InstrNo->Enable(\textcolor{keyword}{false});
00040     ViewSFRs->Enable(\textcolor{keyword}{false});
00041     ViewIRAM->Enable(\textcolor{keyword}{false});
00042     EraseIRAM->Enable(\textcolor{keyword}{false});
00043     SelDiv->Enable(\textcolor{keyword}{false});
00044     SelDiv->SetSelection(0);
00045     cmbRegAddr->SetSelection(1);
00046 
00047     PCValue->SetLabel(wxString::Format(\_(\textcolor{stringliteral}{"0x%04X"}), m_iPCvalue));
00048 
00049     InstrNo->SetLabel(\_(\textcolor{stringliteral}{"1"}));
00050     m_sTestNo->SetLabel(\_(\textcolor{stringliteral}{"1"}));
00051     chkReset->SetValue(\textcolor{keyword}{true});
00052     mLoadedProgramFilename = \textcolor{stringliteral}{""};
00053     m_iLoopTries=20;
00054     obj_ptr=\textcolor{keyword}{this};
00055 \}
00056 
00057 lms7002_pnlMCU_BD_view::~lms7002_pnlMCU_BD_view()
00058 \{
00059     \textcolor{keywordflow}{if}(mThreadWorking)
00060         mWorkerThread.join();
00061 \}
00062 
00068 \textcolor{keywordtype}{int} lms7002_pnlMCU_BD_view::GetProgramCode(\textcolor{keyword}{const} \textcolor{keywordtype}{char}* inFileName, \textcolor{keywordtype}{bool} bin)
00069 \{
00070     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} ch=0x00;
00071     \textcolor{keywordtype}{bool} find\_byte=\textcolor{keyword}{false};
00072     \textcolor{keywordtype}{size\_t} i=0;
00073 
00074     \textcolor{keywordflow}{if}(!bin)
00075     \{
00076         MCU_File    inFile(inFileName, \textcolor{stringliteral}{"rb"});
00077         \textcolor{keywordflow}{if} (inFile.FileOpened() == \textcolor{keyword}{false})
00078             \textcolor{keywordflow}{return} -1;
00079 
00080         mLoadedProgramFilename = inFileName;
00081         \textcolor{keywordflow}{try}
00082         \{
00083             inFile.ReadHex(max_array_size-1);
00084         \}
00085         \textcolor{keywordflow}{catch} (...)
00086         \{
00087             \textcolor{keywordflow}{return} -1;
00088         \}
00089 
00090         \textcolor{keywordflow}{for} (i = 0; i<max_array_size; i++)
00091         \{
00092             find\_byte=inFile.GetByte(i, ch);
00093             \textcolor{keywordflow}{if} (find\_byte==\textcolor{keyword}{true})
00094                 byte_array[i]=ch;
00095             \textcolor{keywordflow}{else}
00096                 byte_array[i]=0x00;
00097         \};
00098     \}
00099     \textcolor{keywordflow}{else}
00100     \{
00101         \textcolor{keywordtype}{char} inByte = 0;
00102         std::fstream fin;
00103         fin.open(inFileName, std::ios::in | std::ios::binary);
00104         \textcolor{keywordflow}{if} (fin.good() == \textcolor{keyword}{false})
00105             \textcolor{keywordflow}{return} -1;
00106         mLoadedProgramFilename = inFileName;
00107         memset(byte_array, 0, max_array_size);
00108         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} i = 0; i<max_array_size && !fin.eof(); ++i)
00109         \{
00110             inByte = 0;
00111             fin.read(&inByte, 1);
00112             byte_array[i]=inByte;
00113         \}
00114     \}
00115     \textcolor{keywordflow}{return} 0;
00116 \}
00117 
00118 \textcolor{keywordtype}{void} lms7002_pnlMCU_BD_view::OnButton_LOADHexClick( wxCommandEvent& event )
00119 \{
00120     wxFileDialog dlg(\textcolor{keyword}{this}, \_(\textcolor{stringliteral}{"Open hex file"}), \_(\textcolor{stringliteral}{"hex"}), \_(\textcolor{stringliteral}{"*.hex"}), \_(\textcolor{stringliteral}{"HEX Files (*.hex)|*.hex|BIN Files
       (*.bin)|*.bin|All Files (*.*)|*.*||"}), wxFD\_OPEN | wxFD\_FILE\_MUST\_EXIST);
00121     \textcolor{keywordflow}{if} (dlg.ShowModal() == wxID\_CANCEL)
00122         \textcolor{keywordflow}{return};
00123 
00124     wxString m\_sHexFileName = dlg.GetPath();
00125     \textcolor{keywordtype}{int} status = 0;
00126     \textcolor{keywordflow}{if} (dlg.GetFilterIndex() == 0)
00127         status = GetProgramCode(m\_sHexFileName.mb\_str(), \textcolor{keyword}{false});
00128     \textcolor{keywordflow}{else}
00129         status = GetProgramCode(m\_sHexFileName.mb\_str(), \textcolor{keyword}{true});
00130 
00131     \textcolor{keywordflow}{if} (status != 0)
00132     \{
00133         wxMessageBox(\_(\textcolor{stringliteral}{"Failed to load Hex file"}));
00134         \textcolor{keywordflow}{return};
00135     \}
00136 
00137     wxString temps;
00138     temps = \_(\textcolor{stringliteral}{".hex file: "});
00139     temps = temps << m\_sHexFileName;
00140     lblProgCodeFile->SetLabel(temps);
00141 \}
00142 
00143 \textcolor{keywordtype}{void} lms7002_pnlMCU_BD_view::OnchkResetClick( wxCommandEvent& event )
00144 \{
00145     assert(lmsControl != \textcolor{keyword}{nullptr});
00146     \textcolor{keywordflow}{if} (chkReset->IsChecked())
00147     \{
00148         \textcolor{comment}{// MODE=0}
00149         \textcolor{comment}{// RESET}
00150         m_iMode0 = 0;
00151         m_iMode1 = 0;
00152         LMS_Program(lmsControl, \textcolor{keyword}{nullptr}, 0, lime::program_mode::mcuReset, \textcolor{keyword}{nullptr});
00153         rgrMode->Enable(\textcolor{keyword}{false});
00154         btnStartProgramming->Enable(\textcolor{keyword}{false});
00155         DebugMode->SetValue(\textcolor{keyword}{false});
00156 
00157         m_iDebug = 0;
00158         RunInstr->Enable(\textcolor{keyword}{false});
00159         ResetPC->Enable(\textcolor{keyword}{false});
00160         InstrNo->Enable(\textcolor{keyword}{false});
00161         ViewSFRs->Enable(\textcolor{keyword}{false});
00162         ViewIRAM->Enable(\textcolor{keyword}{false});
00163         EraseIRAM->Enable(\textcolor{keyword}{false});
00164         SelDiv->Enable(\textcolor{keyword}{false});
00165         \textcolor{comment}{// global variables}
00166         m_bLoadedDebug = 0;
00167         m_bLoadedProd = 0;
00168     \}
00169     \textcolor{keywordflow}{else}
00170     \{
00171         rgrMode->Enable(\textcolor{keyword}{true});
00172         btnStartProgramming->Enable(\textcolor{keyword}{true});
00173     \}
00174 \}
00175 
00176 \textcolor{keywordtype}{void} lms7002_pnlMCU_BD_view::OnbtnStartProgrammingClick( wxCommandEvent& event )
00177 \{
00178     progressBar->SetValue(0);
00179     DebugMode->SetValue(\textcolor{keyword}{false});
00180     \textcolor{keywordtype}{int} mode = rgrMode->GetSelection() + 1;
00181     m_iMode0 = mode & 0x01;
00182     m_iMode1 = (mode >> 1) & 0x01;
00183 
00184     \textcolor{keywordflow}{if} (chkReset->IsChecked())
00185     \{
00186         wxMessageBox(\_(\textcolor{stringliteral}{"Turn off reset."}));
00187         \textcolor{keywordflow}{return};
00188     \}
00189 
00190 
00191     \textcolor{keywordflow}{if} (mThreadWorking)
00192         \textcolor{keywordflow}{return};
00193     Disable();
00194     progressBar->SetValue(0);
00195     progressPooler->Start(200);
00196     Connect(ID_PROGRAMING_FINISH_EVENT, wxEVT\_THREAD, wxThreadEventHandler(
      lms7002_pnlMCU_BD_view::OnProgrammingfinished), NULL, \textcolor{keyword}{this});
00197     Connect(ID_PROGRAMING_STATUS_EVENT, wxEVT\_COMMAND\_THREAD, (wxObjectEventFunction)&
      lms7002_pnlMCU_BD_view::OnProgramingStatusUpdate);
00198     obj_ptr = \textcolor{keyword}{this};
00199     mThreadWorking = \textcolor{keyword}{true};
00200     mWorkerThread = std::thread([](lms7002_pnlMCU_BD_view* pthis, \textcolor{keywordtype}{char} mode1, \textcolor{keywordtype}{char} mode0)
00201     \{
00202         \textcolor{keywordtype}{int} retval=0;
00203 
00204         \textcolor{keywordflow}{if} (mode0 == 1 && mode1 == 0)
00205             retval = LMS_Program(pthis->lmsControl, (\textcolor{keyword}{const} \textcolor{keywordtype}{char}*)pthis->
      byte_array, max_array_size, lime::program_mode::mcuEEPROM, OnProgrammingCallback);
00206         \textcolor{keywordflow}{else} if (mode0 == 0 && mode1 == 1)
00207             retval = LMS_Program(pthis->lmsControl, (\textcolor{keyword}{const} \textcolor{keywordtype}{char}*)pthis->
      byte_array, max_array_size, lime::program_mode::mcuRAM, OnProgrammingCallback);
00208         \textcolor{keywordflow}{else}
00209             retval = LMS_Program(pthis->lmsControl, (\textcolor{keyword}{const} \textcolor{keywordtype}{char}*)pthis->
      byte_array, max_array_size, lime::program_mode::mcuReset, OnProgrammingCallback);
00210 
00211         wxThreadEvent *evt = \textcolor{keyword}{new} wxThreadEvent();
00212         evt->SetInt(retval);
00213         evt->SetId(ID_PROGRAMING_FINISH_EVENT);
00214         wxQueueEvent(pthis, evt);
00215     \}, \textcolor{keyword}{this}, m_iMode1, m_iMode0);
00216 \}
00217 
00218 \textcolor{keywordtype}{void} lms7002_pnlMCU_BD_view::OnbtnLoadTestFileClick( wxCommandEvent& event )
00219 \{
00220     \textcolor{keywordtype}{int}  test\_code = 0;
00221     \textcolor{keywordtype}{int}  address = 0;
00222     \textcolor{keywordtype}{int}  value = 0;
00223     \textcolor{keywordtype}{int} i = 0;
00224     \textcolor{comment}{//int temp;}
00225     wxFileDialog dlg(\textcolor{keyword}{this}, \_(\textcolor{stringliteral}{"Open txt file"}), \_(\textcolor{stringliteral}{"txt"}), \_(\textcolor{stringliteral}{"*.txt"}), \_(\textcolor{stringliteral}{"TXT Files (*.txt)|*.txt|TXT Files
       (*.txt)|*.txt |All Files (*.*)|*.*||"}), wxFD\_OPEN | wxFD\_FILE\_MUST\_EXIST);
00226     \textcolor{keywordflow}{if} (dlg.ShowModal() == wxID\_CANCEL)
00227         \textcolor{keywordflow}{return};
00228 
00229     wxString m\_sTxtFileName = dlg.GetPath();
00230     wxString temps;
00231     temps = \_(\textcolor{stringliteral}{"Test results file: "});
00232     temps = temps + m\_sTxtFileName;
00233     lblTestResultsFile->SetLabel(temps);
00234 
00235     FILE * inFile = NULL;
00236     inFile = fopen(m\_sTxtFileName.mb\_str(), \textcolor{stringliteral}{"r"});
00237 
00238     \textcolor{comment}{// debugging}
00239     \textcolor{comment}{//FILE * outFile=NULL;}
00240     \textcolor{comment}{//outFile = fopen("Out.txt", "w");}
00241     \textcolor{comment}{// end debugging}
00242     \textcolor{keywordflow}{if} (inFile != NULL)
00243     \{
00244         m_iTestResultFileLine = 0;
00245         \textcolor{keywordflow}{for} (i = 0; i<256; i++)
00246         \{
00247             TestResultArray_code[i] = 0;
00248             TestResultArray_address[i] = 0;
00249             TestResultArray_value[i] = 0;
00250         \}
00251 
00252         m_iTestResultFileLine = 0;
00253         fscanf(inFile, \textcolor{stringliteral}{"%d"}, &test\_code);
00254         \textcolor{keywordflow}{while} (!feof(inFile))
00255         \{
00256             \textcolor{comment}{//fscanf(inFile, "%d %d %d", &test\_code, &address, &value);}
00257             fscanf(inFile, \textcolor{stringliteral}{"%d "}, &address);
00258             fscanf(inFile, \textcolor{stringliteral}{"%d\(\backslash\)n"}, &value);
00259             TestResultArray_code[m_iTestResultFileLine] = (\textcolor{keywordtype}{unsigned} char)(test\_code);
00260             TestResultArray_address[m_iTestResultFileLine] = (\textcolor{keywordtype}{unsigned} char)(address);
00261             TestResultArray_value[m_iTestResultFileLine] = (\textcolor{keywordtype}{unsigned} char)(value);
00262 
00263             m_iTestResultFileLine++;
00264             fscanf(inFile, \textcolor{stringliteral}{"%d"}, &test\_code);
00265         \}
00266     \}
00267     fclose(inFile);
00268 
00269     \textcolor{comment}{// debugging}
00270     \textcolor{comment}{//for (i=0; i<m\_iTestResultFileLine; i++) \{}
00271     \textcolor{comment}{//  fprintf(outFile, "%d %d %d \(\backslash\)n",}
00272     \textcolor{comment}{//          TestResultArray\_code[i],}
00273     \textcolor{comment}{//          TestResultArray\_address[i],}
00274     \textcolor{comment}{//          TestResultArray\_value[i]);}
00275     \textcolor{comment}{//\}}
00276     \textcolor{comment}{// fclose(outFile);}
00277     \textcolor{comment}{// end debugging}
00278 
00279 \}
00280 
00281 \textcolor{keywordtype}{void} lms7002_pnlMCU_BD_view::Wait_CLK_Cycles(\textcolor{keywordtype}{int} delay)
00282 \{
00284     \textcolor{keywordtype}{int} i=0;
00285     uint16\_t val;
00286     \textcolor{keywordflow}{for} (i=0;i<(delay/64);i++)
00287        LMS_ReadLMSReg(lmsControl,0x0003,&val);
00288 \}
00289 
00290 \textcolor{keywordtype}{void} lms7002_pnlMCU_BD_view::RunTest_MCU(\textcolor{keywordtype}{int} m_iMode1, \textcolor{keywordtype}{int} m_iMode0, \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} test\_code, \textcolor{keywordtype}{int} 
      m_iDebug) \{
00291 
00292     \textcolor{keywordtype}{int} i=0;
00293     \textcolor{keywordtype}{int} limit=0;
00294     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} tempi=0x0000;
00295     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} basei=0x0000;
00296 
00297     \textcolor{keywordflow}{if}  (test\_code<=15) basei=(test\_code<<4);
00298     \textcolor{keywordflow}{else} basei=0x0000;
00299 
00300     basei=basei&0xFFF0; \textcolor{comment}{// not necessery}
00301     \textcolor{comment}{// 4 LSBs are zeros}
00302 
00303     \textcolor{comment}{// variable basei contains test no. value at bit positions 7-4}
00304     \textcolor{comment}{// used for driving the P0 input}
00305     \textcolor{comment}{// P0 defines the test no.}
00306 
00307     \textcolor{keywordflow}{if} ((test\_code>7)||(test\_code==0))
00308         limit=1;
00309     \textcolor{keywordflow}{else}
00310         limit=50;
00311 
00312     \textcolor{comment}{// tests 8 to 14 have short duration}
00313 
00314     \textcolor{keywordflow}{if} (m\_iDebug==1) \textcolor{keywordflow}{return}; \textcolor{comment}{// normal MCU operating mode required}
00315 
00316     \textcolor{comment}{// EXT\_INT2=1, external interrupt 2 is raised}
00317     tempi=0x0000;  \textcolor{comment}{// changed}
00318     \textcolor{keywordtype}{int} m\_iExt2=1;
00319 
00320     \textcolor{keywordflow}{if} (m\_iExt2==1)  tempi=tempi|0x0004;
00321     \textcolor{keywordflow}{if} (m\_iMode1==1) tempi=tempi|0x0002;
00322     \textcolor{keywordflow}{if} (m\_iMode0==1) tempi=tempi|0x0001;
00323 
00324     \textcolor{comment}{// tempi variable is driving the mspi\_REG2}
00325 
00326     LMS_WriteLMSReg(lmsControl,0x8002,tempi);\textcolor{comment}{// REG2 write}
00327 
00328     \textcolor{comment}{// generating waveform}
00329     \textcolor{keywordflow}{for} (i=0; i<=limit; i++)
00330     \{
00331         tempi=basei|0x000C;
00332                 LMS_WriteLMSReg(lmsControl,0x8000,tempi);
00333         \textcolor{comment}{// REG0 write}
00334         Wait_CLK_Cycles(256);
00335                 tempi=basei|0x000D;
00336                 LMS_WriteLMSReg(lmsControl,0x8000,tempi);
00337         \textcolor{comment}{// REG0 write  - P0(0) set}
00338         Wait_CLK_Cycles(256);
00339         tempi=basei|0x000C;
00340         LMS_WriteLMSReg(lmsControl,0x8000,tempi);
00341         \textcolor{comment}{// REG0 write}
00342         Wait_CLK_Cycles(256);
00343         tempi=basei|0x000E;
00344         LMS_WriteLMSReg(lmsControl,0x8000,tempi);
00345         \textcolor{comment}{// REG0 write - PO(1) set}
00346         Wait_CLK_Cycles(256);
00347 
00348         \textcolor{keywordflow}{if} (i==0) \{
00349             \textcolor{comment}{// EXT\_INT2=0}
00350             \textcolor{comment}{// external interrupt 2 is pulled down}
00351             tempi=0x0000; \textcolor{comment}{// changed}
00352             m\_iExt2=0;
00353             \textcolor{keywordflow}{if} (m\_iExt2==1)  tempi=tempi|0x0004;
00354             \textcolor{keywordflow}{if} (m\_iMode1==1) tempi=tempi|0x0002;
00355             \textcolor{keywordflow}{if} (m\_iMode0==1) tempi=tempi|0x0001;
00356             LMS_WriteLMSReg(lmsControl,0x8002,tempi);
00357             \textcolor{comment}{// REG2 write}
00358         \}
00359     \}
00360 \}
00361 
00362 \textcolor{keywordtype}{void} lms7002_pnlMCU_BD_view::DebugModeSet_MCU(\textcolor{keywordtype}{int} m_iMode1, \textcolor{keywordtype}{int} m_iMode0)
00363 \{
00364         \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} tempi=0x00C0;
00365         \textcolor{comment}{// bit DEBUG is set}
00366         \textcolor{keywordtype}{int} m\_iExt2=0;
00367         \textcolor{keywordflow}{if} (m\_iExt2==1)  tempi=tempi|0x0004;
00368         \textcolor{keywordflow}{if} (m\_iMode1==1) tempi=tempi|0x0002;
00369         \textcolor{keywordflow}{if} (m\_iMode0==1) tempi=tempi|0x0001;
00370 
00371         \textcolor{comment}{// Select debug mode}
00372         LMS_WriteLMSReg(lmsControl,0x8002,tempi);
00373         \textcolor{comment}{// REG2 write}
00374 \}
00375 
00376  \textcolor{keywordtype}{void} lms7002_pnlMCU_BD_view::DebugModeExit_MCU(\textcolor{keywordtype}{int} m_iMode1, \textcolor{keywordtype}{int} m_iMode0)
00377 \{
00378 
00379         \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} tempi=0x0000; \textcolor{comment}{// bit DEBUG is zero}
00380         \textcolor{keywordtype}{int} m\_iExt2=0;
00381 
00382         \textcolor{keywordflow}{if} (m\_iExt2==1)  tempi=tempi|0x0004;
00383         \textcolor{keywordflow}{if} (m\_iMode1==1) tempi=tempi|0x0002;
00384         \textcolor{keywordflow}{if} (m\_iMode0==1) tempi=tempi|0x0001;
00385         \textcolor{comment}{// To run mode}
00386         LMS_WriteLMSReg(lmsControl,0x8002,tempi);  \textcolor{comment}{// REG2 write}
00387 \}
00388 
00389  \textcolor{keywordtype}{int} lms7002_pnlMCU_BD_view::WaitUntilWritten()\{
00390 
00391      \textcolor{comment}{// waits if WRITE\_REQ (REG3[2]) flag is equal to '1'}
00392      \textcolor{comment}{// this means that  write operation is in progress}
00393     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} tempi=0x0000;
00394     \textcolor{keywordtype}{int} countDown=m_iLoopTries;  \textcolor{comment}{// Time out value}
00395     LMS_ReadLMSReg(lmsControl,0x0003,&tempi); \textcolor{comment}{// REG3 read}
00396 
00397     \textcolor{keywordflow}{while} (( (tempi&0x0004) == 0x0004) && (countDown>0))
00398     \{
00399         LMS_ReadLMSReg(lmsControl,0x0003,&tempi); \textcolor{comment}{// REG3 read}
00400         countDown--;
00401     \}
00402     \textcolor{keywordflow}{if} (countDown==0)
00403         \textcolor{keywordflow}{return} -1; \textcolor{comment}{// an error occured, timer elapsed}
00404     \textcolor{keywordflow}{else}
00405         \textcolor{keywordflow}{return} 0; \textcolor{comment}{// Finished regularly}
00406     \textcolor{comment}{// pass if WRITE\_REQ is '0'}
00407 \}
00408 
00409  \textcolor{keywordtype}{int} lms7002_pnlMCU_BD_view::ReadOneByte(\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} * data)
00410 \{
00411     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} tempi=0x0000;
00412     \textcolor{keywordtype}{int} countDown=m_iLoopTries;
00413 
00414      \textcolor{comment}{// waits when READ\_REQ (REG3[3]) flag is equal to '0'}
00415      \textcolor{comment}{// this means that there is nothing to read}
00416     LMS_ReadLMSReg(lmsControl,0x0003,&tempi); \textcolor{comment}{// REG3 read}
00417 
00418     \textcolor{keywordflow}{while} (((tempi&0x0008)==0x0000) && (countDown>0))
00419     \{
00420         \textcolor{comment}{// wait if READ\_REQ is '0'}
00421         LMS_ReadLMSReg(lmsControl,0x0003,&tempi); \textcolor{comment}{// REG3 read}
00422         countDown--;
00423     \}
00424 
00425     \textcolor{keywordflow}{if} (countDown>0)
00426     \{ \textcolor{comment}{// Time out has not occured}
00427         LMS_ReadLMSReg(lmsControl,0x0005,&tempi);; \textcolor{comment}{// REG5 read}
00428         \textcolor{comment}{// return the read byte}
00429         (*data) = (\textcolor{keywordtype}{unsigned} char) (tempi);
00430     \}
00431     \textcolor{keywordflow}{else}
00432         (* data) =0;
00433      \textcolor{comment}{// return the zero, default value}
00434 
00435     \textcolor{keywordflow}{if} (countDown==0)
00436         \textcolor{keywordflow}{return} -1; \textcolor{comment}{// an error occured}
00437     \textcolor{keywordflow}{else}
00438         \textcolor{keywordflow}{return} 0; \textcolor{comment}{// finished regularly}
00439 \}
00440 
00441 \textcolor{keywordtype}{int} lms7002_pnlMCU_BD_view::One_byte_command(\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} data1, \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} * rdata1)
00442 \{
00443     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} tempc=0x00;
00444     \textcolor{keywordtype}{int} retval=0;
00445     *rdata1=0x00; \textcolor{comment}{//default return value}
00446 
00447     \textcolor{comment}{// sends the one byte command}
00448         LMS_WriteLMSReg(lmsControl,0x8004,data1); \textcolor{comment}{//REG4 write}
00449     retval=WaitUntilWritten();
00450     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00451     \textcolor{comment}{// error if operation executes too long}
00452 
00453     \textcolor{comment}{// gets the one byte answer}
00454     retval=ReadOneByte(&tempc);
00455     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00456     \textcolor{comment}{// error if operation takes too long}
00457 
00458     *rdata1=tempc;
00459     \textcolor{keywordflow}{return} 0;
00460 \}
00461 
00462 \textcolor{keywordtype}{int} lms7002_pnlMCU_BD_view::ResetPC_MCU()
00463 \{
00464     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} tempc1=0x00;
00465     \textcolor{keywordtype}{int} retval=0;
00466     retval=One_byte_command(0x70, &tempc1);
00467     \textcolor{keywordflow}{return} retval;
00468 \}
00469 
00470 \textcolor{keywordtype}{int} lms7002_pnlMCU_BD_view::Three_byte_command(
00471         \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} data1,\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} data2,\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} data3,
00472         \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} * rdata1,\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} * rdata2,\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} * rdata3)\{
00473 
00474 
00475     \textcolor{keywordtype}{int} retval=0;
00476     *rdata1=0x00;
00477     *rdata2=0x00;
00478     *rdata3=0x00;
00479 
00480     LMS_WriteLMSReg(lmsControl,0x8004,(\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short})data1);
00481     retval=WaitUntilWritten();
00482     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00483     LMS_WriteLMSReg(lmsControl,0x8004,(\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short})data2); \textcolor{comment}{//REG4 write}
00484     retval=WaitUntilWritten();
00485     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00486 
00487     LMS_WriteLMSReg(lmsControl,0x8004,(\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short})data3); \textcolor{comment}{//REG4 write}
00488     retval=WaitUntilWritten();
00489     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00490 
00491     retval= ReadOneByte(rdata1);
00492     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00493 
00494     retval= ReadOneByte(rdata2);
00495     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00496 
00497     retval= ReadOneByte(rdata3);
00498     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00499 
00500     \textcolor{keywordflow}{return} 0;
00501 \}
00502 
00503 \textcolor{keywordtype}{int} lms7002_pnlMCU_BD_view::RunInstr_MCU(\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} * pPCVAL)
00504 \{
00505     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} tempc1, tempc2, tempc3=0x00;
00506     \textcolor{keywordtype}{int} retval=0;
00507     retval=Three_byte_command(0x74, 0x00, 0x00, &tempc1, &tempc2, &tempc3);
00508     \textcolor{keywordflow}{if} (retval==-1) (*pPCVAL)=0;
00509     \textcolor{keywordflow}{else} (*pPCVAL)=tempc2*256+tempc3;
00510     \textcolor{keywordflow}{return} retval;
00511 \}
00512 
00513 \textcolor{keywordtype}{void} lms7002_pnlMCU_BD_view::OnbtnRunTestClick( wxCommandEvent& event )
00514 \{
00515     wxString m\_sTxtFileName = \_(\textcolor{stringliteral}{"lms7suite\_mcu/TestResults.txt"});
00516     lblTestResultsFile->SetLabel(\textcolor{stringliteral}{"Test results file: "} + m\_sTxtFileName);
00517 
00518     FILE * inFile = NULL;
00519     inFile = fopen(m\_sTxtFileName.mb\_str(), \textcolor{stringliteral}{"r"});
00520 
00521     \textcolor{keywordflow}{if} (inFile != NULL)
00522     \{
00523         m_iTestResultFileLine = 0;
00524         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 256; i++)
00525         \{
00526             TestResultArray_code[i] = 0;
00527             TestResultArray_address[i] = 0;
00528             TestResultArray_value[i] = 0;
00529         \}
00530 
00531         m_iTestResultFileLine = 0;
00532         \textcolor{keywordtype}{int}  test\_code = 0;
00533         \textcolor{keywordtype}{int}  address = 0;
00534         \textcolor{keywordtype}{int}  value = 0;
00535         fscanf(inFile, \textcolor{stringliteral}{"%d"}, &test\_code);
00536         \textcolor{keywordflow}{while} (!feof(inFile))
00537         \{
00538             fscanf(inFile, \textcolor{stringliteral}{"%d "}, &address);
00539             fscanf(inFile, \textcolor{stringliteral}{"%d\(\backslash\)n"}, &value);
00540             TestResultArray_code[m_iTestResultFileLine] = (\textcolor{keywordtype}{unsigned} char)(test\_code);
00541             TestResultArray_address[m_iTestResultFileLine] = (\textcolor{keywordtype}{unsigned} char)(address);
00542             TestResultArray_value[m_iTestResultFileLine] = (\textcolor{keywordtype}{unsigned} char)(value);
00543 
00544             m_iTestResultFileLine++;
00545             fscanf(inFile, \textcolor{stringliteral}{"%d"}, &test\_code);
00546         \}
00547     \}
00548     \textcolor{keywordflow}{else}
00549     \{
00550         wxMessageBox(\_(\textcolor{stringliteral}{"lms7suite\_mcu/TestResults.txt file not found"}));
00551         \textcolor{keywordflow}{return};
00552     \}
00553     fclose(inFile);
00554 
00555     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} tempc1, tempc2, tempc3 = 0x00;
00556     \textcolor{keywordtype}{int} retval = 0;
00557     \textcolor{keywordtype}{int} m\_iError = 0;
00558     \textcolor{keywordtype}{int} i = 0;
00559 
00560     \textcolor{keywordflow}{if} ((m_iTestNo <= 0) || (m_iTestNo>15))
00561     \{
00562         m_iTestNo = 0;
00563         m_sTestNo->SetValue(\_(\textcolor{stringliteral}{"0"}));
00564     \}
00565     \textcolor{keywordflow}{else}
00566     \{
00567         RunTest_MCU(m_iMode1, m_iMode0, m_iTestNo, m_iDebug);
00568     \}
00569 
00570     \textcolor{comment}{// check the results}
00571     \textcolor{keywordflow}{if} (m_iDebug == 0)
00572         DebugModeSet_MCU(m_iMode1, m_iMode0);
00573     \textcolor{comment}{// Go to Debug mode}
00574     m\_iError = 0;
00575     i = 0;
00576     \textcolor{keywordflow}{while} ((i<m_iTestResultFileLine) && (m\_iError == 0))
00577     \{
00578         \textcolor{keywordflow}{if} (TestResultArray_code[i] == m_iTestNo) \{
00579             retval = Three_byte_command(0x78, (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char})(
      TestResultArray_address[i]), 0x00, &tempc1, &tempc2, &tempc3);
00580             \textcolor{keywordflow}{if} ((retval == -1) || (tempc3 != TestResultArray_value[i])) m\_iError = 1;
00581             \textcolor{keywordflow}{else} i++;
00582         \}
00583         \textcolor{keywordflow}{else} i++;
00584     \};
00585     \textcolor{comment}{//exit the debug mode}
00586     DebugModeExit_MCU(m_iMode1, m_iMode0);
00587 
00588     wxString temps, temps1, temps2, temps3;
00589     \textcolor{keywordflow}{if} (m\_iError == 1)
00590     \{
00591         temps1 = wxString::Format(\_(\textcolor{stringliteral}{"0x%02X"}), TestResultArray_address[i]);
00592         temps2 = wxString::Format(\_(\textcolor{stringliteral}{"0x%02X"}), TestResultArray_value[i]);
00593         temps3 = wxString::Format(\_(\textcolor{stringliteral}{"0x%02X"}), tempc3);
00594 
00595         temps = \_(\textcolor{stringliteral}{"Test failed. No.:"});
00596         temps = temps << TestResultArray_code[i];
00597         temps = temps << \_(\textcolor{stringliteral}{", at address "}) << temps1;
00598         temps = temps << \_(\textcolor{stringliteral}{", should be "}) << temps2;
00599         temps = temps << \_(\textcolor{stringliteral}{", but is read "}) << temps3;
00600     \}
00601     \textcolor{keywordflow}{else}
00602         temps = \_(\textcolor{stringliteral}{"OK"});
00603     wxMessageBox(temps);
00604     \textcolor{keywordflow}{return};
00605 
00606 \}
00607 
00608 \textcolor{keywordtype}{void} lms7002_pnlMCU_BD_view::OnDebugModeClick( wxCommandEvent& event )
00609 \{
00610     \textcolor{keywordflow}{if} (DebugMode->IsChecked())
00611     \{
00612         RunInstr->Enable(\textcolor{keyword}{true});
00613         ResetPC->Enable(\textcolor{keyword}{true});
00614         InstrNo->Enable(\textcolor{keyword}{true});
00615         ViewSFRs->Enable(\textcolor{keyword}{true});
00616         ViewIRAM->Enable(\textcolor{keyword}{true});
00617         EraseIRAM->Enable(\textcolor{keyword}{true});
00618         SelDiv->Enable(\textcolor{keyword}{true});
00619 
00620         m_iDebug = 1;
00621         DebugModeSet_MCU(m_iMode1, m_iMode0);
00622     \}
00623     \textcolor{keywordflow}{else}
00624     \{
00625         RunInstr->Enable(\textcolor{keyword}{false});
00626         ResetPC->Enable(\textcolor{keyword}{false});
00627         InstrNo->Enable(\textcolor{keyword}{false});
00628         ViewSFRs->Enable(\textcolor{keyword}{false});
00629         ViewIRAM->Enable(\textcolor{keyword}{false});
00630         EraseIRAM->Enable(\textcolor{keyword}{false});
00631         SelDiv->Enable(\textcolor{keyword}{false});
00632 
00633         m_iDebug = 0;
00634         DebugModeExit_MCU(m_iMode1, m_iMode0);
00635     \}
00636 \}
00637 
00638 \textcolor{keywordtype}{void} lms7002_pnlMCU_BD_view::OnRunInstruction( wxCommandEvent& event )
00639 \{
00640     wxString m\_sPCVal;
00641     \textcolor{keywordtype}{int} i = 0;
00642     \textcolor{keywordtype}{int} retval = 0;
00643     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} m\_iPC = 0;
00644 
00645     \textcolor{keywordflow}{if} ((m_iInstrNo <1) || (m_iInstrNo>100))
00646     \{
00647         m_iInstrNo = 0; \textcolor{comment}{// default TestNo.}
00648         InstrNo->SetValue(\_(\textcolor{stringliteral}{"0"}));
00649         wxMessageBox(\_(\textcolor{stringliteral}{"Number of instructions must be in the range [1-100]!"}));
00650     \}
00651     \textcolor{keywordflow}{else}
00652     \{
00653         \textcolor{keywordflow}{for} (i = 0; i<m_iInstrNo; i++)
00654         \{
00655             retval = RunInstr_MCU(&m\_iPC);
00656             \textcolor{keywordflow}{if} (retval == -1)
00657             \{
00658                 i = m_iInstrNo; \textcolor{comment}{// end loop}
00659                 m_iPCvalue = 0;
00660             \}
00661             \textcolor{keywordflow}{else}
00662             \{
00663                 m_iPCvalue = m\_iPC;
00664             \}
00665         \}
00666         m\_sPCVal.Printf(\_(\textcolor{stringliteral}{"0x%04X"}), m_iPCvalue);
00667         PCValue->SetLabel(m\_sPCVal);
00668     \}
00669 \}
00670 
00671 \textcolor{keywordtype}{void} lms7002_pnlMCU_BD_view::OnResetPCClick( wxCommandEvent& event )
00672 \{
00673     \textcolor{keywordtype}{int} retval = ResetPC_MCU();
00674     \textcolor{keywordflow}{if} (retval == -1)
00675         wxMessageBox(\_(\textcolor{stringliteral}{"Unable to reset MCU's Program Counter"}));
00676 \}
00677 
00678 \textcolor{keywordtype}{int} lms7002_pnlMCU_BD_view::Read_SFR()
00679 \{
00680     \textcolor{keywordtype}{int} i=0;
00681     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} tempc1, tempc2, tempc3=0x00;
00682     \textcolor{keywordtype}{int} retval=0;
00683 
00684     \textcolor{comment}{//default m\_SFR array initialization}
00685     \textcolor{keywordflow}{for} (i=0; i<=255; i++)
00686         m_SFR[i]=0x00;
00687         OnProgrammingCallback(0, 48, \textcolor{stringliteral}{""});
00688     \textcolor{comment}{// code 0x7A is for reading the SFR registers}
00689     retval=Three_byte_command(0x7A, 0x80, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// P0}
00690     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00691     m_SFR[0x80]=tempc3;
00692 
00693     retval=Three_byte_command(0x7A, 0x81, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// SP}
00694     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00695     m_SFR[0x81]=tempc3;
00696 
00697     retval=Three_byte_command(0x7A, 0x82, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// DPL0}
00698     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00699     m_SFR[0x82]=tempc3;
00700 
00701     retval=Three_byte_command(0x7A, 0x83, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// DPH0}
00702     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00703     m_SFR[0x83]=tempc3;
00704 
00705     retval=Three_byte_command(0x7A, 0x84, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// DPL1}
00706     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00707     m_SFR[0x84]=tempc3;
00708 
00709     retval=Three_byte_command(0x7A, 0x85, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// DPH1}
00710     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00711     m_SFR[0x85]=tempc3;
00712         OnProgrammingCallback(6, 48, \textcolor{stringliteral}{""});
00713 
00714     retval=Three_byte_command(0x7A, 0x86, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// DPS}
00715     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00716     m_SFR[0x86]=tempc3;
00717 
00718     retval=Three_byte_command(0x7A, 0x87, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// PCON}
00719     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00720     m_SFR[0x87]=tempc3;
00721 
00722     retval=Three_byte_command(0x7A, 0x88, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// TCON}
00723     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00724     m_SFR[0x88]=tempc3;
00725 
00726     retval=Three_byte_command(0x7A, 0x89, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// TMOD}
00727     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00728     m_SFR[0x89]=tempc3;
00729 
00730     retval=Three_byte_command(0x7A, 0x8A, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// TL0}
00731     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00732     m_SFR[0x8A]=tempc3;
00733 
00734     retval=Three_byte_command(0x7A, 0x8B, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// TL1}
00735     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00736     m_SFR[0x8B]=tempc3;
00737         OnProgrammingCallback(12, 48, \textcolor{stringliteral}{""});
00738 
00739     retval=Three_byte_command(0x7A, 0x8C, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// TH0}
00740     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00741     m_SFR[0x8C]=tempc3;
00742 
00743     retval=Three_byte_command(0x7A, 0x8D, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// TH1}
00744     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00745         m_SFR[0x8D]=tempc3;
00746 
00747     retval=Three_byte_command(0x7A, 0x8E, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// PMSR}
00748     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00749     m_SFR[0x8E]=tempc3;
00750 
00751     retval=Three_byte_command(0x7A, 0x90, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// P1}
00752     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00753     m_SFR[0x90]=tempc3;
00754 
00755     retval=Three_byte_command(0x7A, 0x91, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// DIR1}
00756     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00757     m_SFR[0x91]=tempc3;
00758 
00759     retval=Three_byte_command(0x7A, 0x98, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// SCON}
00760     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00761     m_SFR[0x98]=tempc3;
00762         OnProgrammingCallback(18, 48, \textcolor{stringliteral}{""});
00763 
00764     retval=Three_byte_command(0x7A, 0x99, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// SBUF}
00765     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00766     m_SFR[0x99]=tempc3;
00767 
00768     retval=Three_byte_command(0x7A, 0xA0, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// P2}
00769     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00770     m_SFR[0xA0]=tempc3;
00771 
00772     retval=Three_byte_command(0x7A, 0xA1, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// DIR2}
00773     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00774     m_SFR[0xA1]=tempc3;
00775 
00776     retval=Three_byte_command(0x7A, 0xA2, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// DIR0}
00777     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00778     m_SFR[0xA2]=tempc3;
00779 
00780     retval=Three_byte_command(0x7A, 0xA8, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// IEN0}
00781     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00782     m_SFR[0xA8]=tempc3;
00783 
00784     retval=Three_byte_command(0x7A, 0xA9, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// IEN1}
00785     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00786     m_SFR[0xA9]=tempc3;
00787         OnProgrammingCallback(24, 48, \textcolor{stringliteral}{""});
00788 
00789     retval=Three_byte_command(0x7A, 0xB0, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// EECTRL}
00790     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00791         m_SFR[0xB0]=tempc3;
00792 
00793     retval=Three_byte_command(0x7A, 0xB1, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// EEDATA}
00794     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00795     m_SFR[0xB1]=tempc3;
00796 
00797     retval=Three_byte_command(0x7A, 0xB8, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// IP0}
00798     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00799     m_SFR[0xB8]=tempc3;
00800 
00801     retval=Three_byte_command(0x7A, 0xB9, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// IP1}
00802     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00803     m_SFR[0xB9]=tempc3;
00804 
00805     retval=Three_byte_command(0x7A, 0xBF, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// USR2}
00806     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00807     m_SFR[0xBF]=tempc3;
00808 
00809     retval=Three_byte_command(0x7A, 0xC0, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// IRCON}
00810     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00811     m_SFR[0xC0]=tempc3;
00812         OnProgrammingCallback(30, 48, \textcolor{stringliteral}{""});
00813 
00814     retval=Three_byte_command(0x7A, 0xC8, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// T2CON}
00815     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00816     m_SFR[0xC8]=tempc3;
00817 
00818     retval=Three_byte_command(0x7A, 0xCA, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// RCAP2L}
00819     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00820     m_SFR[0xCA]=tempc3;
00821 
00822     retval=Three_byte_command(0x7A, 0xCB, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// RCAP2H}
00823     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00824     m_SFR[0xCB]=tempc3;
00825 
00826     retval=Three_byte_command(0x7A, 0xCC, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// TL2}
00827     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00828     m_SFR[0xCC]=tempc3;
00829 
00830     retval=Three_byte_command(0x7A, 0xCD, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// TH2}
00831     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00832     m_SFR[0xCD]=tempc3;
00833 
00834     retval=Three_byte_command(0x7A, 0xD0, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// PSW}
00835     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00836         m_SFR[0xD0]=tempc3;
00837         OnProgrammingCallback(36, 48, \textcolor{stringliteral}{""});
00838 
00839     retval=Three_byte_command(0x7A, 0xE0, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// ACC}
00840     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00841         m_SFR[0xE0]=tempc3;
00842 
00843     retval=Three_byte_command(0x7A, 0xF0, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// B}
00844     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00845     m_SFR[0xF0]=tempc3;
00846 
00847     retval=Three_byte_command(0x7A, 0xEC, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// REG0}
00848     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00849         m_SFR[0xEC]=tempc3;
00850 
00851     retval=Three_byte_command(0x7A, 0xED, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// REG1}
00852     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00853     m_SFR[0xED]=tempc3;
00854 
00855     retval=Three_byte_command(0x7A, 0xEE, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// REG2}
00856     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00857     m_SFR[0xEE]=tempc3;
00858 
00859     retval=Three_byte_command(0x7A, 0xEF, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// REG3}
00860     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00861     m_SFR[0xEF]=tempc3;
00862         OnProgrammingCallback(42, 48, \textcolor{stringliteral}{""});
00863     retval=Three_byte_command(0x7A, 0xF4, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// REG4}
00864     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00865     m_SFR[0xF4]=tempc3;
00866 
00867     retval=Three_byte_command(0x7A, 0xF5, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// REG5}
00868     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00869     m_SFR[0xF5]=tempc3;
00870 
00871     retval=Three_byte_command(0x7A, 0xF6, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// REG6}
00872     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00873     m_SFR[0xF6]=tempc3;
00874 
00875     retval=Three_byte_command(0x7A, 0xF7, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// REG7}
00876     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00877     m_SFR[0xF7]=tempc3;
00878 
00879     retval=Three_byte_command(0x7A, 0xFC, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// REG8}
00880     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00881     m_SFR[0xFC]=tempc3;
00882 
00883     retval=Three_byte_command(0x7A, 0xFD, 0x00, &tempc1, &tempc2, &tempc3); \textcolor{comment}{// REG9}
00884     \textcolor{keywordflow}{if} (retval==-1) \textcolor{keywordflow}{return} -1;
00885     m_SFR[0xFD]=tempc3;
00886         OnProgrammingCallback(48, 48, \textcolor{stringliteral}{""});
00887     \textcolor{keywordflow}{return} 0;
00888 \}
00889 
00890 \textcolor{keywordtype}{void} lms7002_pnlMCU_BD_view::OnViewSFRsClick( wxCommandEvent& event )
00891 \{
00892     \textcolor{keywordflow}{if} (mThreadWorking)
00893         \textcolor{keywordflow}{return};
00894     Disable();
00895     progressBar->SetValue(0);
00896     progressPooler->Start(200);
00897 
00898     Connect(ID_PROGRAMING_STATUS_EVENT, wxEVT\_COMMAND\_THREAD, (wxObjectEventFunction)&
      lms7002_pnlMCU_BD_view::OnProgramingStatusUpdate);
00899     Connect(ID_PROGRAMING_FINISH_EVENT, wxEVT\_THREAD, wxThreadEventHandler(
      lms7002_pnlMCU_BD_view::OnReadSFRfinished), NULL, \textcolor{keyword}{this});
00900 
00901     mThreadWorking = \textcolor{keyword}{true};
00902     mWorkerThread = std::thread([](lms7002_pnlMCU_BD_view* pthis)
00903     \{
00904         \textcolor{keywordtype}{int} retval = pthis->Read_SFR();
00905         wxThreadEvent *evt = \textcolor{keyword}{new} wxThreadEvent();
00906         evt->SetInt(retval);
00907         evt->SetId(ID_PROGRAMING_FINISH_EVENT);
00908         wxQueueEvent(pthis, evt);
00909     \}, \textcolor{keyword}{this});
00910 \}
00911 
00912 \textcolor{keywordtype}{int} lms7002_pnlMCU_BD_view::Read_IRAM()
00913 \{
00914     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} tempc1, tempc2, tempc3=0x00;
00915     \textcolor{keywordtype}{int} i=0;
00916     \textcolor{keywordtype}{int} retval=0;
00917 
00918     \textcolor{comment}{//default}
00919     \textcolor{comment}{//IRAM array initialization}
00920     \textcolor{keywordflow}{for} (i=0; i<=255; i++)
00921             m_IRAM[i]=0x00;
00922 
00923     \textcolor{keywordtype}{unsigned} stepsDone=0;
00924     OnProgrammingCallback(stepsDone, 256, \textcolor{stringliteral}{""});
00925     \textcolor{keywordflow}{for} (i=0; i<=255; i++)
00926     \{
00927         \textcolor{comment}{// code 0x78 is for reading the IRAM locations}
00928         retval=Three_byte_command(0x78, ((\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char})(i)), 0x00,&tempc1, &tempc2, &tempc3);
00929         \textcolor{keywordflow}{if} (retval==0)
00930             m_IRAM[i]=tempc3;
00931         \textcolor{keywordflow}{else}
00932         \{
00933             i=256; \textcolor{comment}{// error, stop}
00934         \}
00935        OnProgrammingCallback(++stepsDone, 256, \textcolor{stringliteral}{""});
00936 \textcolor{preprocessor}{#ifndef NDEBUG}
00937         \textcolor{comment}{//printf("MCU reading IRAM: %2i/256\(\backslash\)r", stepsDone.load());}
00938 \textcolor{preprocessor}{#endif}
00939         Wait_CLK_Cycles(64);
00940     \}
00941 \textcolor{preprocessor}{#ifndef NDEBUG}
00942     printf(\textcolor{stringliteral}{"\(\backslash\)nMCU reading IRAM finished\(\backslash\)n"});
00943 \textcolor{preprocessor}{#endif}
00944     \textcolor{keywordflow}{return} retval;
00945 \}
00946 
00947 \textcolor{keywordtype}{void} lms7002_pnlMCU_BD_view::OnViewIRAMClick( wxCommandEvent& event )
00948 \{
00949     \textcolor{keywordflow}{if} (mThreadWorking)
00950         \textcolor{keywordflow}{return};
00951     Disable();
00952     progressBar->SetValue(0);
00953     progressPooler->Start(200);
00954     Connect(ID_PROGRAMING_FINISH_EVENT, wxEVT\_THREAD, wxThreadEventHandler(
      lms7002_pnlMCU_BD_view::OnReadIRAMfinished), NULL, \textcolor{keyword}{this});
00955     Connect(ID_PROGRAMING_STATUS_EVENT, wxEVT\_COMMAND\_THREAD, (wxObjectEventFunction)&
      lms7002_pnlMCU_BD_view::OnProgramingStatusUpdate);
00956 
00957     mThreadWorking = \textcolor{keyword}{true};
00958     mWorkerThread = std::thread([](lms7002_pnlMCU_BD_view* pthis)
00959         \{
00960             \textcolor{keywordtype}{int} retval = pthis->Read_IRAM();
00961             wxThreadEvent *evt = \textcolor{keyword}{new} wxThreadEvent();
00962             evt->SetInt(retval);
00963             evt->SetId(ID_PROGRAMING_FINISH_EVENT);
00964             wxQueueEvent(pthis, evt);
00965         \}, \textcolor{keyword}{this});
00966 \}
00967 
00968 \textcolor{keywordtype}{int} lms7002_pnlMCU_BD_view::Erase_IRAM()
00969 \{
00970     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} tempc1, tempc2, tempc3=0x00;
00971     \textcolor{keywordtype}{int} retval=0;
00972     \textcolor{keywordtype}{int} i=0;
00973 
00974     \textcolor{comment}{//default ini.}
00975     \textcolor{keywordflow}{for} (i=0; i<=255; i++)
00976             m_IRAM[i]=0x00;
00977 
00978     \textcolor{keywordtype}{unsigned} stepsDone=0;
00979     OnProgrammingCallback(stepsDone, 256, \textcolor{stringliteral}{""});
00980     \textcolor{keywordflow}{for} (i=0; i<=255; i++)
00981     \{
00982             m_IRAM[i]=0x00;
00983             \textcolor{comment}{// code 0x7C is for writing the IRAM locations}
00984             retval=Three_byte_command(0x7C, ((\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char})(i)), 0x00,&tempc1, &tempc2, &tempc3);
00985             \textcolor{keywordflow}{if} (retval == -1)
00986             \{
00987                 i = 256;
00988                 \textcolor{comment}{//aborted.store(true);}
00989             \}
00990             OnProgrammingCallback(++stepsDone, 256, \textcolor{stringliteral}{""});
00991 \textcolor{preprocessor}{#ifndef NDEBUG}
00992             \textcolor{comment}{//printf("MCU erasing IRAM: %2i/256\(\backslash\)r", stepsDone.load());}
00993 \textcolor{preprocessor}{#endif}
00994     \}
00995 \textcolor{preprocessor}{#ifndef NDEBUG}
00996     printf(\textcolor{stringliteral}{"\(\backslash\)nMCU erasing IRAM finished\(\backslash\)n"});
00997 \textcolor{preprocessor}{#endif}
00998     \textcolor{keywordflow}{return} retval;
00999 \}
01000 
01001 \textcolor{keywordtype}{void} lms7002_pnlMCU_BD_view::OnEraseIRAMClick( wxCommandEvent& event )
01002 \{
01003     \textcolor{keywordflow}{if} (mThreadWorking)
01004         \textcolor{keywordflow}{return};
01005     Disable();
01006     progressBar->SetValue(0);
01007     progressPooler->Start(200);
01008     Connect(ID_PROGRAMING_STATUS_EVENT, wxEVT\_COMMAND\_THREAD, (wxObjectEventFunction)&
      lms7002_pnlMCU_BD_view::OnProgramingStatusUpdate);
01009     Connect(ID_PROGRAMING_FINISH_EVENT, wxEVT\_THREAD, wxThreadEventHandler(
      lms7002_pnlMCU_BD_view::OnEraseIRAMfinished), NULL, \textcolor{keyword}{this});
01010 
01011     mThreadWorking = \textcolor{keyword}{true};
01012     mWorkerThread = std::thread([](lms7002_pnlMCU_BD_view* pthis)
01013     \{
01014         \textcolor{keywordtype}{int} retval = pthis->Erase_IRAM();
01015         wxThreadEvent *evt = \textcolor{keyword}{new} wxThreadEvent();
01016         evt->SetInt(retval);
01017         evt->SetId(ID_PROGRAMING_FINISH_EVENT);
01018         wxQueueEvent(pthis, evt);
01019     \}, \textcolor{keyword}{this});
01020 \}
01021 
01022 \textcolor{keywordtype}{int} lms7002_pnlMCU_BD_view::Change_MCUFrequency(\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} data) \{
01023 
01024     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char} tempc1, tempc2, tempc3=0x00;
01025     \textcolor{keywordtype}{int} retval=0;
01026     \textcolor{comment}{// code 0x7E is for writing the SFR registers}
01027     retval=Three_byte_command(0x7E, 0x8E, data, &tempc1, &tempc2, &tempc3);
01028     \textcolor{comment}{// PMSR register, address 0x8E}
01029     \textcolor{keywordflow}{return} retval;
01030 \}
01031 
01032 \textcolor{keywordtype}{void} lms7002_pnlMCU_BD_view::OnSelDivSelect( wxCommandEvent& event )
01033 \{
01034     \textcolor{keywordtype}{int} retval = 0;
01035     \textcolor{keywordtype}{int} tempi = 0;
01036 
01037     tempi = SelDiv->GetSelection();
01038     retval = Change_MCUFrequency(tempi);
01039     \textcolor{keywordflow}{if} (retval == -1)
01040         wxMessageBox(\_(\textcolor{stringliteral}{"Cannot set the MCU's frequency"}));
01041     \textcolor{keywordflow}{else}
01042         wxMessageBox(wxString::Format(\_(\textcolor{stringliteral}{"Current selection: %s"}), SelDiv->GetString(tempi)));
01043 \}
01044 
01045 \textcolor{keywordtype}{void} lms7002_pnlMCU_BD_view::Onm_cCtrlBasebandSelect( wxCommandEvent& event )
01046 \{
01047     LMS_WriteLMSReg(lmsControl,0x0006, 0x0000);
01048 \}
01049 
01050 \textcolor{keywordtype}{void} lms7002_pnlMCU_BD_view::Onm_cCtrlMCU_BDSelect( wxCommandEvent& event )
01051 \{
01052     LMS_WriteLMSReg(lmsControl,0x0006, 0x0001);; \textcolor{comment}{//REG6 write}
01053 \}
01054 
01055 \textcolor{keywordtype}{void} lms7002_pnlMCU_BD_view::OnRegWriteRead( wxCommandEvent& event )
01056 \{
01057     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} addr = cmbRegAddr->GetSelection();
01058     \textcolor{keywordtype}{long} data;
01059     txtRegValueWr->GetValue().ToLong(&data);
01060     \textcolor{keywordflow}{if} (data < 0 || data > 255)
01061         data = 0;
01062 
01063     \textcolor{keywordflow}{if} (rbtnRegWrite->GetValue() == 1)
01064         LMS_WriteLMSReg(lmsControl,0x8000 + addr, data); \textcolor{comment}{//REG write}
01065     \textcolor{keywordflow}{else}
01066     \{
01067         \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{short} retval = 0;
01068         LMS_ReadLMSReg(lmsControl,addr, &retval); \textcolor{comment}{//REG read}
01069         ReadResult->SetLabel(wxString::Format(\textcolor{stringliteral}{"Result is: 0x%02X"}, retval));
01070     \}
01071 \}
01072 
01073 \textcolor{keywordtype}{void} lms7002_pnlMCU_BD_view::Initialize(lms_device_t* pControl)
01074 \{
01075     lmsControl = pControl;
01076     assert(lmsControl != \textcolor{keyword}{nullptr});
01077 \}
01078 
01079 lms7002_pnlMCU_BD_view* lms7002_pnlMCU_BD_view::obj_ptr=\textcolor{keyword}{nullptr};
01080 \textcolor{keywordtype}{bool} lms7002_pnlMCU_BD_view::OnProgrammingCallback(\textcolor{keywordtype}{int} bsent, \textcolor{keywordtype}{int} btotal, \textcolor{keyword}{const} \textcolor{keywordtype}{char}* progressMsg)
01081 \{
01082     wxCommandEvent evt;
01083     evt.SetEventObject(obj_ptr);
01084     evt.SetInt(100.0 * bsent / btotal); \textcolor{comment}{//round to int}
01085     evt.SetString(wxString::From8BitData(progressMsg));
01086     evt.SetEventType(wxEVT\_COMMAND\_THREAD);
01087     evt.SetId(ID_PROGRAMING_STATUS_EVENT);
01088     wxPostEvent(obj_ptr, evt);
01089     \textcolor{keywordflow}{return} \textcolor{keyword}{false};
01090 \}
01091 \textcolor{keywordtype}{void} lms7002_pnlMCU_BD_view::OnProgramingStatusUpdate(wxCommandEvent& event)
01092 \{
01093     progressBar->SetValue(event.GetInt());
01094 \}
01095 
01096 \textcolor{keywordtype}{void} lms7002_pnlMCU_BD_view::OnReadIRAMfinished(wxThreadEvent &event)
01097 \{
01098     \textcolor{keywordflow}{if} (mThreadWorking)
01099         mWorkerThread.join();
01100     mThreadWorking = \textcolor{keyword}{false};
01101     progressPooler->Stop();
01102     Disconnect(ID_PROGRAMING_STATUS_EVENT, wxEVT\_THREAD, (wxObjectEventFunction)&
      lms7002_pnlMCU_BD_view::OnProgramingStatusUpdate);
01103     Disconnect(ID_PROGRAMING_FINISH_EVENT, wxEVT\_THREAD, wxThreadEventHandler(
      lms7002_pnlMCU_BD_view::OnReadIRAMfinished), NULL, \textcolor{keyword}{this});
01104     progressBar->SetValue(100);
01105     Enable();
01106     \textcolor{keywordflow}{if} (event.GetInt() == -1)
01107     \{
01108         wxMessageBox(\_(\textcolor{stringliteral}{"Unable to read IRAM"}));
01109         \textcolor{keywordflow}{return};
01110     \}
01111     dlgViewIRAM dlg(\textcolor{keyword}{this});
01112     dlg.InitGridData(m_IRAM);
01113     dlg.ShowModal();
01114 \}
01115 
01116 \textcolor{keywordtype}{void} lms7002_pnlMCU_BD_view::OnEraseIRAMfinished(wxThreadEvent &event)
01117 \{
01118     \textcolor{keywordflow}{if}(mThreadWorking)
01119         mWorkerThread.join();
01120     mThreadWorking = \textcolor{keyword}{false};
01121     progressPooler->Stop();
01122     Disconnect(ID_PROGRAMING_STATUS_EVENT, wxEVT\_THREAD, (wxObjectEventFunction)&
      lms7002_pnlMCU_BD_view::OnProgramingStatusUpdate);
01123     Disconnect(ID_PROGRAMING_FINISH_EVENT, wxEVT\_THREAD, wxThreadEventHandler(
      lms7002_pnlMCU_BD_view::OnEraseIRAMfinished), NULL, \textcolor{keyword}{this});
01124     progressBar->SetValue(100);
01125     Enable();
01126     \textcolor{keywordflow}{if} (event.GetInt() == -1)
01127         wxMessageBox(\_(\textcolor{stringliteral}{"Unable to erase IRAM"}));
01128 \}
01129 
01130 \textcolor{keywordtype}{void} lms7002_pnlMCU_BD_view::OnReadSFRfinished(wxThreadEvent &event)
01131 \{
01132     \textcolor{keywordflow}{if} (mThreadWorking)
01133         mWorkerThread.join();
01134     mThreadWorking = \textcolor{keyword}{false};
01135     progressPooler->Stop();
01136     Disconnect(ID_PROGRAMING_STATUS_EVENT, wxEVT\_THREAD, (wxObjectEventFunction)&
      lms7002_pnlMCU_BD_view::OnProgramingStatusUpdate);
01137     Disconnect(ID_PROGRAMING_FINISH_EVENT, wxEVT\_THREAD, wxThreadEventHandler(
      lms7002_pnlMCU_BD_view::OnReadSFRfinished), NULL, \textcolor{keyword}{this});
01138     progressBar->SetValue(100);
01139     Enable();
01140     \textcolor{keywordflow}{if} (event.GetInt() == -1)
01141     \{
01142         wxMessageBox(\_(\textcolor{stringliteral}{"Unable to read SFR"}));
01143         \textcolor{keywordflow}{return};
01144     \}
01145     dlgViewSFR dlg(\textcolor{keyword}{this});
01146     dlg.InitGridData(m_SFR);
01147     dlg.ShowModal();
01148 \}
01149 
01150 \textcolor{keywordtype}{void} lms7002_pnlMCU_BD_view::OnProgrammingfinished(wxThreadEvent &event)
01151 \{
01152     \textcolor{keywordflow}{if} (mThreadWorking)
01153         mWorkerThread.join();
01154     mThreadWorking = \textcolor{keyword}{false};
01155     progressPooler->Stop();
01156     Disconnect(ID_PROGRAMING_STATUS_EVENT, wxEVT\_THREAD, (wxObjectEventFunction)&
      lms7002_pnlMCU_BD_view::OnProgramingStatusUpdate);
01157     Disconnect(ID_PROGRAMING_FINISH_EVENT, wxEVT\_THREAD, wxThreadEventHandler(
      lms7002_pnlMCU_BD_view::OnProgrammingfinished), NULL, \textcolor{keyword}{this});
01158     progressBar->SetValue(100);
01159     Enable();
01160     \textcolor{keywordflow}{if} (event.GetInt() == -1)
01161     \{
01162         wxMessageBox(\_(\textcolor{stringliteral}{"Unable to program the MCU"}));
01163         \textcolor{keywordflow}{return};
01164     \}
01165     \textcolor{keywordflow}{else}
01166     \{
01167         rgrMode->Enable();
01168         btnStartProgramming->Enable();
01169     \}
01170 \}
01171 
01172 \textcolor{keywordtype}{void} lms7002_pnlMCU_BD_view::OnbtnRunProductionTestClicked(wxCommandEvent& event)
01173 \{
01174     \textcolor{comment}{//TODO MCU testing}
01175     wxMessageBox(\_(\textcolor{stringliteral}{"Not implemented in API"}));
01176     \textcolor{comment}{/*int status = mcuControl->RunProductionTest\_MCU();}
01177 \textcolor{comment}{    lblProgCodeFile->SetLabel("Program code file: " + mLoadedProgramFilename);}
01178 \textcolor{comment}{    if (status == 0)}
01179 \textcolor{comment}{        wxMessageBox(\_("Test passed"));}
01180 \textcolor{comment}{    else}
01181 \textcolor{comment}{        wxMessageBox(\_("Test FAILED"));*/}
01182 \}
\end{DoxyCode}

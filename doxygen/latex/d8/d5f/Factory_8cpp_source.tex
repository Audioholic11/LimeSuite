\subsection{Factory.\+cpp}
\label{Factory_8cpp_source}\index{/home/erik/prefix/default/src/soapysdr/lib/\+Factory.\+cpp@{/home/erik/prefix/default/src/soapysdr/lib/\+Factory.\+cpp}}

\begin{DoxyCode}
00001 \textcolor{comment}{// Copyright (c) 2014-2017 Josh Blum}
00002 \textcolor{comment}{// SPDX-License-Identifier: BSL-1.0}
00003 
00004 \textcolor{preprocessor}{#include <SoapySDR/Device.hpp>}
00005 \textcolor{preprocessor}{#include <SoapySDR/Registry.hpp>}
00006 \textcolor{preprocessor}{#include <SoapySDR/Modules.hpp>}
00007 \textcolor{preprocessor}{#include <stdexcept>}
00008 \textcolor{preprocessor}{#include <iostream>}
00009 \textcolor{preprocessor}{#include <mutex>}
00010 
00011 \textcolor{keyword}{static} std::recursive\_mutex &getFactoryMutex(\textcolor{keywordtype}{void})
00012 \{
00013     \textcolor{keyword}{static} std::recursive\_mutex mutex;
00014     \textcolor{keywordflow}{return} mutex;
00015 \}
00016 
00017 \textcolor{keyword}{typedef} std::map<SoapySDR::Kwargs, SoapySDR::Device *> DeviceTable;
00018 
00019 \textcolor{keyword}{static} DeviceTable &getDeviceTable(\textcolor{keywordtype}{void})
00020 \{
00021     \textcolor{keyword}{static} DeviceTable table;
00022     \textcolor{keywordflow}{return} table;
00023 \}
00024 
00025 \textcolor{keyword}{typedef} std::map<SoapySDR::Device *, size\_t> DeviceCounts;
00026 
00027 \textcolor{keyword}{static} DeviceCounts &getDeviceCounts(\textcolor{keywordtype}{void})
00028 \{
00029     \textcolor{keyword}{static} DeviceCounts table;
00030     \textcolor{keywordflow}{return} table;
00031 \}
00032 
00033 SoapySDR::KwargsList SoapySDR::Device::enumerate(\textcolor{keyword}{const} Kwargs &args)
00034 \{
00035     std::lock\_guard<std::recursive\_mutex> lock(getFactoryMutex());
00036 
00037     loadModules();
00038     SoapySDR::KwargsList results;
00039     \textcolor{keywordflow}{for} (\textcolor{keyword}{const} \textcolor{keyword}{auto} &it : Registry::listFindFunctions())
00040     \{
00041         \textcolor{keywordflow}{if} (args.count(\textcolor{stringliteral}{"driver"}) != 0 and args.at(\textcolor{stringliteral}{"driver"}) != it.first) \textcolor{keywordflow}{continue};
00042         \textcolor{keywordflow}{try}
00043         \{
00044             SoapySDR::KwargsList results0 = it.second(args);
00045             \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} i = 0; i < results0.size(); i++)
00046             \{
00047                 results0[i][\textcolor{stringliteral}{"driver"}] = it.first;
00048                 results.push\_back(results0[i]);
00049             \}
00050         \}
00051         \textcolor{keywordflow}{catch} (\textcolor{keyword}{const} std::exception &ex)
00052         \{
00053             std::cerr << \textcolor{stringliteral}{"SoapySDR::Device::enumerate("} << it.first << \textcolor{stringliteral}{") "} << ex.what() << std::endl;
00054         \}
00055         \textcolor{keywordflow}{catch} (...)
00056         \{
00057             std::cerr << \textcolor{stringliteral}{"SoapySDR::Device::enumerate("} << it.first << \textcolor{stringliteral}{") "} << \textcolor{stringliteral}{"unknown error"} << std::endl
      ;
00058         \}
00059     \}
00060     \textcolor{keywordflow}{return} results;
00061 \}
00062 
00063 SoapySDR::KwargsList SoapySDR::Device::enumerate(\textcolor{keyword}{const} std::string &args)
00064 \{
00065     \textcolor{keywordflow}{return} enumerate(KwargsFromString(args));
00066 \}
00067 
00068 \textcolor{keyword}{static} SoapySDR::Device* getDeviceFromTable(\textcolor{keyword}{const} SoapySDR::Kwargs &args)
00069 \{
00070     \textcolor{keywordflow}{if} (args.empty()) \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00071     std::lock\_guard<std::recursive\_mutex> lock(getFactoryMutex());
00072     \textcolor{keywordflow}{if} (getDeviceTable().count(args) != 0 and getDeviceCounts().count(
      getDeviceTable().at(args)) != 0)
00073     \{
00074         \textcolor{keyword}{auto} device = getDeviceTable().at(args);
00075         getDeviceCounts()[device]++;
00076         \textcolor{keywordflow}{return} device;
00077     \}
00078     \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};
00079 \}
00080 
00081 SoapySDR::Device* SoapySDR::Device::make(\textcolor{keyword}{const} Kwargs &inputArgs)
00082 \{
00083     Device *device = \textcolor{keyword}{nullptr};
00084 
00085     \textcolor{comment}{//the arguments may have already come from enumerate and been used to open a device}
00086     device = getDeviceFromTable(inputArgs);
00087     \textcolor{keywordflow}{if} (device != \textcolor{keyword}{nullptr}) \textcolor{keywordflow}{return} device;
00088 
00089     \textcolor{comment}{//otherwise the args must always come from an enumeration result}
00090     Kwargs discoveredArgs;
00091     \textcolor{keyword}{const} \textcolor{keyword}{auto} results = Device::enumerate(inputArgs);
00092     \textcolor{keywordflow}{if} (not results.empty()) discoveredArgs = results.front();
00093 
00094     \textcolor{comment}{//check the device table for an already allocated device}
00095     device = getDeviceFromTable(discoveredArgs);
00096     \textcolor{keywordflow}{if} (device != \textcolor{keyword}{nullptr}) \textcolor{keywordflow}{return} device;
00097 
00098     \textcolor{comment}{//load the enumeration args with missing keys from the make argument}
00099     Kwargs hybridArgs = discoveredArgs;
00100     \textcolor{keywordflow}{for} (\textcolor{keyword}{const} \textcolor{keyword}{auto} &it : inputArgs)
00101     \{
00102         \textcolor{keywordflow}{if} (hybridArgs.count(it.first) == 0) hybridArgs[it.first] = it.second;
00103     \}
00104 
00105     \textcolor{comment}{//lock during device construction}
00106     \textcolor{comment}{//make itself can be parallelized, but we need to keep track of in-process factories}
00107     \textcolor{comment}{//so that other calling threads with the same args can wait on the result}
00108     std::lock\_guard<std::recursive\_mutex> lock(getFactoryMutex());
00109 
00110     \textcolor{comment}{//loop through make functions and call on module match}
00111     \textcolor{keywordflow}{for} (\textcolor{keyword}{const} \textcolor{keyword}{auto} &it : Registry::listMakeFunctions())
00112     \{
00113         \textcolor{keywordflow}{if} (hybridArgs.count(\textcolor{stringliteral}{"driver"}) != 0 and hybridArgs.at(\textcolor{stringliteral}{"driver"}) != it.first) \textcolor{keywordflow}{continue};
00114         device = it.second(hybridArgs);
00115         \textcolor{keywordflow}{break};
00116     \}
00117     \textcolor{keywordflow}{if} (device == \textcolor{keyword}{nullptr}) \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"SoapySDR::Device::make() no match"});
00118 
00119     \textcolor{comment}{//store into the table}
00120     getDeviceTable()[discoveredArgs] = device;
00121     getDeviceCounts()[device]++;
00122 
00123     \textcolor{keywordflow}{return} device;
00124 \}
00125 
00126 SoapySDR::Device *SoapySDR::Device::make(\textcolor{keyword}{const} std::string &args)
00127 \{
00128     \textcolor{keywordflow}{return} make(KwargsFromString(args));
00129 \}
00130 
00131 \textcolor{keywordtype}{void} SoapySDR::Device::unmake(Device *device)
00132 \{
00133     std::lock\_guard<std::recursive\_mutex> lock(getFactoryMutex());
00134 
00135     \textcolor{keywordflow}{if} (getDeviceCounts().count(device) == 0)
00136     \{
00137         \textcolor{keywordflow}{throw} std::runtime\_error(\textcolor{stringliteral}{"SoapySDR::Device::unmake() unknown device"});
00138     \}
00139 
00140     getDeviceCounts()[device]--;
00141     \textcolor{keywordflow}{if} (getDeviceCounts()[device] == 0)
00142     \{
00143         getDeviceCounts().erase(device);
00144         \textcolor{keyword}{delete} device;
00145 
00146         \textcolor{comment}{//cleanup the argument to device table}
00147         \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} it = getDeviceTable().begin(); it != getDeviceTable().end(); ++it)
00148         \{
00149             \textcolor{keywordflow}{if} (it->second == device)
00150             \{
00151                 getDeviceTable().erase(it);
00152                 \textcolor{keywordflow}{return};
00153             \}
00154         \}
00155     \}
00156 \}
\end{DoxyCode}

\subsection{Streamer.\+h}
\label{Streamer_8h_source}\index{/home/erik/prefix/default/src/limesuite-\/dev/src/protocols/\+Streamer.\+h@{/home/erik/prefix/default/src/limesuite-\/dev/src/protocols/\+Streamer.\+h}}

\begin{DoxyCode}
00001 \textcolor{comment}{/*}
00002 \textcolor{comment}{ * To change this license header, choose License Headers in Project Properties.}
00003 \textcolor{comment}{ * To change this template file, choose Tools | Templates}
00004 \textcolor{comment}{ * and open the template in the editor.}
00005 \textcolor{comment}{ */}
00006 
00007 \textcolor{comment}{/* }
00008 \textcolor{comment}{ * File:   Streamer.h}
00009 \textcolor{comment}{ * Author: ignas}
00010 \textcolor{comment}{ *}
00011 \textcolor{comment}{ * Created on November 20, 2017, 12:29 PM}
00012 \textcolor{comment}{ */}
00013 
00014 \textcolor{preprocessor}{#ifndef STREAMER\_H}
00015 \textcolor{preprocessor}{#define STREAMER\_H}
00016 
00017 \textcolor{preprocessor}{#include "dataTypes.h"}
00018 \textcolor{preprocessor}{#include "fifo.h"}
00019 \textcolor{preprocessor}{#include <vector>}
00020 
00021 \textcolor{keyword}{namespace }lime
00022 \{
00023    
00024 \textcolor{keyword}{class }IConnection;
00025 \textcolor{keyword}{class }FPGA;
00026 \textcolor{keyword}{class }Streamer;
00027 \textcolor{keyword}{class }LMS7002M;
00028 
00032 \textcolor{keyword}{struct }LIME_API StreamConfig
00033 \{
00034     StreamConfig(\textcolor{keywordtype}{void})\{\};
00035 
00037     \textcolor{keywordtype}{bool} isTx;
00038 
00039     uint8\_t channelID;
00040 
00041     \textcolor{keywordtype}{float} performanceLatency;
00042 
00044     \textcolor{keyword}{enum} StreamDataFormat
00045     \{
00046         FMT_INT16,
00047         FMT_INT12,
00048         FMT_FLOAT32,
00049     \};
00050 
00056     \textcolor{keywordtype}{size\_t} bufferLength;
00057 
00059     StreamDataFormat format;
00060 
00068     StreamDataFormat linkFormat;
00069 \};
00070 
00071 \textcolor{keyword}{class }LIME_API StreamChannel 
00072 \{
00073 \textcolor{keyword}{public}:
00074     \textcolor{keyword}{struct }Frame
00075     \{
00076         uint64\_t timestamp;
00077         \textcolor{keyword}{static} \textcolor{keyword}{const} uint16\_t samplesCount = samples12InPkt;
00078         complex16_t samples[samplesCount];
00079     \};
00080     
00081     \textcolor{keyword}{struct }Metadata
00082     \{
00083         uint64\_t timestamp;
00084         uint32\_t flags;
00085     \};
00086     
00087     \textcolor{keyword}{struct }Info
00088     \{
00089         \textcolor{keywordtype}{int} fifoSize;
00090         \textcolor{keywordtype}{int} fifoItemsCount;
00091         \textcolor{keywordtype}{int} overrun;
00092         \textcolor{keywordtype}{int} underrun;
00093         \textcolor{keywordtype}{bool} active;
00094         \textcolor{keywordtype}{float} linkRate;
00095         \textcolor{keywordtype}{int} droppedPackets;
00096         uint64\_t timestamp;
00097     \};
00098     
00099     StreamChannel(Streamer* streamer);
00100     ~StreamChannel();
00101     
00102     
00103     \textcolor{keywordtype}{void} Setup(StreamConfig conf);
00104     \textcolor{keywordtype}{void} Close();
00105     \textcolor{keywordtype}{int} Read(\textcolor{keywordtype}{void}* samples, \textcolor{keyword}{const} uint32\_t count, Metadata* meta, \textcolor{keyword}{const} int32\_t 
      timeout_ms = 100);
00106     \textcolor{keywordtype}{int} Write(\textcolor{keyword}{const} \textcolor{keywordtype}{void}* samples, \textcolor{keyword}{const} uint32\_t count, \textcolor{keyword}{const} Metadata* meta, \textcolor{keyword}{const} int32\_t 
      timeout_ms = 100);
00107     StreamChannel::Info GetInfo();
00108     \textcolor{keywordtype}{int} GetStreamSize();
00109 
00110     \textcolor{keywordtype}{bool} IsActive() \textcolor{keyword}{const};
00111     \textcolor{keywordtype}{int} Start();
00112     \textcolor{keywordtype}{int} Stop();
00113     StreamConfig config;
00114     Streamer* mStreamer;
00115     \textcolor{keywordtype}{unsigned} overflow;
00116     \textcolor{keywordtype}{unsigned} underflow;
00117     \textcolor{keywordtype}{unsigned} pktLost;
00118     \textcolor{keywordtype}{bool} mActive;
00119     \textcolor{keywordtype}{bool} used;
00120        
00121 \textcolor{keyword}{protected}:
00122     RingFIFO* fifo;  
00123 \};
00124     
00125 \textcolor{keyword}{class }Streamer
00126 \{
00127 \textcolor{keyword}{public}:
00128     Streamer(FPGA* f, LMS7002M* chip, \textcolor{keywordtype}{int} \textcolor{keywordtype}{id});
00129     ~Streamer();
00130 
00131     StreamChannel* SetupStream(\textcolor{keyword}{const} StreamConfig& config);
00132     \textcolor{keywordtype}{int} GetStreamSize(\textcolor{keywordtype}{bool} tx);
00133 
00134     uint64\_t GetHardwareTimestamp(\textcolor{keywordtype}{void});
00135     \textcolor{keywordtype}{void} SetHardwareTimestamp(\textcolor{keyword}{const} uint64\_t now);
00136     \textcolor{keywordtype}{int} UpdateThreads(\textcolor{keywordtype}{bool} stopAll = \textcolor{keyword}{false});
00137 
00138     std::atomic<uint32\_t> rxDataRate_Bps;
00139     std::atomic<uint32\_t> txDataRate_Bps;
00140     IConnection* dataPort;
00141     std::thread rxThread;
00142     std::thread txThread;
00143     std::atomic<bool> terminateRx;
00144     std::atomic<bool> terminateTx;
00145 
00146     std::vector<StreamChannel> mRxStreams;
00147     std::vector<StreamChannel> mTxStreams;
00148     std::atomic<uint64\_t> rxLastTimestamp;
00149     std::atomic<uint64\_t> txLastTimestamp;
00150     uint64\_t mTimestampOffset;
00151     \textcolor{keywordtype}{int} streamSize;
00152     \textcolor{keywordtype}{unsigned} txBatchSize;
00153     \textcolor{keywordtype}{unsigned} rxBatchSize;
00154     StreamConfig::StreamDataFormat dataLinkFormat;
00155     \textcolor{keywordtype}{void} ReceivePacketsLoop();
00156     \textcolor{keywordtype}{void} TransmitPacketsLoop();
00157 \textcolor{keyword}{private}:
00158     \textcolor{keywordtype}{void} AlignRxTSP();
00159     \textcolor{keywordtype}{void} AlignRxRF(\textcolor{keywordtype}{bool} restoreValues);
00160     \textcolor{keywordtype}{void} AlignQuadrature(\textcolor{keywordtype}{bool} restoreValues);
00161     \textcolor{keywordtype}{void} RstRxIQGen();
00162     \textcolor{keywordtype}{double} GetPhaseOffset(\textcolor{keywordtype}{int} bin);
00163     FPGA* fpga;
00164     LMS7002M* lms;
00165     \textcolor{keywordtype}{int} chipId;
00166 \};
00167 \}
00168 
00169 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* STREAMER\_H */}\textcolor{preprocessor}{}
00170 
\end{DoxyCode}

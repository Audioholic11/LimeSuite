\subsection{Streamer.\+h}
\label{Streamer_8h_source}\index{/home/erik/prefix/default/src/limesuite-\/dev/src/protocols/\+Streamer.\+h@{/home/erik/prefix/default/src/limesuite-\/dev/src/protocols/\+Streamer.\+h}}

\begin{DoxyCode}
00001 \textcolor{comment}{/*}
00002 \textcolor{comment}{ * To change this license header, choose License Headers in Project Properties.}
00003 \textcolor{comment}{ * To change this template file, choose Tools | Templates}
00004 \textcolor{comment}{ * and open the template in the editor.}
00005 \textcolor{comment}{ */}
00006 
00007 \textcolor{comment}{/*}
00008 \textcolor{comment}{ * File:   Streamer.h}
00009 \textcolor{comment}{ * Author: ignas}
00010 \textcolor{comment}{ *}
00011 \textcolor{comment}{ * Created on November 20, 2017, 12:29 PM}
00012 \textcolor{comment}{ */}
00013 
00014 \textcolor{preprocessor}{#ifndef STREAMER\_H}
00015 \textcolor{preprocessor}{#define STREAMER\_H}
00016 
00017 \textcolor{preprocessor}{#include "dataTypes.h"}
00018 \textcolor{preprocessor}{#include "fifo.h"}
00019 \textcolor{preprocessor}{#include <vector>}
00020 
00021 \textcolor{keyword}{namespace }lime
00022 \{
00023 
00024 \textcolor{keyword}{class }IConnection;
00025 \textcolor{keyword}{class }FPGA;
00026 \textcolor{keyword}{class }Streamer;
00027 \textcolor{keyword}{class }LMS7002M;
00028 
00032 \textcolor{keyword}{struct }LIME_API StreamConfig
00033 \{
00034     StreamConfig(\textcolor{keywordtype}{void})\{\};
00035 
00037     \textcolor{keywordtype}{bool} isTx;
00038 
00039     uint8\_t channelID;
00040 
00041     \textcolor{keywordtype}{float} performanceLatency;
00042 
00044     \textcolor{keyword}{enum} StreamDataFormat
00045     \{
00046         FMT_INT16,
00047         FMT_INT12,
00048         FMT_FLOAT32,
00049     \};
00050 
00056     \textcolor{keywordtype}{size\_t} bufferLength;
00057 
00059     StreamDataFormat format;
00060 
00068     StreamDataFormat linkFormat;
00069 \};
00070 
00071 \textcolor{keyword}{class }LIME_API StreamChannel
00072 \{
00073 \textcolor{keyword}{public}:
00074     \textcolor{keyword}{struct }Frame
00075     \{
00076         uint64\_t timestamp;
00077         \textcolor{keyword}{static} \textcolor{keyword}{const} uint16\_t samplesCount = samples12InPkt;
00078         complex16_t samples[samplesCount];
00079     \};
00080 
00081     \textcolor{keyword}{struct }Metadata
00082     \{
00083         uint64\_t timestamp;
00084         uint32\_t flags;
00085         uint64\_t lastchirp_timestamp;
00086         uint64\_t chirptime;
00087     \};
00088 
00089     \textcolor{keyword}{struct }Info
00090     \{
00091         \textcolor{keywordtype}{int} fifoSize;
00092         \textcolor{keywordtype}{int} fifoItemsCount;
00093         \textcolor{keywordtype}{int} overrun;
00094         \textcolor{keywordtype}{int} underrun;
00095         \textcolor{keywordtype}{bool} active;
00096         \textcolor{keywordtype}{float} linkRate;
00097         \textcolor{keywordtype}{int} droppedPackets;
00098         uint64\_t timestamp;
00099     \};
00100 
00101     StreamChannel(Streamer* streamer);
00102     ~StreamChannel();
00103 
00104 
00105     \textcolor{keywordtype}{void} Setup(StreamConfig conf);
00106     \textcolor{keywordtype}{void} Close();
00107     \textcolor{keywordtype}{int} Read(\textcolor{keywordtype}{void}* samples, \textcolor{keyword}{const} uint32\_t count, Metadata* meta, \textcolor{keyword}{const} int32\_t 
      timeout_ms = 100);
00108     \textcolor{keywordtype}{int} Write(\textcolor{keyword}{const} \textcolor{keywordtype}{void}* samples, \textcolor{keyword}{const} uint32\_t count, \textcolor{keyword}{const} Metadata* meta, \textcolor{keyword}{const} int32\_t 
      timeout_ms = 100);
00109     StreamChannel::Info GetInfo();
00110     \textcolor{keywordtype}{int} GetStreamSize();
00111 
00112     \textcolor{keywordtype}{bool} IsActive() \textcolor{keyword}{const};
00113     \textcolor{keywordtype}{int} Start();
00114     \textcolor{keywordtype}{int} Stop();
00115     StreamConfig config;
00116     Streamer* mStreamer;
00117     \textcolor{keywordtype}{unsigned} overflow;
00118     \textcolor{keywordtype}{unsigned} underflow;
00119     \textcolor{keywordtype}{unsigned} pktLost;
00120     \textcolor{keywordtype}{bool} mActive;
00121     \textcolor{keywordtype}{bool} used;
00122 
00123 \textcolor{keyword}{protected}:
00124     RingFIFO* fifo;
00125 \};
00126 
00127 \textcolor{keyword}{class }Streamer
00128 \{
00129 \textcolor{keyword}{public}:
00130     Streamer(FPGA* f, LMS7002M* chip, \textcolor{keywordtype}{int} \textcolor{keywordtype}{id});
00131     ~Streamer();
00132 
00133     StreamChannel* SetupStream(\textcolor{keyword}{const} StreamConfig& config);
00134     \textcolor{keywordtype}{int} GetStreamSize(\textcolor{keywordtype}{bool} tx);
00135 
00136     uint64\_t GetHardwareTimestamp(\textcolor{keywordtype}{void});
00137     \textcolor{keywordtype}{void} SetHardwareTimestamp(\textcolor{keyword}{const} uint64\_t now);
00138     uint64\_t GetChirpTimePeriod(\textcolor{keywordtype}{void});
00139     uint64\_t GetChirpTimeStamp(\textcolor{keywordtype}{void});
00140     \textcolor{keywordtype}{int} UpdateThreads(\textcolor{keywordtype}{bool} stopAll = \textcolor{keyword}{false});
00141 
00142     std::atomic<uint32\_t> rxDataRate_Bps;
00143     std::atomic<uint32\_t> txDataRate_Bps;
00144     IConnection* dataPort;
00145     std::thread rxThread;
00146     std::thread txThread;
00147     std::atomic<bool> terminateRx;
00148     std::atomic<bool> terminateTx;
00149 
00150     std::vector<StreamChannel> mRxStreams;
00151     std::vector<StreamChannel> mTxStreams;
00152     std::atomic<uint64\_t> rxLastTimestamp;
00153     std::atomic<uint64\_t> txLastTimestamp;
00154     std::atomic<uint64\_t> chirpLastTimeStamp;
00155     std::atomic<uint64\_t> chirpLastTimePeriod;
00156     uint64\_t mTimestampOffset;
00157     \textcolor{keywordtype}{int} streamSize;
00158     \textcolor{keywordtype}{unsigned} txBatchSize;
00159     \textcolor{keywordtype}{unsigned} rxBatchSize;
00160     StreamConfig::StreamDataFormat dataLinkFormat;
00161     \textcolor{keywordtype}{void} ReceivePacketsLoop();
00162     \textcolor{keywordtype}{void} TransmitPacketsLoop();
00163 \textcolor{keyword}{private}:
00164     \textcolor{keywordtype}{void} AlignRxTSP();
00165     \textcolor{keywordtype}{void} AlignRxRF(\textcolor{keywordtype}{bool} restoreValues);
00166     \textcolor{keywordtype}{void} AlignQuadrature(\textcolor{keywordtype}{bool} restoreValues);
00167     \textcolor{keywordtype}{void} RstRxIQGen();
00168     \textcolor{keywordtype}{double} GetPhaseOffset(\textcolor{keywordtype}{int} bin);
00169     FPGA* fpga;
00170     LMS7002M* lms;
00171     \textcolor{keywordtype}{int} chipId;
00172 \};
00173 \}
00174 
00175 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* STREAMER\_H */}\textcolor{preprocessor}{}
\end{DoxyCode}

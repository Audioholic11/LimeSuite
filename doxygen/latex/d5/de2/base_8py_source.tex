\subsection{base.\+py}
\label{base_8py_source}\index{/home/erik/prefix/default/src/gr-\/radar-\/dev/docs/doxygen/doxyxml/base.\+py@{/home/erik/prefix/default/src/gr-\/radar-\/dev/docs/doxygen/doxyxml/base.\+py}}

\begin{DoxyCode}
00001 \textcolor{comment}{#}
00002 \textcolor{comment}{# Copyright 2010 Free Software Foundation, Inc.}
00003 \textcolor{comment}{#}
00004 \textcolor{comment}{# This file is part of GNU Radio}
00005 \textcolor{comment}{#}
00006 \textcolor{comment}{# GNU Radio is free software; you can redistribute it and/or modify}
00007 \textcolor{comment}{# it under the terms of the GNU General Public License as published by}
00008 \textcolor{comment}{# the Free Software Foundation; either version 3, or (at your option)}
00009 \textcolor{comment}{# any later version.}
00010 \textcolor{comment}{#}
00011 \textcolor{comment}{# GNU Radio is distributed in the hope that it will be useful,}
00012 \textcolor{comment}{# but WITHOUT ANY WARRANTY; without even the implied warranty of}
00013 \textcolor{comment}{# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the}
00014 \textcolor{comment}{# GNU General Public License for more details.}
00015 \textcolor{comment}{#}
00016 \textcolor{comment}{# You should have received a copy of the GNU General Public License}
00017 \textcolor{comment}{# along with GNU Radio; see the file COPYING.  If not, write to}
00018 \textcolor{comment}{# the Free Software Foundation, Inc., 51 Franklin Street,}
00019 \textcolor{comment}{# Boston, MA 02110-1301, USA.}
00020 \textcolor{comment}{#}
00021 \textcolor{stringliteral}{"""}
00022 \textcolor{stringliteral}{A base class is created.}
00023 \textcolor{stringliteral}{}
00024 \textcolor{stringliteral}{Classes based upon this are used to make more user-friendly interfaces}
00025 \textcolor{stringliteral}{to the doxygen xml docs than the generated classes provide.}
00026 \textcolor{stringliteral}{"""}
00027 
00028 \textcolor{keyword}{import} os
00029 \textcolor{keyword}{import} pdb
00030 
00031 \textcolor{keyword}{from} xml.parsers.expat \textcolor{keyword}{import} ExpatError
00032 
00033 \textcolor{keyword}{from} generated \textcolor{keyword}{import} compound
00034 
00035 
00036 \textcolor{keyword}{class }Base(object):
00037 
00038     \textcolor{keyword}{class }Duplicate(StandardError):
00039         \textcolor{keywordflow}{pass}
00040 
00041     \textcolor{keyword}{class }NoSuchMember(StandardError):
00042         \textcolor{keywordflow}{pass}
00043 
00044     \textcolor{keyword}{class }ParsingError(StandardError):
00045         \textcolor{keywordflow}{pass}
00046 
00047     \textcolor{keyword}{def }__init__(self, parse\_data, top=None):
00048         self._parsed = \textcolor{keyword}{False}
00049         self._error = \textcolor{keyword}{False}
00050         self._parse_data = parse\_data
00051         self._members = []
00052         self._dict_members = \{\}
00053         self._in_category = \{\}
00054         self._data = \{\}
00055         \textcolor{keywordflow}{if} top \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None}:
00056             self._xml_path = top.\_xml\_path
00057             \textcolor{comment}{# Set up holder of references}
00058         \textcolor{keywordflow}{else}:
00059             top = self
00060             self._refs = \{\}
00061             self._xml_path = parse\_data
00062         self.top = top
00063 
00064     @classmethod
00065     \textcolor{keyword}{def }from_refid(cls, refid, top=None):
00066         \textcolor{stringliteral}{""" Instantiate class from a refid rather than parsing object. """}
00067         \textcolor{comment}{# First check to see if its already been instantiated.}
00068         \textcolor{keywordflow}{if} top \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None} \textcolor{keywordflow}{and} refid \textcolor{keywordflow}{in} top.\_refs:
00069             \textcolor{keywordflow}{return} top.\_refs[refid]
00070         \textcolor{comment}{# Otherwise create a new instance and set refid.}
00071         inst = cls(\textcolor{keywordtype}{None}, top=top)
00072         inst.refid = refid
00073         inst.add\_ref(inst)
00074         \textcolor{keywordflow}{return} inst
00075 
00076     @classmethod
00077     \textcolor{keyword}{def }from_parse_data(cls, parse\_data, top=None):
00078         refid = getattr(parse\_data, \textcolor{stringliteral}{'refid'}, \textcolor{keywordtype}{None})
00079         \textcolor{keywordflow}{if} refid \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None} \textcolor{keywordflow}{and} top \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None} \textcolor{keywordflow}{and} refid \textcolor{keywordflow}{in} top.\_refs:
00080             \textcolor{keywordflow}{return} top.\_refs[refid]
00081         inst = cls(parse\_data, top=top)
00082         \textcolor{keywordflow}{if} refid \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None}:
00083             inst.refid = refid
00084             inst.add\_ref(inst)
00085         \textcolor{keywordflow}{return} inst
00086 
00087     \textcolor{keyword}{def }add_ref(self, obj):
00088         \textcolor{keywordflow}{if} hasattr(obj, \textcolor{stringliteral}{'refid'}):
00089             self.top.\_refs[obj.refid] = obj
00090 
00091     mem\_classes = []
00092 
00093     \textcolor{keyword}{def }get_cls(self, mem):
00094         \textcolor{keywordflow}{for} cls \textcolor{keywordflow}{in} self.mem_classes:
00095             \textcolor{keywordflow}{if} cls.can_parse(mem):
00096                 \textcolor{keywordflow}{return} cls
00097         \textcolor{keywordflow}{raise} StandardError((\textcolor{stringliteral}{"Did not find a class for object '%s'."} \(\backslash\)
00098                                  % (mem.get\_name())))
00099 
00100     \textcolor{keyword}{def }convert_mem(self, mem):
00101         \textcolor{keywordflow}{try}:
00102             cls = self.get_cls(mem)
00103             converted = cls.from_parse_data(mem, self.top)
00104             \textcolor{keywordflow}{if} converted \textcolor{keywordflow}{is} \textcolor{keywordtype}{None}:
00105                 \textcolor{keywordflow}{raise} StandardError(\textcolor{stringliteral}{'No class matched this object.'})
00106             self.add_ref(converted)
00107             \textcolor{keywordflow}{return} converted
00108         \textcolor{keywordflow}{except} StandardError, e:
00109             \textcolor{keywordflow}{print} e
00110 
00111     @classmethod
00112     \textcolor{keyword}{def }includes(cls, inst):
00113         \textcolor{keywordflow}{return} isinstance(inst, cls)
00114 
00115     @classmethod
00116     \textcolor{keyword}{def }can_parse(cls, obj):
00117         \textcolor{keywordflow}{return} \textcolor{keyword}{False}
00118 
00119     \textcolor{keyword}{def }_parse(self):
00120         self._parsed = \textcolor{keyword}{True}
00121 
00122     \textcolor{keyword}{def }_get_dict_members(self, cat=None):
00123         \textcolor{stringliteral}{"""}
00124 \textcolor{stringliteral}{        For given category a dictionary is returned mapping member names to}
00125 \textcolor{stringliteral}{        members of that category.  For names that are duplicated the name is}
00126 \textcolor{stringliteral}{        mapped to None.}
00127 \textcolor{stringliteral}{        """}
00128         self.confirm_no_error()
00129         \textcolor{keywordflow}{if} cat \textcolor{keywordflow}{not} \textcolor{keywordflow}{in} self._dict_members:
00130             new\_dict = \{\}
00131             \textcolor{keywordflow}{for} mem \textcolor{keywordflow}{in} self.in_category(cat):
00132                 \textcolor{keywordflow}{if} mem.name() \textcolor{keywordflow}{not} \textcolor{keywordflow}{in} new\_dict:
00133                     new\_dict[mem.name()] = mem
00134                 \textcolor{keywordflow}{else}:
00135                     new\_dict[mem.name()] = self.Duplicate
00136             self._dict_members[cat] = new\_dict
00137         \textcolor{keywordflow}{return} self._dict_members[cat]
00138 
00139     \textcolor{keyword}{def }in_category(self, cat):
00140         self.confirm_no_error()
00141         \textcolor{keywordflow}{if} cat \textcolor{keywordflow}{is} \textcolor{keywordtype}{None}:
00142             \textcolor{keywordflow}{return} self._members
00143         \textcolor{keywordflow}{if} cat \textcolor{keywordflow}{not} \textcolor{keywordflow}{in} self._in_category:
00144             self._in_category[cat] = [mem \textcolor{keywordflow}{for} mem \textcolor{keywordflow}{in} self._members
00145                                       \textcolor{keywordflow}{if} cat.includes(mem)]
00146         \textcolor{keywordflow}{return} self._in_category[cat]
00147 
00148     \textcolor{keyword}{def }get_member(self, name, cat=None):
00149         self.confirm_no_error()
00150         \textcolor{comment}{# Check if it's in a namespace or class.}
00151         bits = name.split(\textcolor{stringliteral}{'::'})
00152         first = bits[0]
00153         rest = \textcolor{stringliteral}{'::'}.join(bits[1:])
00154         member = self._get_dict_members(cat).get(first, self.NoSuchMember)
00155         \textcolor{comment}{# Raise any errors that are returned.}
00156         \textcolor{keywordflow}{if} member \textcolor{keywordflow}{in} set([self.NoSuchMember, self.Duplicate]):
00157             \textcolor{keywordflow}{raise} member()
00158         \textcolor{keywordflow}{if} rest:
00159             \textcolor{keywordflow}{return} member.get\_member(rest, cat=cat)
00160         \textcolor{keywordflow}{return} member
00161 
00162     \textcolor{keyword}{def }has_member(self, name, cat=None):
00163         \textcolor{keywordflow}{try}:
00164             mem = self.get_member(name, cat=cat)
00165             \textcolor{keywordflow}{return} \textcolor{keyword}{True}
00166         \textcolor{keywordflow}{except} self.NoSuchMember:
00167             \textcolor{keywordflow}{return} \textcolor{keyword}{False}
00168 
00169     \textcolor{keyword}{def }data(self):
00170         self.confirm_no_error()
00171         \textcolor{keywordflow}{return} self._data
00172 
00173     \textcolor{keyword}{def }members(self):
00174         self.confirm_no_error()
00175         \textcolor{keywordflow}{return} self._members
00176 
00177     \textcolor{keyword}{def }process_memberdefs(self):
00178         mdtss = []
00179         \textcolor{keywordflow}{for} sec \textcolor{keywordflow}{in} self.\_retrieved\_data.compounddef.sectiondef:
00180             mdtss += sec.memberdef
00181         \textcolor{comment}{# At the moment we lose all information associated with sections.}
00182         \textcolor{comment}{# Sometimes a memberdef is in several sectiondef.}
00183         \textcolor{comment}{# We make sure we don't get duplicates here.}
00184         uniques = set([])
00185         \textcolor{keywordflow}{for} mem \textcolor{keywordflow}{in} mdtss:
00186             converted = self.convert_mem(mem)
00187             pair = (mem.name, mem.\_\_class\_\_)
00188             \textcolor{keywordflow}{if} pair \textcolor{keywordflow}{not} \textcolor{keywordflow}{in} uniques:
00189                 uniques.add(pair)
00190                 self.\_members.append(converted)
00191 
00192     \textcolor{keyword}{def }retrieve_data(self):
00193         filename = os.path.join(self._xml_path, self.refid + \textcolor{stringliteral}{'.xml'})
00194         \textcolor{keywordflow}{try}:
00195             self._retrieved_data = compound.parse(filename)
00196         \textcolor{keywordflow}{except} ExpatError:
00197             print(\textcolor{stringliteral}{'Error in xml in file %s'} % filename)
00198             self._error = \textcolor{keyword}{True}
00199             self._retrieved_data = \textcolor{keywordtype}{None}
00200 
00201     \textcolor{keyword}{def }check_parsed(self):
00202         \textcolor{keywordflow}{if} \textcolor{keywordflow}{not} self._parsed:
00203             self._parse()
00204 
00205     \textcolor{keyword}{def }confirm_no_error(self):
00206         self.check_parsed()
00207         \textcolor{keywordflow}{if} self._error:
00208             \textcolor{keywordflow}{raise} self.ParsingError()
00209 
00210     \textcolor{keyword}{def }error(self):
00211         self.check_parsed()
00212         \textcolor{keywordflow}{return} self._error
00213 
00214     \textcolor{keyword}{def }name(self):
00215         \textcolor{comment}{# first see if we can do it without processing.}
00216         \textcolor{keywordflow}{if} self._parse_data \textcolor{keywordflow}{is} \textcolor{keywordflow}{not} \textcolor{keywordtype}{None}:
00217             \textcolor{keywordflow}{return} self.\_parse\_data.name
00218         self.check_parsed()
00219         \textcolor{keywordflow}{return} self.\_retrieved\_data.compounddef.name
\end{DoxyCode}

\subsection{signal\+\_\+generator\+\_\+fsk\+\_\+c\+\_\+impl.\+cc}
\label{signal__generator__fsk__c__impl_8cc_source}\index{/home/erik/prefix/default/src/gr-\/radar-\/dev/lib/signal\+\_\+generator\+\_\+fsk\+\_\+c\+\_\+impl.\+cc@{/home/erik/prefix/default/src/gr-\/radar-\/dev/lib/signal\+\_\+generator\+\_\+fsk\+\_\+c\+\_\+impl.\+cc}}

\begin{DoxyCode}
00001 \textcolor{comment}{/* -*- c++ -*- */}
00002 \textcolor{comment}{/* }
00003 \textcolor{comment}{ * Copyright 2014 Communications Engineering Lab, KIT.}
00004 \textcolor{comment}{ * }
00005 \textcolor{comment}{ * This is free software; you can redistribute it and/or modify}
00006 \textcolor{comment}{ * it under the terms of the GNU General Public License as published by}
00007 \textcolor{comment}{ * the Free Software Foundation; either version 3, or (at your option)}
00008 \textcolor{comment}{ * any later version.}
00009 \textcolor{comment}{ * }
00010 \textcolor{comment}{ * This software is distributed in the hope that it will be useful,}
00011 \textcolor{comment}{ * but WITHOUT ANY WARRANTY; without even the implied warranty of}
00012 \textcolor{comment}{ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the}
00013 \textcolor{comment}{ * GNU General Public License for more details.}
00014 \textcolor{comment}{ * }
00015 \textcolor{comment}{ * You should have received a copy of the GNU General Public License}
00016 \textcolor{comment}{ * along with this software; see the file COPYING.  If not, write to}
00017 \textcolor{comment}{ * the Free Software Foundation, Inc., 51 Franklin Street,}
00018 \textcolor{comment}{ * Boston, MA 02110-1301, USA.}
00019 \textcolor{comment}{ */}
00020  
00021 \textcolor{preprocessor}{#ifdef HAVE\_CONFIG\_H}
00022 \textcolor{preprocessor}{#include "config.h"}
00023 \textcolor{preprocessor}{#endif}
00024 
00025 \textcolor{preprocessor}{#include <gnuradio/io\_signature.h>}
00026 \textcolor{preprocessor}{#include "signal_generator_fsk_c_impl.h"}
00027 
00028 \textcolor{keyword}{namespace }gr \{
00029   \textcolor{keyword}{namespace }radar \{
00030 
00031     signal_generator_fsk_c::sptr
00032     signal_generator_fsk_c::make(\textcolor{keywordtype}{int} samp_rate, \textcolor{keywordtype}{int} samp_per_freq, \textcolor{keywordtype}{int} 
      blocks_per_tag, \textcolor{keywordtype}{float} freq\_low, \textcolor{keywordtype}{float} freq\_high, \textcolor{keywordtype}{float} amplitude, \textcolor{keyword}{const} 
      std::string& len\_key)
00033     \{
00034       \textcolor{keywordflow}{return} gnuradio::get\_initial\_sptr
00035         (\textcolor{keyword}{new} signal_generator_fsk_c_impl(samp\_rate, samp\_per\_freq, blocks\_per\_tag, freq\_low, freq\_high, 
      amplitude, len\_key));
00036     \}
00037 
00038     \textcolor{comment}{/*}
00039 \textcolor{comment}{     * The private constructor}
00040 \textcolor{comment}{     */}
00041     signal_generator_fsk_c_impl::signal_generator_fsk_c_impl(\textcolor{keywordtype}{int} samp_rate, \textcolor{keywordtype}{int} 
      samp_per_freq, \textcolor{keywordtype}{int} blocks_per_tag, \textcolor{keywordtype}{float} freq\_low, \textcolor{keywordtype}{float} freq\_high, \textcolor{keywordtype}{float} amplitude, \textcolor{keyword}{const} 
      std::string& len\_key)
00042       : gr::sync\_block(\textcolor{stringliteral}{"signal\_generator\_fsk\_c"},
00043               gr::io\_signature::make(0, 0, 0),
00044               gr::io\_signature::make(1, 1, sizeof(gr\_complex)))
00045     \{
00046         d_samp_rate = samp_rate;
00047         d_samp_per_freq = samp_per_freq; \textcolor{comment}{// samples on one frequency}
00048         d_blocks_per_tag = blocks_per_tag; \textcolor{comment}{// block = 2*samp\_per\_freq}
00049         d_freq_low = freq\_low;
00050         d_freq_high = freq\_high;
00051         d_amplitude = amplitude;
00052         
00053         d_packet_len = d_samp_per_freq*2*d_blocks_per_tag;
00054         d_key = pmt::string\_to\_symbol(len\_key); \textcolor{comment}{// set tag identifier for tagged stream}
00055         d_value = pmt::from\_long(d_packet_len); \textcolor{comment}{// set length of 1 fsk packet as tagged stream}
00056         d_srcid = pmt::string\_to\_symbol(\textcolor{stringliteral}{"sig\_gen\_fsk"}); \textcolor{comment}{// set block identifier}
00057         
00058         d_phase_high = 0;
00059         d_phase_low = 0;
00060         
00061         d_state = 1; \textcolor{comment}{// 0: low\_freq, 1: high\_freq}
00062     \}
00063 
00064     \textcolor{comment}{/*}
00065 \textcolor{comment}{     * Our virtual destructor.}
00066 \textcolor{comment}{     */}
00067     signal_generator_fsk_c_impl::~signal_generator_fsk_c_impl()
00068     \{
00069     \}
00070 
00071     \textcolor{keywordtype}{int}
00072     signal_generator_fsk_c_impl::work(\textcolor{keywordtype}{int} noutput\_items,
00073               gr\_vector\_const\_void\_star &input\_items,
00074               gr\_vector\_void\_star &output\_items)
00075     \{
00076         gr\_complex *out = (gr\_complex *) output\_items[0];
00077         
00078         \textcolor{comment}{// Integrate phase for iq signal}
00079         \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i=0; i<noutput\_items; i++)\{
00080             \textcolor{comment}{// Set tag on every packet\_len-th item}
00081             \textcolor{keywordflow}{if}((nitems\_written(0)+i)%d_packet_len==0) add\_item\_tag(0, nitems\_written(0)+
      i, d_key, d_value, d_srcid);
00082             
00083             \textcolor{comment}{// Swap states every samp\_per\_freq item}
00084             \textcolor{keywordflow}{if}((nitems\_written(0)+i)%d_samp_per_freq==0)\{
00085                 \textcolor{keywordflow}{if}(d_state) d_state = 0;
00086                 \textcolor{keywordflow}{else} d_state = 1;
00087             \}
00088             
00089             \textcolor{comment}{// Write sample}
00090             \textcolor{keywordflow}{if}(d_state) out[i] = d_amplitude*exp(d_phase_high);
00091             \textcolor{keywordflow}{else} out[i] = d_amplitude*exp(d_phase_low); \textcolor{comment}{// start with low\_freq (state=0)}
00092             
00093             d_phase_low = 1j*std::fmod(imag(d_phase_low)+2*M\_PI*d_freq_low/(\textcolor{keywordtype}{float})
      d_samp_rate,2*M\_PI);
00094             d_phase_high = 1j*std::fmod(imag(d_phase_high)+2*M\_PI*d_freq_high/(\textcolor{keywordtype}{float})d\_samp\_rate,2*M\_PI);
00095         \}
00096 
00097         \textcolor{comment}{// Tell runtime system how many output items we produced.}
00098         \textcolor{keywordflow}{return} noutput\_items;
00099     \}
00100 
00101   \} \textcolor{comment}{/* namespace radar */}
00102 \} \textcolor{comment}{/* namespace gr */}
00103 
\end{DoxyCode}

\subsection{qa\+\_\+estimator\+\_\+fmcw.\+py}
\label{qa__estimator__fmcw_8py_source}\index{/home/erik/prefix/default/src/gr-\/radar-\/dev/python/qa\+\_\+estimator\+\_\+fmcw.\+py@{/home/erik/prefix/default/src/gr-\/radar-\/dev/python/qa\+\_\+estimator\+\_\+fmcw.\+py}}

\begin{DoxyCode}
00001 \textcolor{comment}{#!/usr/bin/env python}
00002 \textcolor{comment}{# -*- coding: utf-8 -*-}
00003 \textcolor{comment}{# }
00004 \textcolor{comment}{# Copyright 2014 Communications Engineering Lab, KIT.}
00005 \textcolor{comment}{# }
00006 \textcolor{comment}{# This is free software; you can redistribute it and/or modify}
00007 \textcolor{comment}{# it under the terms of the GNU General Public License as published by}
00008 \textcolor{comment}{# the Free Software Foundation; either version 3, or (at your option)}
00009 \textcolor{comment}{# any later version.}
00010 \textcolor{comment}{# }
00011 \textcolor{comment}{# This software is distributed in the hope that it will be useful,}
00012 \textcolor{comment}{# but WITHOUT ANY WARRANTY; without even the implied warranty of}
00013 \textcolor{comment}{# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the}
00014 \textcolor{comment}{# GNU General Public License for more details.}
00015 \textcolor{comment}{# }
00016 \textcolor{comment}{# You should have received a copy of the GNU General Public License}
00017 \textcolor{comment}{# along with this software; see the file COPYING.  If not, write to}
00018 \textcolor{comment}{# the Free Software Foundation, Inc., 51 Franklin Street,}
00019 \textcolor{comment}{# Boston, MA 02110-1301, USA.}
00020 \textcolor{comment}{# }
00021 
00022 \textcolor{keyword}{from} gnuradio \textcolor{keyword}{import} gr, gr\_unittest
00023 \textcolor{keyword}{from} gnuradio \textcolor{keyword}{import} blocks, filter
00024 \textcolor{keyword}{import} radar\_swig \textcolor{keyword}{as} radar
00025 \textcolor{keyword}{from} time \textcolor{keyword}{import} sleep
00026 \textcolor{keyword}{import} pmt
00027 \textcolor{keyword}{from} matplotlib \textcolor{keyword}{import} pyplot \textcolor{keyword}{as} plt
00028 \textcolor{keyword}{import} numpy \textcolor{keyword}{as} np
00029 
00030 \textcolor{keyword}{class }qa_estimator_fmcw (gr\_unittest.TestCase):
00031 
00032     \textcolor{keyword}{def }setUp (self):
00033         self.tb = gr.top\_block ()
00034 
00035     \textcolor{keyword}{def }tearDown (self):
00036         self.tb = \textcolor{keywordtype}{None}
00037 
00038     \textcolor{keyword}{def }test_001_t (self):
00039         \textcolor{comment}{# set up fg}
00040         samp\_cw = 2**14
00041         samp\_up = 2**14
00042         samp\_down = samp\_up
00043         packet\_len = samp\_cw+samp\_up+samp\_down
00044         min\_output\_buffer = packet\_len*2
00045         test\_len = 2*packet\_len
00046         samp\_rate = 10000000
00047         push\_power = \textcolor{keyword}{False}
00048         
00049         center\_freq = 5.7e9
00050         
00051         Range = 200
00052         velocity = 50
00053         
00054         freq\_cw = 0
00055         freq\_sweep = samp\_rate/2
00056         amplitude = 1
00057 
00058         src = radar.signal\_generator\_fmcw\_c(samp\_rate, samp\_up, samp\_down, samp\_cw, freq\_cw, freq\_sweep, 
      amplitude)
00059         src.set\_min\_output\_buffer(min\_output\_buffer)
00060         
00061         head = blocks.head(8,test\_len)
00062         head.set\_min\_output\_buffer(min\_output\_buffer)
00063         
00064         sim = radar.static\_target\_simulator\_cc((Range,),(velocity,),(1e16,),(0,),(0,),samp\_rate,center\_freq
      ,1,\textcolor{keyword}{False},\textcolor{keyword}{False})
00065         sim.set\_min\_output\_buffer(min\_output\_buffer)
00066         
00067         mult = blocks.multiply\_conjugate\_cc()
00068         mult.set\_min\_output\_buffer(min\_output\_buffer)
00069         
00070         decim\_fac = 2**4
00071         
00072         resamp = filter.rational\_resampler\_ccc(1,decim\_fac)
00073         resamp\_tag = blocks.tagged\_stream\_multiply\_length(8,\textcolor{stringliteral}{'packet\_len'},1.0/float(decim\_fac))
00074         resamp\_tag.set\_min\_output\_buffer(min\_output\_buffer/(decim\_fac))
00075         
00076         packets = (samp\_cw/(decim\_fac), samp\_up/(decim\_fac), samp\_down/(decim\_fac))
00077         split\_cw = radar.split\_cc(0,packets)
00078         split\_up = radar.split\_cc(1,packets)
00079         split\_down = radar.split\_cc(2,packets)
00080         split\_cw.set\_min\_output\_buffer(min\_output\_buffer/(decim\_fac))
00081         split\_up.set\_min\_output\_buffer(min\_output\_buffer/(decim\_fac))
00082         split\_down.set\_min\_output\_buffer(min\_output\_buffer/(decim\_fac))
00083         
00084         fft\_cw = radar.ts\_fft\_cc(samp\_cw/(decim\_fac))
00085         fft\_up = radar.ts\_fft\_cc(samp\_up/(decim\_fac))
00086         fft\_down = radar.ts\_fft\_cc(samp\_down/(decim\_fac))
00087         fft\_cw.set\_min\_output\_buffer(min\_output\_buffer/(decim\_fac))
00088         fft\_up.set\_min\_output\_buffer(min\_output\_buffer/(decim\_fac))
00089         fft\_down.set\_min\_output\_buffer(min\_output\_buffer/(decim\_fac))
00090         
00091         threshold = -300
00092         samp\_protect = 0
00093         cfar\_cw = radar.find\_max\_peak\_c(samp\_rate/(decim\_fac), threshold, samp\_protect, (0,0), \textcolor{keyword}{False})
00094         cfar\_up = radar.find\_max\_peak\_c(samp\_rate/(decim\_fac), threshold, samp\_protect, (0,0), \textcolor{keyword}{False})
00095         cfar\_down = radar.find\_max\_peak\_c(samp\_rate/(decim\_fac), threshold, samp\_protect, (0,0), \textcolor{keyword}{False})
00096         
00097         est = radar.estimator\_fmcw(samp\_rate/(decim\_fac), center\_freq, freq\_sweep, samp\_up/(decim\_fac), 
      samp\_down/(decim\_fac), push\_power)
00098         
00099         res = radar.print\_results()
00100         debug = blocks.message\_debug()
00101         
00102         self.tb.connect(src,head,(mult,0))
00103         self.tb.connect(head,sim,(mult,1))
00104         self.tb.connect(mult,resamp, resamp\_tag)
00105         self.tb.connect(resamp\_tag,split\_cw, fft\_cw, cfar\_cw)
00106         self.tb.connect(resamp\_tag,split\_up, fft\_up, cfar\_up)
00107         self.tb.connect(resamp\_tag,split\_down, fft\_down, cfar\_down)
00108         
00109         self.tb.msg\_connect(cfar\_cw,\textcolor{stringliteral}{'Msg out'},est,\textcolor{stringliteral}{'Msg in CW'})
00110         self.tb.msg\_connect(cfar\_up,\textcolor{stringliteral}{'Msg out'},est,\textcolor{stringliteral}{'Msg in UP'})
00111         self.tb.msg\_connect(cfar\_down,\textcolor{stringliteral}{'Msg out'},est,\textcolor{stringliteral}{'Msg in DOWN'})
00112         self.tb.msg\_connect(est,\textcolor{stringliteral}{'Msg out'},res,\textcolor{stringliteral}{'Msg in'})
00113         self.tb.msg\_connect(est,\textcolor{stringliteral}{'Msg out'},debug,\textcolor{stringliteral}{'store'})
00114         
00115         \textcolor{comment}{# run fg}
00116         self.tb.start()
00117         sleep(0.5)
00118         self.tb.stop()
00119         self.tb.wait()
00120         
00121         \textcolor{comment}{# check data}
00122         msg = debug.get\_message(0)
00123         self.assertGreater( velocity/pmt.f32vector\_ref(pmt.nth(1,(pmt.nth(1,msg))),0), 0.8 ) \textcolor{comment}{# check
       velocity value}
00124         self.assertGreater( Range/pmt.f32vector\_ref(pmt.nth(1,(pmt.nth(2,msg))),0), 0.8 ) \textcolor{comment}{# check range
       value}
00125 
00126 
00127 \textcolor{keywordflow}{if} \_\_name\_\_ == \textcolor{stringliteral}{'\_\_main\_\_'}:
00128     gr\_unittest.run(qa\_estimator\_fmcw)\textcolor{comment}{#, "qa\_estimator\_fmcw.xml")}
\end{DoxyCode}
